Preload("Quest10000.lua")
Preload("Quest10001.lua")
Preload("Quest10002.lua")
Preload("Quest10003.lua")
Preload("Quest10004.lua")
Preload("Quest10005.lua")
Preload("Quest10006.lua")
Preload("Quest10007.lua")
Preload("Quest10008.lua")
Preload("Quest10009.lua")
Preload("Quest10010.lua")
Preload("Quest10011.lua")
Preload("Quest10012.lua")
Preload("Quest10013.lua")
Preload("Quest10014.lua")
Preload("Quest10015.lua")
Preload("Quest10016.lua")
Preload("Quest10017.lua")
Preload("Quest10018.lua")
Preload("Quest10019.lua")
Preload("Quest10020.lua")
Preload("Quest10021.lua")
Preload("Quest10022.lua")
Preload("Quest10023.lua")
Preload("Quest10024.lua")
Preload("Quest10025.lua")
Preload("Quest10026.lua")
Preload("Quest10027.lua")
Preload("Quest10028.lua")
Preload("Quest10029.lua")
Preload("Quest10030.lua")
Preload("Quest10031.lua")
Preload("Quest10032.lua")
Preload("Quest10033.lua")
Preload("Quest10034.lua")
Preload("Quest10035.lua")
Preload("Quest10036.lua")
Preload("Quest10037.lua")
Preload("Quest10038.lua")
Preload("Quest10039.lua")
Preload("Quest10040.lua")
Preload("Quest10041.lua")
Preload("Quest10042.lua")
Preload("Quest10043.lua")
Preload("Quest10044.lua")
Preload("Quest10045.lua")
Preload("Quest10046.lua")
Preload("Quest10047.lua")
Preload("Quest10048.lua")
Preload("Quest10049.lua")
Preload("Quest10050.lua")
Preload("Quest10051.lua")
Preload("Quest10052.lua")
Preload("Quest10053.lua")
Preload("Quest10054.lua")
Preload("Quest10055.lua")
Preload("Quest10056.lua")
Preload("Quest10057.lua")
Preload("Quest10058.lua")
Preload("Quest10059.lua")
Preload("Quest10060.lua")
Preload("Quest10061.lua")
Preload("Quest10062.lua")
Preload("Quest10063.lua")
Preload("Quest10064.lua")
Preload("Quest10065.lua")
Preload("Quest10066.lua")
Preload("Quest10067.lua")
Preload("Quest10068.lua")
Preload("Quest10069.lua")
Preload("Quest10070.lua")
Preload("Quest10071.lua")
Preload("Quest10072.lua")
Preload("Quest10073.lua")
Preload("Quest10074.lua")
Preload("Quest10075.lua")
Preload("Quest10076.lua")
Preload("Quest10077.lua")
Preload("Quest10078.lua")
Preload("Quest10079.lua")
Preload("Quest10080.lua")
Preload("Quest10081.lua")
Preload("Quest10082.lua")
Preload("Quest10083.lua")
Preload("Quest10084.lua")
Preload("Quest10085.lua")
Preload("Quest10086.lua")
Preload("Quest10087.lua")
Preload("Quest10088.lua")
Preload("Quest10089.lua")
Preload("Quest10090.lua")
Preload("Quest10091.lua")
Preload("Quest10092.lua")
Preload("Quest10093.lua")
Preload("Quest10094.lua")
Preload("Quest10095.lua")
Preload("Quest10096.lua")
Preload("Quest10097.lua")
Preload("Quest10098.lua")
Preload("Quest10099.lua")
Preload("Quest10100.lua")
Preload("Quest10101.lua")
Preload("Quest10102.lua")
Preload("Quest10103.lua")
Preload("Quest10104.lua")
Preload("Quest10105.lua")
Preload("Quest10106.lua")
Preload("Quest10107.lua")
Preload("Quest10108.lua")
Preload("Quest10109.lua")
Preload("Quest10110.lua")
Preload("Quest10111.lua")
Preload("Quest10112.lua")
Preload("Quest10113.lua")
Preload("Quest10114.lua")
Preload("Quest10115.lua")
Preload("Quest10116.lua")
Preload("Quest10117.lua")
Preload("Quest10118.lua")
Preload("Quest10119.lua")
Preload("Quest10120.lua")
Preload("Quest10121.lua")
Preload("Quest10122.lua")
Preload("Quest10123.lua")
Preload("Quest10124.lua")
Preload("Quest10125.lua")
Preload("Quest10126.lua")
Preload("Quest10127.lua")
Preload("Quest10128.lua")
Preload("Quest10129.lua")
Preload("Quest10130.lua")
Preload("Quest10131.lua")
Preload("Quest10132.lua")
Preload("Quest10133.lua")
Preload("Quest10134.lua")
Preload("Quest10135.lua")
Preload("Quest10136.lua")
Preload("Quest10137.lua")
Preload("Quest10138.lua")
Preload("Quest10139.lua")
Preload("Quest10140.lua")
Preload("Quest10141.lua")
Preload("Quest10142.lua")
Preload("Quest10143.lua")
Preload("Quest10144.lua")
Preload("Quest10145.lua")
Preload("Quest10146.lua")
Preload("Quest10147.lua")
Preload("Quest10148.lua")
Preload("Quest10149.lua")
Preload("Quest10150.lua")
Preload("Quest10151.lua")
Preload("Quest10152.lua")
Preload("Quest10153.lua")
Preload("Quest10154.lua")
Preload("Quest10155.lua")
Preload("Quest10156.lua")
Preload("Quest10157.lua")
Preload("Quest10158.lua")
Preload("Quest10159.lua")
Preload("Quest10160.lua")
Preload("Quest10161.lua")
Preload("Quest10162.lua")
Preload("Quest10163.lua")
Preload("Quest10164.lua")
Preload("Quest10165.lua")
Preload("Quest10166.lua")
Preload("Quest10167.lua")
Preload("Quest10168.lua")
Preload("Quest10169.lua")
Preload("Quest10170.lua")
Preload("Quest10171.lua")
Preload("Quest10172.lua")
Preload("Quest10173.lua")
Preload("Quest10174.lua")
Preload("Quest10175.lua")
Preload("Quest10176.lua")
Preload("Quest10177.lua")
Preload("Quest10178.lua")
Preload("Quest10179.lua")
Preload("Quest10180.lua")
Preload("Quest10181.lua")
Preload("Quest10182.lua")
Preload("Quest10183.lua")
Preload("Quest10184.lua")
Preload("Quest10185.lua")
Preload("Quest10186.lua")
Preload("Quest10187.lua")
Preload("Quest10188.lua")
Preload("Quest10189.lua")
Preload("Quest10190.lua")
Preload("Quest10191.lua")
Preload("Quest10192.lua")
Preload("Quest10193.lua")
Preload("Quest10194.lua")
Preload("Quest10195.lua")
Preload("Quest10196.lua")
Preload("Quest10197.lua")
Preload("Quest10198.lua")
Preload("Quest10199.lua")
Preload("Quest10200.lua")
Preload("Quest10201.lua")
Preload("Quest10202.lua")
Preload("Quest10203.lua")
Preload("Quest10204.lua")
Preload("Quest10205.lua")
Preload("Quest10206.lua")
Preload("Quest10207.lua")
Preload("Quest10208.lua")
Preload("Quest10209.lua")
Preload("Quest10210.lua")
Preload("Quest10211.lua")
Preload("Quest10212.lua")
Preload("Quest10213.lua")
Preload("Quest10214.lua")
Preload("Quest10215.lua")
Preload("Quest10216.lua")
Preload("Quest10217.lua")
Preload("Quest10218.lua")
Preload("Quest10219.lua")
Preload("Quest10220.lua")
Preload("Quest10221.lua")
Preload("Quest10222.lua")
Preload("Quest10223.lua")
Preload("Quest10224.lua")
Preload("Quest10225.lua")
Preload("Quest10226.lua")
Preload("Quest10227.lua")
Preload("Quest10228.lua")
Preload("Quest10229.lua")
Preload("Quest10230.lua")
Preload("Quest10231.lua")
Preload("Quest10232.lua")
Preload("Quest10233.lua")
Preload("Quest10234.lua")
Preload("Quest10235.lua")
Preload("Quest10236.lua")
Preload("Quest10237.lua")
Preload("Quest10238.lua")
Preload("Quest10239.lua")
Preload("Quest10240.lua")
Preload("Quest10241.lua")
Preload("Quest10242.lua")
Preload("Quest10243.lua")
Preload("Quest10244.lua")
Preload("Quest10245.lua")
Preload("Quest10246.lua")
Preload("Quest10247.lua")
Preload("Quest10248.lua")
Preload("Quest10249.lua")
Preload("Quest10250.lua")
Preload("Quest10251.lua")
Preload("Quest10252.lua")
Preload("Quest10253.lua")
Preload("Quest10254.lua")
Preload("Quest10255.lua")
Preload("Quest10256.lua")
Preload("Quest10257.lua")
Preload("Quest10258.lua")
Preload("Quest10259.lua")
Preload("Quest10260.lua")
Preload("Quest10261.lua")
Preload("Quest10262.lua")
Preload("Quest10263.lua")
Preload("Quest10264.lua")
Preload("Quest10265.lua")
Preload("Quest10266.lua")
Preload("Quest10267.lua")
Preload("Quest10268.lua")
Preload("Quest10269.lua")
Preload("Quest10270.lua")
Preload("Quest10271.lua")
Preload("Quest10272.lua")
Preload("Quest10273.lua")
Preload("Quest10274.lua")
Preload("Quest10275.lua")
Preload("Quest10276.lua")
Preload("Quest10277.lua")
Preload("Quest10278.lua")
Preload("Quest10279.lua")
Preload("Quest10280.lua")
Preload("Quest10281.lua")
Preload("Quest10282.lua")
Preload("Quest10283.lua")
Preload("Quest10284.lua")
Preload("Quest10285.lua")
Preload("Quest10286.lua")
Preload("Quest10287.lua")
Preload("Quest10288.lua")
Preload("Quest10289.lua")
Preload("Quest10290.lua")
Preload("Quest10291.lua")
Preload("Quest10292.lua")
Preload("Quest10293.lua")
Preload("Quest10294.lua")
Preload("Quest10295.lua")
Preload("Quest10296.lua")
Preload("Quest10297.lua")
Preload("Quest10298.lua")
Preload("Quest10299.lua")
Preload("Quest10300.lua")
Preload("Quest10301.lua")
Preload("Quest10302.lua")
Preload("Quest10303.lua")
Preload("Quest10304.lua")
Preload("Quest10305.lua")
Preload("Quest10306.lua")
Preload("Quest10307.lua")
Preload("Quest10308.lua")
Preload("Quest10309.lua")
Preload("Quest10310.lua")
Preload("Quest10311.lua")
Preload("Quest10312.lua")
Preload("Quest10313.lua")
Preload("Quest10314.lua")
Preload("Quest10315.lua")
Preload("Quest10316.lua")
Preload("Quest10317.lua")
Preload("Quest10318.lua")
Preload("Quest10319.lua")
Preload("Quest10320.lua")
Preload("Quest10321.lua")
Preload("Quest10322.lua")
Preload("Quest10323.lua")
Preload("Quest10324.lua")
Preload("Quest10325.lua")
Preload("Quest10326.lua")
Preload("Quest10327.lua")
Preload("Quest10328.lua")
Preload("Quest10329.lua")
Preload("Quest10330.lua")
Preload("Quest10331.lua")
Preload("Quest10332.lua")
Preload("Quest10333.lua")
Preload("Quest10334.lua")
Preload("Quest10335.lua")
Preload("Quest10336.lua")
Preload("Quest10337.lua")
Preload("Quest10338.lua")
Preload("Quest10339.lua")
Preload("Quest10340.lua")
Preload("Quest10341.lua")
Preload("Quest10342.lua")
Preload("Quest10343.lua")
Preload("Quest10344.lua")
Preload("Quest10345.lua")
Preload("Quest10346.lua")
Preload("Quest10347.lua")
Preload("Quest10348.lua")
Preload("Quest10349.lua")
Preload("Quest10350.lua")
Preload("Quest10351.lua")
Preload("Quest10352.lua")
Preload("Quest10353.lua")
Preload("Quest10354.lua")
Preload("Quest10355.lua")
Preload("Quest10356.lua")
Preload("Quest10357.lua")
Preload("Quest10358.lua")
Preload("Quest10359.lua")
Preload("Quest10360.lua")
Preload("Quest10361.lua")
Preload("Quest10362.lua")
Preload("Quest10363.lua")
Preload("Quest10364.lua")
Preload("Quest10365.lua")
Preload("Quest10366.lua")
Preload("Quest10367.lua")
Preload("Quest10368.lua")
Preload("Quest10369.lua")
Preload("Quest10370.lua")
Preload("Quest10371.lua")
Preload("Quest10372.lua")
Preload("Quest10373.lua")
Preload("Quest10374.lua")
Preload("Quest10375.lua")
Preload("Quest10376.lua")
Preload("Quest10377.lua")
Preload("Quest10378.lua")
Preload("Quest10379.lua")
Preload("Quest10380.lua")
Preload("Quest10381.lua")
Preload("Quest10382.lua")
Preload("Quest10383.lua")
Preload("Quest10384.lua")
Preload("Quest10385.lua")
Preload("Quest10386.lua")
Preload("Quest10387.lua")
Preload("Quest10388.lua")
Preload("Quest10389.lua")
Preload("Quest10390.lua")
Preload("Quest10391.lua")
Preload("Quest10392.lua")
Preload("Quest10393.lua")
Preload("Quest10394.lua")
Preload("Quest10395.lua")
Preload("Quest10396.lua")
Preload("Quest10397.lua")
Preload("Quest10398.lua")
Preload("Quest10399.lua")
Preload("Quest10400.lua")
Preload("Quest10401.lua")
Preload("Quest10402.lua")
Preload("Quest10403.lua")
Preload("Quest10404.lua")
Preload("Quest10405.lua")
Preload("Quest10406.lua")
Preload("Quest10407.lua")
Preload("Quest10408.lua")
Preload("Quest10409.lua")
Preload("Quest10410.lua")
Preload("Quest10411.lua")
Preload("Quest10412.lua")
Preload("Quest10413.lua")
Preload("Quest10414.lua")
Preload("Quest10415.lua")
Preload("Quest10416.lua")
Preload("Quest10417.lua")
Preload("Quest10418.lua")
Preload("Quest10419.lua")
Preload("Quest10420.lua")
Preload("Quest10421.lua")
Preload("Quest10422.lua")
Preload("Quest10423.lua")
Preload("Quest10424.lua")
Preload("Quest10425.lua")
Preload("Quest10426.lua")
Preload("Quest10427.lua")
Preload("Quest10428.lua")
Preload("Quest10429.lua")
Preload("Quest10430.lua")
Preload("Quest10431.lua")
Preload("Quest10432.lua")
Preload("Quest10433.lua")
Preload("Quest10434.lua")
Preload("Quest10435.lua")
Preload("Quest10436.lua")
Preload("Quest10437.lua")
Preload("Quest10438.lua")
Preload("Quest10439.lua")
Preload("Quest10440.lua")
Preload("Quest10441.lua")
Preload("Quest10442.lua")
Preload("Quest10443.lua")
Preload("Quest10444.lua")
Preload("Quest10445.lua")
Preload("Quest10446.lua")
Preload("Quest10447.lua")
Preload("Quest10448.lua")
Preload("Quest10449.lua")
Preload("Quest10450.lua")
Preload("Quest10451.lua")
Preload("Quest10452.lua")
Preload("Quest10453.lua")
Preload("Quest10454.lua")
Preload("Quest10455.lua")
Preload("Quest10456.lua")
Preload("Quest10457.lua")
Preload("Quest10458.lua")
Preload("Quest10459.lua")
Preload("Quest10460.lua")
Preload("Quest10461.lua")
Preload("Quest10462.lua")
Preload("Quest10463.lua")
Preload("Quest10464.lua")
Preload("Quest10465.lua")
Preload("Quest10466.lua")
Preload("Quest10467.lua")
Preload("Quest10468.lua")
Preload("Quest10469.lua")
Preload("Quest10470.lua")
Preload("Quest10471.lua")
Preload("Quest10472.lua")
Preload("Quest10473.lua")
Preload("Quest10474.lua")
Preload("Quest10475.lua")
Preload("Quest10476.lua")
Preload("Quest10477.lua")
Preload("Quest10478.lua")
Preload("Quest10479.lua")
Preload("Quest10480.lua")
Preload("Quest10481.lua")
Preload("Quest10482.lua")
Preload("Quest10483.lua")
Preload("Quest10484.lua")
Preload("Quest10485.lua")
Preload("Quest10486.lua")
Preload("Quest10487.lua")
Preload("Quest10488.lua")
Preload("Quest10489.lua")
Preload("Quest10490.lua")
Preload("Quest10491.lua")
Preload("Quest10492.lua")
Preload("Quest10493.lua")
Preload("Quest10494.lua")
Preload("Quest10495.lua")
Preload("Quest10496.lua")
Preload("Quest10497.lua")
Preload("Quest10498.lua")
Preload("Quest10499.lua")
Preload("Quest10500.lua")
Preload("Quest10501.lua")
Preload("Quest10502.lua")
Preload("Quest10503.lua")
Preload("Quest10504.lua")
Preload("Quest10505.lua")
Preload("Quest10506.lua")
Preload("Quest10507.lua")
Preload("Quest10508.lua")
Preload("Quest10509.lua")
Preload("Quest10510.lua")
Preload("Quest10511.lua")
Preload("Quest10512.lua")
Preload("Quest10513.lua")
Preload("Quest10514.lua")
Preload("Quest10515.lua")
Preload("Quest10516.lua")
Preload("Quest10517.lua")
Preload("Quest10518.lua")
Preload("Quest10519.lua")
Preload("Quest10520.lua")
Preload("Quest10521.lua")
Preload("Quest10522.lua")
Preload("Quest10523.lua")
Preload("Quest10524.lua")
Preload("Quest10525.lua")
Preload("Quest10526.lua")
Preload("Quest10527.lua")
Preload("Quest10528.lua")
Preload("Quest10529.lua")
Preload("Quest10530.lua")
Preload("Quest10531.lua")
Preload("Quest10532.lua")
Preload("Quest10533.lua")
Preload("Quest10534.lua")
Preload("Quest10535.lua")
Preload("Quest10536.lua")
Preload("Quest10537.lua")
Preload("Quest10538.lua")
Preload("Quest10539.lua")
Preload("Quest10540.lua")
Preload("Quest10541.lua")
Preload("Quest10542.lua")
Preload("Quest10543.lua")
Preload("Quest10544.lua")
Preload("Quest10545.lua")
Preload("Quest10546.lua")
Preload("Quest10547.lua")
Preload("Quest10548.lua")
Preload("Quest10549.lua")
Preload("Quest10550.lua")
Preload("Quest10551.lua")
Preload("Quest10552.lua")
Preload("Quest10553.lua")
Preload("Quest10554.lua")
Preload("Quest10555.lua")
Preload("Quest10556.lua")
Preload("Quest10557.lua")
Preload("Quest10558.lua")
Preload("Quest10559.lua")
Preload("Quest10560.lua")
Preload("Quest10561.lua")
Preload("Quest10562.lua")
Preload("Quest10563.lua")
Preload("Quest10564.lua")
Preload("Quest10565.lua")
Preload("Quest10566.lua")
Preload("Quest10567.lua")
Preload("Quest10568.lua")
Preload("Quest10569.lua")
Preload("Quest10570.lua")
Preload("Quest10571.lua")
Preload("Quest10572.lua")
Preload("Quest10573.lua")
Preload("Quest10574.lua")
Preload("Quest10575.lua")
Preload("Quest10576.lua")
Preload("Quest10577.lua")
Preload("Quest10578.lua")
Preload("Quest10579.lua")
Preload("Quest10580.lua")
Preload("Quest10581.lua")
Preload("Quest10582.lua")
Preload("Quest10583.lua")
Preload("Quest10584.lua")
Preload("Quest10585.lua")
Preload("Quest10586.lua")
Preload("Quest10587.lua")
Preload("Quest10588.lua")
Preload("Quest10589.lua")
Preload("Quest10590.lua")
Preload("Quest10591.lua")
Preload("Quest10592.lua")
Preload("Quest10593.lua")
Preload("Quest10594.lua")
Preload("Quest10595.lua")
Preload("Quest10596.lua")
Preload("Quest10597.lua")
Preload("Quest10598.lua")
Preload("Quest10599.lua")
Preload("Quest10600.lua")
Preload("Quest10601.lua")
Preload("Quest10602.lua")
Preload("Quest10603.lua")
Preload("Quest10604.lua")
Preload("Quest10605.lua")
Preload("Quest10606.lua")
Preload("Quest10607.lua")
Preload("Quest10608.lua")
Preload("Quest10609.lua")
Preload("Quest10610.lua")
Preload("Quest10611.lua")
Preload("Quest10612.lua")
Preload("Quest10613.lua")
Preload("Quest10614.lua")
Preload("Quest10615.lua")
Preload("Quest10616.lua")
Preload("Quest10617.lua")
Preload("Quest10618.lua")
Preload("Quest10619.lua")
Preload("Quest10620.lua")
Preload("Quest10621.lua")
Preload("Quest10622.lua")
Preload("Quest10623.lua")
Preload("Quest10624.lua")
Preload("Quest10625.lua")
Preload("Quest10626.lua")
Preload("Quest10627.lua")
Preload("Quest10628.lua")
Preload("Quest10629.lua")
Preload("Quest10630.lua")
Preload("Quest10631.lua")
Preload("Quest10632.lua")
Preload("Quest10633.lua")
Preload("Quest10634.lua")
Preload("Quest10635.lua")
Preload("Quest10636.lua")
Preload("Quest10637.lua")
Preload("Quest10638.lua")
Preload("Quest10639.lua")
Preload("Quest10640.lua")
Preload("Quest10641.lua")
Preload("Quest10642.lua")
Preload("Quest10643.lua")
Preload("Quest10644.lua")
Preload("Quest10645.lua")
Preload("Quest10646.lua")
Preload("Quest10647.lua")
Preload("Quest10648.lua")
Preload("Quest10649.lua")
Preload("Quest10650.lua")
Preload("Quest10651.lua")
Preload("Quest10652.lua")
Preload("Quest10653.lua")
Preload("Quest10654.lua")
Preload("Quest10655.lua")
Preload("Quest10656.lua")
Preload("Quest10657.lua")
Preload("Quest10658.lua")
Preload("Quest10659.lua")
Preload("Quest10660.lua")
Preload("Quest10661.lua")
Preload("Quest10662.lua")
Preload("Quest10663.lua")
Preload("Quest10664.lua")
Preload("Quest10665.lua")
Preload("Quest10666.lua")
Preload("Quest10667.lua")
Preload("Quest10668.lua")
Preload("Quest10669.lua")
Preload("Quest10670.lua")
Preload("Quest10671.lua")
Preload("Quest10672.lua")
Preload("Quest10673.lua")
Preload("Quest10674.lua")
Preload("Quest10675.lua")
Preload("Quest10676.lua")
Preload("Quest10677.lua")
Preload("Quest10678.lua")
Preload("Quest10679.lua")
Preload("Quest10680.lua")
Preload("Quest10681.lua")
Preload("Quest10682.lua")
Preload("Quest10683.lua")
Preload("Quest10684.lua")
Preload("Quest10685.lua")
Preload("Quest10686.lua")
Preload("Quest10687.lua")
Preload("Quest10688.lua")
Preload("Quest10689.lua")
Preload("Quest10690.lua")
Preload("Quest10691.lua")
Preload("Quest10692.lua")
Preload("Quest10693.lua")
Preload("Quest10694.lua")
Preload("Quest10695.lua")
Preload("Quest10696.lua")
Preload("Quest10697.lua")
Preload("Quest10698.lua")
Preload("Quest55102.lua")
Preload("Quest63520.lua")
Preload("Quest63521.lua")
Preload("Quest63522.lua")
Preload("Quest63523.lua")
Preload("Quest63524.lua")
Preload("Quest63525.lua")
Preload("Quest63526.lua")
Preload("Quest63527.lua")
Preload("Quest63528.lua")
Preload("Quest63529.lua")
Preload("Quest63530.lua")
Preload("Quest63531.lua")
Preload("Quest63532.lua")
Preload("Quest63533.lua")
Preload("Quest69001.lua")
Preload("Quest69205.lua")
Preload("Quest69206.lua")
Preload("Quest69207.lua")
Preload("Quest69208.lua")
function WarCWGetGuildPvPGroup(map_id)
	local PvPGroup = 0;
	if	map_id == 56500 or map_id == 56501 or map_id == 56502 then
		PvPGroup = 1
	elseif map_id == 56503 or map_id == 56504 or map_id == 56505 then
		PvPGroup = 2
	elseif map_id == 56506 or map_id == 56507 or map_id == 56508 then
		PvPGroup = 3
	elseif map_id == 56509 or map_id == 56510 or map_id == 56511 then
		PvPGroup = 4
	elseif map_id == 56512 or map_id == 56513 or map_id == 56514 then
		PvPGroup = 5	
	elseif map_id == 56515 or map_id == 56516 or map_id == 56517 then
		PvPGroup = 6	
	elseif map_id == 56518 or map_id == 56519 or map_id == 56520 then
		PvPGroup = 7
	elseif map_id == 56521 or map_id == 56522 or map_id == 56523 then
		PvPGroup = 8
	end
		
	LuaI.SetTempResult(PvPGroup);
end

-- Add quest to character
-- quest_t : lua quest table to add
-- character : character to add the quest. if nil, then character is "player"
function AddQuest1(quest_t, character)
	if character == nil then return nil end
	local questSys = character:GetQuests()

	DebugTable(quest_t)
	if questSys:HasQuest(quest_t.quest_id) then
		return nil
	end

	if quest_t.round_info then
		local t = quest_t.round_info
		questSys:SetRoundInfo(quest_t.type_id, t.max_round or 0, 
			t.limit_round or 0, t.limit_type or 0)
	end


		local qtype = questSys:GetType(quest_t.type_id)
		if qtype then
			local limitRound = qtype:GetLimitRound()
			local limitType = qtype:GetLimitType()
			if limitRound > 0 and qtype:GetTotalRound() >= limitRound then
				if limitType == 1 then
					NpcSay(string.format("你今天领取的每日任务已到达领取上限%d次，请明天再领取。", limitRound))
				elseif limitType == 2 then
					NpcSay(string.format("你今天领取的每周任务已到达领取上限%d次，请下星期再领取。", limitRound))
				end
				return nil
			end
			qtype:ChangeRound(1)
			qtype:ChangeTotalRound(1)
		end


	local q = questSys:AddQuest(quest_t.quest_id, quest_t.name, 
			quest_t.type_id, 
			quest_t.type_name or string.format("T %d", quest_t.type_id))
	local v

	if q == nil then return nil end

	if quest_t.descript then 
		if quest_t.tips then
			q:SetDescription(quest_t.descript .. "##" .. quest_t.tips)
		else
			q:SetDescription(quest_t.descript)
		end
	end
	v = quest_t.start_npc
	if type(v) ~= "table" and npc then
		v = { npc_id = npc:GetNpc_id(), map_id = npc:GetMap_id(), 
				x = npc:GetCurPosX(), y = npc:GetCurPosY() }
	end
	if v then
		q:SetStartNPC(v.npc_id, v.map_id, v.x or 0, v.y or 0)
	end
	v = quest_t.end_npc
	if type(v) ~= "table" and npc then
		v = { npc_id = npc:GetNpc_id(), map_id = npc:GetMap_id(), 
				x = npc:GetCurPosX(), y = npc:GetCurPosY() }
	end
	if v then
		q:SetEndNPC(v.npc_id, v.map_id, v.x or 0, v.y or 0)
	end
	if quest_t.target_npc and type(quest_t.target_npc) == "table" then
		if quest_t.target_npc.npc_id then
			v = quest_t.target_npc
			q:SetTargetNPC(1, v.npc_id, v.map_id, v.x or 0, v.y or 0)
		else
			for i,v in ipairs(quest_t.target_npc) do
				q:SetTargetNPC(i, v.npc_id, v.map_id, v.x or 0, v.y or 0)
			end
		end
	end
	if quest_t.target_item and type(quest_t.target_item) == "table" then
		if quest_t.target_item.item_id then
			v = quest_t.target_item
			q:SetTargetItem(1, v.item_id, v.count or 1, v.t1 or 0,
				v.v1 or 0, v.t2 or 0, v.v2 or 0)
		else
			for i,v in ipairs(quest_t.target_item) do
				q:SetTargetItem(i, v.item_id, v.count or 1, v.t1 or 0,
					v.v1 or 0, v.t2 or 0, v.v2 or 0)
			end
		end
	end
	if quest_t.target_mob and type(quest_t.target_mob) == "table" then
		if quest_t.target_mob.mob_id then
			v = quest_t.target_mob
			q:SetTargetMOB(1, v.mob_id, v.count or 1)
		else
			for i,v in ipairs(quest_t.target_mob) do
				q:SetTargetMOB(i, v.mob_id, v.count or 1)
			end
		end
	end
	if quest_t.target_partner and type(quest_t.target_partner) == "table" then
		if quest_t.target_partner.mob_id then
			v = quest_t.target_partner
			q:SetTargetPartner(1, v.mob_id, v.count or 1, v.t1 or 0,
				v.v1 or 0, v.t2 or 0)
		else
			for i,v in ipairs(quest_t.target_partner) do
				q:SetTargetPartner(i, v.mob_id, v.count or 1, v.t1 or 0,
					v.v1 or 0, v.t2 or 0)
			end
		end
	end
	if quest_t.target_pet and type(quest_t.target_pet) == "table" then
		if quest_t.target_pet.pet_id then
			v = quest_t.target_pet
			q:SetTargetPet(1, v.pet_id, 0, v.count or 1, v.t1 or 0,
				v.v1 or 0, v.t2 or 0)
		else
			for i,v in ipairs(quest_t.target_pet) do
				q:SetTargetPet(i, v.pet_id, 0, v.count or 1, v.t1 or 0,
					v.v1 or 0, v.t2 or 0)
			end
		end
	end
	if quest_t.target_map and type(quest_t.target_map) == "table" then
		if quest_t.target_map.map_id then
			v = quest_t.target_map
			q:SetTargetMap(1, v.map_id, v.x or 0, v.y or 0)
		else
			for i,v in ipairs(quest_t.target_map) do
				q:SetTargetMap(i, v.map_id, v.x or 0, v.y or 0)
			end
		end
	end
	if quest_t.target_newbie and type(quest_t.target_newbie) == "table" then
		if quest_t.target_newbie.min_lv then
			v = quest_t.target_newbie
			q:SetTargetNewBie(1, v.min_lv, v.max_lv, v.count or 1)
		else
			for i,v in ipairs(quest_t.target_newbie) do
				q:SetTargetNewBie(i, v.min_lv, v.max_lv, v.count or 1)
			end
		end
	end
	if quest_t.encount_npc and type(quest_t.encount_npc) == "table" then
		if quest_t.encount_npc.npc_id then
			v = quest_t.encount_npc
			q:SetEncountNPC(1, v.npc_id, v.map_id or 0, v.count or -1, 
							v.step or math.random(100,300))
		else
			for i,v in ipairs(quest_t.encount_npc) do
				q:SetEncountNPC(i, v.npc_id, v.map_id, v.count or -1, 
								v.step or math.random(100,300))
			end
		end
	end
	if quest_t.target_follower and type(quest_t.target_follower) == "table" then
		if quest_t.target_follower.mob_id then
			v = quest_t.target_follower
			q:SetTargetFollower(1, v.mob_id, v.count or 1)
		else
			for i,v in ipairs(quest_t.target_follower) do
				q:SetTargetFollower(i, v.mob_id, v.count or 1)
			end
		end
	end
	if quest_t.feature and type(quest_t.feature) == "table" then
		for i,v in ipairs(quest_t.feature) do
			if v == "cancel" then q:SetCancel(true)
			elseif v == "nocancel" then q:SetCancel(false)
			elseif v == "failOverTime" then q:SetFailOverTime(true)
			elseif v == "failEscape" then q:SetFailEscape(true)
			elseif v == "failPlayerDie" then q:SetFailPlayerDie(true)
			elseif v == "failTeamDie" then q:SetFailTeamDie(true)
			elseif v == "failFollowerDie" then q:SetFailFlowerDie(true)
			elseif v == "failNpcDie" then q:SetFailNpcDie(true)
			elseif v == "failJoinParty" then q:SetFailJoinParty(true)
			elseif v == "cancelOverTime" then q:SetCancelOverTime(true)
			end
		end
	end
	if quest_t.time_limit then
		q:SetTimeLimit(quest_t.time_limit)
	end
	if quest_t.time_mark then
		questSys:SetTimeMark(quest_t.time_mark)
	end
	questSys:RaiseUpdate()

	return q
end



function EmptyFunction()

end
function speedOrder(char)
	local speedOrder = char:GetSPD();
	local r = math.random(1, 6);
	
	if speedOrder <= 180 and r == 1 then
		speedOrder = char:GetSPD() * math.random(900, 1100) / 1000;	
	else 
		if r == 1 then 
			speedOrder = char:GetSPD() + math.random(-20, 20);	
		end
	end
	LuaI.SetTempResult(speedOrder);
end
--伤害公式
function CalcDamage(Atk, Def)
	local dam = 0;
	local wDam = 1;		--是CBatActor类型 
	local wDam1 = 1;
	local ZPartnerOwner;			--是CBatActor类型
	local PartnerOwner;			--是CBatActor类型
	local battle = Atk:GetBattle();
	if Atk:IsParnter() then
		local ZpBatMob = Atk:ToBatMob();
		if ZpBatMob ~= nil then
			for jj=0, battle:GetActorCount() - 1 do
				local ZpActor = battle:GetActor(jj);
				if ZpActor:IsPlayer() then
					local ZpBatChar = ZpActor:ToBatChar();
					if ZpBatChar ~= nil and ZpBatChar:GetChar_id() == ZpBatMob:GetOwner_id() then
						ZPartnerOwner = ZpActor;
						wDam1 = 1.02 ^ ZPartnerOwner:GetOwner():GetSkillLv(382);
					end
				end
			end
		end
	else
		wDam1 = 1.02 ^ Atk:GetSkillLv(376);
	end
	if Def:IsParnter() then
		local pBatMob = Def:ToBatMob();
		if pBatMob ~= nil then
			for ii=0, battle:GetActorCount() - 1 do
				local pActor = battle:GetActor(ii);
				if pActor:IsPlayer() then
					local pBatChar = pActor:ToBatChar();
					if pBatChar ~= nil and pBatChar:GetChar_id() == pBatMob:GetOwner_id() then
						PartnerOwner = pActor;
						wDam = wDam1 * 0.98 ^ PartnerOwner:GetOwner():GetSkillLv(383);
					end
				end
			end
		end
	else
		wDam = wDam1 * 0.98 ^ Def:GetSkillLv(377);
	end
	
	if Atk:GetTeam() == Def:GetTeam() then
		if Atk:HasBuff(1113) then
			local num = math.random(1, 100);
			if Atk:GetATK() * 0.8 > Def:GetDEF() and num <= 5 then
				dam = ((Atk:GetATK() - Def:GetDEF() / 2 + 250) * wDam - 250) * math.random(900, 1100) / 1000;
			else
				dam = ((Atk:GetATK() - Def:GetDEF() + 250) * wDam - 250) * math.random(900, 1100) / 1000;
			end
		end			
	else
		local num = math.random(1, 100);
		if Atk:GetATK() * 0.8 > Def:GetDEF() and num <= 5 then
			dam = ((Atk:GetATK() - Def:GetDEF() / 2 + 250) * wDam - 250) * math.random(900, 1100) / 1000;
		else
			dam = ((Atk:GetATK() - Def:GetDEF() + 250) * wDam - 250) * math.random(900, 1100) / 1000;
		end
	end
	
	if Atk:IsMob() == true and Atk:IsBoss() == true then
		if dam <= 0.25 * Atk:GetLevel() then
			dam = math.random(0.25 * Atk:GetLevel(), 0.5*Atk:GetLevel() + 1);
		--elseif dam >= Atk:GetLevel() * 8 then
			--dam = math.random(Atk:GetLevel() * 6 - 5, Atk:GetLevel() * 10);
		end
	elseif Atk:IsMob() == true and Atk:IsParnter() == false then
		if dam <= 0.25 * Atk:GetLevel() then
			dam = math.random(0.25 * Atk:GetLevel(), 0.5 * Atk:GetLevel() + 1);
		--elseif dam >= Atk:GetLevel() * 5 then
			--dam = math.random(Atk:GetLevel() * 4 - 3, Atk:GetLevel() * 6 + 4);
		end
	end
	
	if dam <= 1 then
		dam = math.random(1, 10);
		if Atk:GetTeam() == Def:GetTeam() then
			dam = 1;
		end
	end
	
	LuaI.SetTempResult(dam);
end

function ComboAttack(list, Def)--合击概率
	local dam = 0;
	
	local curr = list;
	local count = 0;
	while curr ~= nil do
		CalcDamage(curr:GetCurrActor(), Def);
		dam = dam + LuaI.GetTempResult();
		curr = curr:GetNext();
		count = count + 1;
	end
	
	dam = dam * (1 + 0.1 *  count)
	LuaI.SetTempResult(dam);
end

function CanEscape(actor)--逃跑几率设定（宠物救主技能）
	local rate1 = 70;
	if actor:IsMob() then
		if actor:IsMob() and not actor:IsParnter() then
			rate1 = 100;
		end
	end
	if math.random(1, 100) <= rate1 then
		LuaI.SetTempResult(1);	
	else
		local pet = actor:GetUsingPet();
		if pet ~= nil then
			if pet:HasSkill(7006) then
			local rate2 = 55;
			if pet:GetSpirit() == 1 then
				rate2 = 65
			elseif pet:GetSpirit() == 2 then
				rate2 = 50
			elseif pet:GetSpirit() == 3 then
				rate2 = 45
			elseif pet:GetSpirit() == 4 then
				rate2 = 40
			elseif pet:GetSpirit() == 5 then
				rate2 = 60
			elseif pet:GetSpirit() == 6 then
				rate2 = 70
			end
				if math.random(1, 100) <= rate2 then
					LuaI.SetTempResult(1);
					actor:PetActive();
				else
					LuaI.SetTempResult(0);
				end	
			end
		else	
			LuaI.SetTempResult(0);
		end
	end
end

function PetProtectActive(actor)-- 宠物护主技能设定
	local pet = actor:GetUsingPet();
	if pet ~= nil then
		if pet:HasSkill(7007) then
		local rate3 = 10;
			if pet:GetSpirit() == 1 then
				rate3 = 5
			elseif pet:GetSpirit() == 2 then
				rate3 = 7
			elseif pet:GetSpirit() == 3 then
				rate3 = 12
			elseif pet:GetSpirit() == 4 then
				rate3 = 4
			elseif pet:GetSpirit() == 5 then
				rate3 = 3
			elseif pet:GetSpirit() == 6 then
				rate3 = 1
			end
			if math.random(1, 100) <= rate3 then
				LuaI.SetTempResult(1);
				actor:PetActive();
			else
				LuaI.SetTempResult(0);
			end
		end
	else
		LuaI.SetTempResult(0);
	end
end

function CanHit(Atk, Def)--战斗命中率设定
	local rate = 0.5 * Atk:GetHIT() / Def:GetEVA()  * 100;
	
	if rate < 35 then
		rate = 35;
	elseif rate > 100 then
		rate = 100;
	end
	
	if Atk:IsMob() == true and Atk:IsBoss() == true then
		rate = 0.5 * Atk:GetHIT() / Def:GetEVA()  * 100 + 10;
		if rate < 70 then
			rate = 70;
		end
	elseif Atk:IsMob() == true and Atk:IsParnter() == false then
		rate = 0.5 * Atk:GetHIT() / Def:GetEVA()  * 100 + 5;
		if rate < 55 then
			rate = 55;
		end	
	end
	
	if Atk:HasBuff(42) then
		rate = 100;
	end
	
	if Atk:IsMob() then
		if Atk:GetMob_id() == 2462 then
			rate = 100;
		end
	end
	
	if math.random(1, 100) <= rate then
		LuaI.SetTempResult(1);	
	else
		LuaI.SetTempResult(0);
	end
	
end

function CanCritical(Atk, Def)--爆击率设定
	local rate = 5;
	if Atk:GetHP() < Atk:GetMaxHP() / 4 then
		rate = 10;
	end
	if math.random(1, 100) <= rate and (not Def:IsBuffExist(2011) and not Def:IsBuffExist(2044)) then
		LuaI.SetTempResult(1);	
	else
		LuaI.SetTempResult(0);
	end
end

function playerExpGain(actor, killCount, npcLevel, npcExp, teamCount, mapLevel)--玩家获取经验设定（角色练功丸）
	local teamCountModify = 1 - (teamCount - 1) * 0.1;
	local lv = actor:GetLevel();
	local lvDiff = math.abs(lv - mapLevel);
	local lvDiffModify = 1;
	if lvDiff <= 4 then
	    lvDiffModify = 1;
	elseif lvDiff <= 6 then
	    lvDiffModify = 0.9; 
	elseif lvDiff <= 8 then
	    lvDiffModify = 0.75;
	elseif lvDiff <= 10 then
	    lvDiffModify = 0.55;
	elseif lvDiff <= 12 then
	    lvDiffModify = 0.3	;
	elseif lvDiff <= 30 then
	    lvDiffModify = 0.3 - lvDiff / 100 ; 
	end		
	--双倍经验
	local DoubleModify2 = 1;
	if actor:HasBuff(218) then
		DoubleModify2 = 2;	
	end	
	if actor:HasBuff(22003) then
		--if actor:GetQuests():TimeMarkOver(30000,1440) ~= true then
			DoubleModify2 = 2;
		--[[else
			actor:GetScript():ShowError("温玉效果已消失了")
			actor:GetQuests():RemoveTimeMark(30000) 
			actor:RemoveBuff(22003)
		end]]
	end	 
	if actor:HasBuff(22006) then
		--if actor:GetQuests():TimeMarkOver(30003,10080) ~= true then
			DoubleModify2 = 2;
		--[[else
			actor:GetScript():ShowError("千年温玉效果已消失了")
			actor:GetQuests():RemoveTimeMark(30003) 
			actor:RemoveBuff(22006) 
		end	]]
	end	
	--三倍经验
	local DoubleModify3 = 1;
	if actor:HasBuff(219) then
		DoubleModify3 = 2;	
	end	
	if actor:HasBuff(22004) then
		--if actor:GetQuests():TimeMarkOver(30001,1440) ~= true then
			DoubleModify2 = 3;
		--[[else
			actor:GetScript():ShowError("血玉效果已消失了")
			actor:GetQuests():RemoveTimeMark(30001) 
			actor:RemoveBuff(22004)
		end	]]	
	end	
	if actor:HasBuff(22007) then
		--if actor:GetQuests():TimeMarkOver(30004,10080) ~= true then
			DoubleModify2 = 3;
		--[[else
			actor:GetScript():ShowError("千年血玉效果已消失了")
			actor:GetQuests():RemoveTimeMark(30004) 
			actor:RemoveBuff(22007)
		end	]]	
	end	
	--鸿福堂2.5倍经验
	local DoubleModifyHFT = 1;
	if actor:HasBuff(301) then
		DoubleModifyHFT = 2.5;	
	end	
	--角色四倍经验
	local DoubleModify4 = 1;
	if actor:HasBuff(303) then
		DoubleModify4 = 4;	
	end	
	--世界双
	local DoubleModifyworld = 1;
	if actor:HasBuff(254) then
		DoubleModifyworld = 2;	
	end	
	--5%加成
	local BattleModify = 1;
	if actor:HasBuff(242) then
		BattleModify = 1.05;
	end	
	--队长加成20%
	local leadModify = 0 ;
	if actor:IsLeader() then
	    leadModify = 0.2 ;
	end
	
	local JieriModify = 1
	if actor:HasBuff(291) then
		JieriModify = actor:FindBuff(291):GetBuffValue1()
	end
	    
  --玩家获得经验	
	expGain = actor:GetOwner():GetAgeCheckState() * 0.5 * math.floor(npcExp * (20 * npcLevel + 10) / (20 * mapLevel + 14) * killCount * teamCountModify * lvDiffModify * DoubleModify2 * DoubleModify3 * DoubleModifyworld * JieriModify * BattleModify*DoubleModifyHFT*DoubleModify4 * 20);--玩家升级经验10倍
	LuaI.SetTempResult(expGain);
	--职业加成
	local jobCount = GetPartyDifferentClass(actor );
	if jobCount == 3 then 
    	actor: SetBoundsExp(expGain * (0.05+leadModify));
	elseif jobCount == 4 then 
    	actor: SetBoundsExp(expGain * (0.2+leadModify));
	elseif teamCount >= 3 then
	    actor: SetBoundsExp(expGain * leadModify);
	end
end

function partnerExpGain(actor, owner, killCount, npcLevel, npcExp, teamCount, mapLevel)--同伴获取经验设定（同伴练功丸）
	local teamCountModify = 1 - (teamCount - 1) * 0.1
	local lv = actor:GetLevel();
	local lvDiff = math.abs(lv - mapLevel);
	local lvDiffModify = 0;
	if lvDiff <= 4 then
	    lvDiffModify = 1;
	elseif lvDiff <= 6 then
	    lvDiffModify = 0.9; 
	elseif lvDiff <= 8 then
	    lvDiffModify = 0.75;
	elseif lvDiff <= 10 then
	    lvDiffModify = 0.55;
	elseif lvDiff <= 12 then
	    lvDiffModify = 0.3	;
	elseif lvDiff <= 30 then
	    lvDiffModify = 0.3 - lvDiff / 100 ; 
	end		
	--双倍经验
	local DoubleModify2 = 1;
	if owner:HasBuff(246) then
		DoubleModify2 = 2;	
	end	
	if owner:HasBuff(22005) then
		--if owner:GetQuests():TimeMarkOver(30002,1440) ~= true then
			DoubleModify2 = 2;
		--[[else
			owner:GetScript():ShowError("火玉效果已消失了")
			owner:GetQuests():RemoveTimeMark(30002) 
			owner:RemoveBuff(22005)
		end	]]	
	end	
	if owner:HasBuff(22008) then
		--if owner:GetQuests():TimeMarkOver(30005,10080) ~= true then
			DoubleModify2 = 2;
		--[[else
			owner:GetScript():ShowError("千年火玉效果已消失了")
			owner:GetQuests():RemoveTimeMark(30005) 
			owner:RemoveBuff(22008)
		end	]]	
	end	
	--三倍经验
	local DoubleModify3 = 1;
	if owner:HasBuff(247) then
		DoubleModify3 = 3;	
	end	
	--鸿福堂2.5倍经验
	local DoubleModifyHFT = 1;
	if owner:HasBuff(302) then
		DoubleModifyHFT = 2.5;	
	end	
	--同伴四倍经验
	local DoubleModify4 = 1;
	if owner:HasBuff(304) then
		DoubleModify4 = 4;	
	end	
	
	--世界双
	local DoubleModifyworld = 1;
	if owner:HasBuff(254) then
		DoubleModifyworld = 2;	
	end		
	--5%加成
	local BattleModify = 1;
	if owner:HasBuff(242) then
		BattleModify = 1.05;
	end	
	--队长加成10%
	local leadModify = 0 ;
	if owner:IsLeader() then
	    leadModify = 0.2 ;
	end
	
	--节日活动经验加成
	local JieriModify =1
	if actor:HasBuff(291) then
		JieriModify = actor:FindBuff(291):GetBuffValue1()
	end	
	
	local lvDiff_owner = actor:GetLevel() - owner:GetLevel();
	if lvDiff_owner < 5 then
	    expGain = owner:GetOwner():GetAgeCheckState() * 0.5 * math.floor(1.5*npcExp * (20 * npcLevel + 10) / (20 * mapLevel + 14) * killCount * teamCountModify * lvDiffModify * DoubleModify2 * DoubleModify3 * DoubleModifyworld * BattleModify * JieriModify*DoubleModify4*DoubleModifyHFT * 160);--同伴升级经验20倍
	    ShowError(string.format("%d",owner:GetOwner():GetAgeCheckState()))
		LuaI.SetTempResult(expGain);
	    local jobCount = GetPartyDifferentClass(owner);
		if jobCount == 3 then 
    	    actor: SetBoundsExp(expGain * (0.05+leadModify) );
	    elseif jobCount == 4 then 
    	    actor: SetBoundsExp(expGain * (0.2+leadModify) );
		elseif teamCount >= 3 then
	        actor: SetBoundsExp(expGain * leadModify);
	    end
	else
		LuaI.SetTempResult(0);
	end
end

function ValidActionTarget(Atk, Def)--隐身技能对战斗的影响
		LuaI.SetTempResult(1);
	if Def == 0 then
		LuaI.SetTempResult(0);
	elseif Atk == Def then
		do return end	
	elseif Atk:GetCommand() == LuaI.BATCMD_ATTACK or Atk:GetCommand() == LuaI.BATCMD_SKILL or Atk:GetCommand() == LuaI.BATCMD_SPECIAL or 
			(Atk:GetCommand() == LuaI.BATCMD_ITEM and Atk:GetUseItemType() == 11) then
	    if (Def:HasBuff(1700) or Def:HasBuff(1701) or Def:HasBuff(2005) or Def:HasBuff(2038) or Def:HasBuff(1704)) and  
		(Atk:HasBuff(2006) or Atk:HasBuff(2039) or Atk:HasBuff(1807) or Atk:HasBuff(21006) or Atk:HasBuff(21039)) == false then
			LuaI.SetTempResult(0);
		end
	end	
end

function CheckEncounterBattle(player, m_movedStep, m_stepMod, mapEncRate, 
						m_encounterMod, mapLevel )--遇敌几率的设定（护身烟的影响）
	
	local map_id = player:GetMap_id()
	local needbuff = 1
	if map_id == 53900 or map_id == 54000 or map_id == 54100 or map_id == 54200 or map_id == 54300 
		or map_id == 54400 or map_id == 54500 or map_id == 54600 or map_id == 54700 or map_id == 54800 
		or map_id == 54900 or map_id == 55000 or map_id == 55100 or map_id == 55200 or map_id == 55300
		or map_id == 55400 or map_id == 55500 or map_id == 55600 or map_id == 55700 or map_id == 55800 then
		needbuff = 0
	end
	
	if map_id == 40202 or map_id == 40203 or map_id == 40204 then
		needbuff = 2
	end
	
	if player:HasBuff(213) and needbuff == 1 then
		--m_encounterMod = 1.35;
		--m_stepMod = 0;
	elseif player:HasBuff(214) and needbuff == 1 then
	    --m_encounterMod = 1.40;
		--m_stepMod = 0;
	elseif player:HasBuff(215) and needbuff == 1 then
		--m_encounterMod = 2.0;
		--m_stepMod = 0;
	end	
	
    --encRate = (1.0 * m_movedStep) / 50 * 100;
	local encRate = m_encounterMod * math.max(0, m_movedStep - m_stepMod ) / math.max(1, mapEncRate) * 100;
	
	if player:HasBuff(213) and needbuff == 1 then
	    
	    m_encounterMod = 1.35; --吃收费道具后，基础遇怪几率提高
		m_stepMod = 0; --吃收费道具后，不再有秒怪惩罚
		encRate = m_encounterMod * math.max(0, m_movedStep - m_stepMod) / math.max(1, mapEncRate) * 100; 
		--吃收费道具后，10步之内必遇怪
		if m_movedStep >= 30 then
		    encRate = 100;
		end
		
	elseif player:HasBuff(214) and needbuff == 1 then
	
	elseif player:HasBuff(215) and needbuff == 1 then
	
	end
	 
			
	local i = player:GetLevel() - mapLevel + 2;
	if player:HasBuff(210) and needbuff == 1 and i > 0 and  player:GetPK_Value() < 6 then
		encRate = 0;
	elseif player:HasBuff(211) and needbuff == 1 and i < -5 and  player:GetPK_Value() < 6 then
		encRate = 0;
	elseif player:HasBuff(212) and needbuff == 1 and  player:GetPK_Value() < 6 then
		encRate = 0;
	elseif player:HasBuff(257) and needbuff == 1 and  player:GetPK_Value() < 6 then
		encRate = 0;
	end	
	
	if player:HasBuff(256) and needbuff == 0 then
		encRate = 0
	end
	
	if math.random(1, 100) <= encRate then
   		player:SetEncounterBattle(true);
	else
   		player:SetEncounterBattle( false);
	end
	
	
end

function CanCatch(Atk, Def)--设定捕捉MOB几率（宠物技能的影响）
    local hpRatio =  Def:GetHP() / Def:GetMaxHP() * 100;
	local Mob_id = Def:GetMob_id(); 
    --[[local correctGoodness = true;
    if Def:GetGoodness() > 0 then    	
    	if Atk:GetGoodness() < Def:GetGoodness() then
    		correctGoodness = false;
    	end
    elseif Def:GetGoodness() < 0 then
		if Atk:GetGoodness() > Def:GetGoodness() then
    		correctGoodness = false;
    	end
	end	]]--
	
	if Def:GetRace() == 4 then
		prob = 15;
	end
	
	--if correctGoodness then
		if Mob_id == 358 then
			prob = 100
		elseif Mob_id == 900 or Mob_id == 901 then
			prob = 80;
	    elseif hpRatio >= 80 and hpRatio < 100 then
	        prob = 40;
		elseif hpRatio >= 50 and hpRatio < 80 then
		    prob = 50;
		elseif hpRatio >= 10 and hpRatio < 50 then
		    prob = 60;
		elseif hpRatio < 10 then
		    prob = 70;
		end
		
		local ratio1 = math.random(1, 100);
		local petCatch = false
		local Catchrate = 0
		local pet = Atk:GetUsingPet();
		if pet ~= nil then
			if pet:HasSkill(7005) then
				petCatch = true
				if pet:GetSpirit() == 0 then
					Catchrate = 2
				elseif pet:GetSpirit() == 1 then
					Catchrate = 4
				elseif pet:GetSpirit() == 2 then
					Catchrate = 8
				elseif pet:GetSpirit() == 3 then
					Catchrate = 5
				elseif pet:GetSpirit() == 4 then
					Catchrate = 6
				elseif pet:GetSpirit() == 5 then
					Catchrate = 11
				elseif pet:GetSpirit() == 6 then
					Catchrate = 1
				end
			end
		end
		
		local prob2 = prob + Catchrate
		
		if ratio1 < prob2 then
			local positionsign1 = 0;
			local battle1 = Atk:GetBattle()
			for i = 0, battle1:GetActorCount() - 1 do
				local actor = battle1:GetActor(i)
				if actor:IsPlayer() then
					if actor:GetIndex() == Atk:GetIndex() then
						positionsign1 = i;
						break
					end
				end
			end
			if Def:GetRace() == 3 or Def:GetRace() == 4 or  Def:GetRace() == 5 then
				Atk:AddBuff(4000, 1, positionsign1, 0, 60, 100);
			end
			LuaI.SetTempResult(1);
		else
			if pet ~= nil then
				if pet:HasSkill(7005) then
				local ratio2 = math.random(1, 100);
					if ratio2 < prob2 then
						local positionsign2 = 0;
						local battle2 = Atk:GetBattle()						
						for i = 0, battle2:GetActorCount() - 1 do
							local actor = battle2:GetActor(i)
							if actor:IsPlayer() then
								if actor:GetIndex() == Atk:GetIndex() then
									positionsign2 = i;
									break
								end
							end
						end
						if Def:GetRace() == 4 or Def:GetRace() == 5 then
							Atk:AddBuff(4000, 1, positionsign2, 0, 60, 100);
						end
						LuaI.SetTempResult(1);
						Atk:PetActive();
					else
						LuaI.SetTempResult(0);
					end	
				else
					LuaI.SetTempResult(0);
				end
			else
				LuaI.SetTempResult(0);
			end    
		end
	--[[else
		LuaI.SetTempResult(0);
	end]]--
end

function CalStepMod(char, turnNum)
    char:GetCclass();
	if char ~= nil then
   		--char:SetStepMod( math.max(0, (turnNum - 3) * 10));
		if turnNum ==1 then
		    char:SetStepMod((2 - turnNum) * 15);
		else
		    char:SetStepMod(0);
		end
   	end
end


function PartnerJoinBattle(favor)--好感度影响同伴参战设定
	local noJoinBattle = 0; -- 0% will not join the battle
	
	if favor >= 60 then
	    noJoinBattle = 0;
	elseif favor >= 50 and favor < 60 then
	    noJoinBattle = 20;
    elseif favor >= 40 and favor < 50 then
	    noJoinBattle = 40;
 	elseif favor >= 30 and favor < 40 then
	    noJoinBattle = 60;
	elseif favor >= 20 and favor < 30 then
	    noJoinBattle = 80;	
	else
	    noJoinBattle = 100;
	end
	
	local rand = math.random(0, 100);
	if rand >= noJoinBattle then
	    LuaI.SetTempResult(1);
	else
	    LuaI.SetTempResult(0);
	end
	
end

function CalCatchSP(pmobLevel)--捕捉MOB需要的SP设定
	local catchSP = pmobLevel * 2 + 5;
	LuaI.SetTempResult(catchSP);
end

function CalPartnerFav(char, partner)--同伴好感度处理
	--[[local goodnessDiff = 0;
	if char:GetGoodness() > partner:GetGoodness() then
	    goodnessDiff = char:GetGoodness() - partner:GetGoodness();
	else
	    goodnessDiff = partner:GetGoodness() - char:GetGoodness();
	end
	
	local favSub = 0;

	if goodnessDiff >= 100 and goodnessDiff < 300 then
		favSub = 5;
	elseif goodnessDiff >= 300 and goodnessDiff < 500 then
		favSub = 15;
	elseif goodnessDiff >= 500 then
		favSub = 50;
	end
	
	if favSub > partner:GetFavor() then
	    partner:SetFavor(0);
	else
		local newFav = partner:GetFavor() - favSub;
		partner:SetFavor(newFav);
	end   --]]
end

function CalPlayerNextLvExp(Lv)--玩家升级所需经验公式
	local result = 0;
	if Lv >= 1 and Lv <= 10 then
		result = 0.03 * Lv - 0.02 ;
	elseif Lv >= 11 and Lv <= 20 then
		result = 0.166 * Lv - 1.38 ;
	elseif Lv >= 21 and Lv <= 30 then
		result = 0.084 * Lv + 0.26 ;
	elseif Lv >= 31 and Lv <= 40 then
		result = 0.404 * Lv - 9.34 
	elseif  Lv >= 41 and Lv <= 50 then
	    result = 0.736 * Lv - 22.62 
	elseif  Lv >= 51 and Lv <= 60 then
	    result = 0.516 * Lv - 11.62 ;	
	elseif  Lv >= 61 and Lv <= 70 then
	    result = 1.077 * Lv - 45.28 ;
	elseif  Lv >= 71 and Lv <= 80 then
	    result = 0.267 * Lv + 11.42 ; 
	elseif  Lv >= 81 and Lv <= 89 then
	    result = 0.738 * Lv - 26.26 ; 	
	elseif  Lv >= 90 and Lv <= 99 then
		result = 13.33 * Lv - 1159.54 ; 	
	elseif  Lv >= 100 and Lv <= 109 then
		result = 36 * Lv - 3403.84 ; 	 	
	elseif  Lv >= 110 and Lv <= 119 then
		result = 76 * Lv - 7763.84 ; 
	elseif  Lv >= 120 and Lv <= 201 then
		result = 11090 ; 		
	--elseif  Lv >= 140 and Lv <= 175 then
		--result = 12000 ; 		
	--elseif  Lv >= 140 and Lv <= 150 then
		--result = 120000 ; 		
	--elseif  Lv >= 150 and Lv <= 160 then
		--result = 240000 ; 		
	--elseif  Lv >= 160 and Lv <= 170 then
		--result = 128 * Lv - 15500.84 ; 		
	--elseif  Lv >= 170 and Lv <= 175 then
		--result = 128 * Lv - 15900.84 ; 		
	end
	result = result * 6.6 * 70 * (4 * 100 + 10) + 100 ;
	LuaI.SetTempResult(result);
	return result;
end

function GetNativeUpByCultivation(cultivation)
	if cultivation < 1 or cultivation > 10 then
		LuaI.SetTempResult(0);
		return 0;
	end

	local NativeUpByCultivation = {5, 15, 30, 50, 75, 105, 140, 180, 225, 275};
	LuaI.SetTempResult(NativeUpByCultivation[cultivation]);
	return NativeUpByCultivation[cultivation];
end

function GetNativeUpByPractice(Practice)
	if Practice < 1 or Practice > 10 then
		LuaI.SetTempResult(0);
		return 0;
	end

	local NativeUpByPractice = {0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.6};
	LuaI.SetTempResult(NativeUpByPractice[Practice]);
	return NativeUpByPractice[Practice];
end

function CalPartnerAttr(partner, needDecrease)--同伴战斗中属性
	local sta = partner:GetSTA();
	local spr = partner:GetSPR();
	local str = partner:GetSTR();
	local con = partner:GetCON();
	local agi = partner:GetAGI();
	local grow = partner:GetGrow();
	local level = partner:GetLevel();
	local Practice = partner:GetPractice();
	local PracticeUp = GetNativeUpByPractice(Practice);
	grow = grow + PracticeUp

	local cultivation = partner:GetCultivation();
	local NativeUp = GetNativeUpByCultivation(cultivation);

	local atk = level*(partner:GetATK_native() + NativeUp)*7/1500+str*grow;
		
	local def = level *(partner:GetDEF_native() + NativeUp)/433+con* grow*4/3;
	
	local spd = agi * (partner:GetSPD_native() + NativeUp) / 1000 ;
	
	local power = (((partner:GetSP_native() + NativeUp)+1340)/95)*((grow +1)/72)*level+spr * 0.7 + str * 0.4 + sta * 0.3 + con * 0.2;
	
	local hit = 2 * grow * agi + 0.5 * grow * str + (partner:GetHIT_native() + NativeUp) * level / 350;
	
	local eva = grow * agi + 1.25 * level * grow + (partner:GetEVA_native() + NativeUp) * level / 1000 ;

	local maxHP = (partner:GetHP_native() + NativeUp) * level / 750 + grow * sta * 7;
	
	local maxSP = (partner:GetSP_native() + NativeUp) * level / 500 + grow * spr * 3;
	
	local Race = partner:GetRace();
	
	if Race == 1 then
		
		atk = level*(partner:GetATK_native() + NativeUp)*7/1500+str*grow;
		
		def = level *(partner:GetDEF_native() + NativeUp)/433+con* grow*4/3 ;
	
		spd = 0.5 * agi * (partner:GetSPD_native() + NativeUp) / 1000 ;
		
		power = (((partner:GetSP_native() + NativeUp)+1340)/95)*((grow +1)/72)*level+spr * 0.7 + str * 0.4 + sta * 0.3 + con * 0.2;
	
		hit = (1.5 * (grow * agi + (partner:GetHIT_native() + NativeUp) * level / 600))*0.8;
	
		eva = (grow * agi + 1.25 * level * grow + (partner:GetEVA_native() + NativeUp) * level / 1000)*0.8 ;

		maxHP = (partner:GetHP_native() + NativeUp) * level / 750 + grow * sta * 7;
	
		maxSP = (partner:GetSP_native() + NativeUp) * level / 500 + grow * spr * 3;
	end
	
	partner:SetAttrib2(atk, def, hit, eva, power, spd);
	local hp = partner:GetHP();
	partner:SetHP(hp, maxHP);
	local sp = partner:GetSP();
	partner:SetSP(sp, maxSP);
	
	level = level + 1; --for cal next level
	local nextLevelExp = CalPlayerNextLvExp(level) / 4;
	if level <= 20 then
	    nextLevelExp = nextLevelExp * 0.05 * level
	end
	if level >= 90 then
	    nextLevelExp = nextLevelExp * (1 - (level - 90) * 0.015)
	end	
	partner:SetNextLvExp(nextLevelExp);
end

function CalBatMobAttr(batActor, batMob, needDecrease)--怪物战斗中属性
--[[batActor and batMob is pointing to same object
	but some function is belong to batmob. Therefore, this
	function need to have both batmob and batactor pointer.
	]]--

	local sta = batActor:GetSTA();
	local spr = batActor:GetSPR();
	local str = batActor:GetSTR();
	local con = batActor:GetCON();
	local agi = batActor:GetAGI();
	local grow = batMob:GetGrow();
	local level = batActor:GetLevel();
		
	local atk = level*batMob:GetATK_native()*7/1500+str*grow;
		
	local def = level * batMob:GetDEF_native()/433+con* grow*4/3;
	
	local spd = agi * batMob:GetSPD_native() / 900 ;
	
	local power = ((batMob:GetPOW_native()+1340)/95)*((grow +1)/72)*level+spr * 0.7 + str * 0.4 + sta * 0.3 + con * 0.2;
	
	local hit = 2 * grow * agi + 0.5 * grow * str +batMob:GetHIT_native() * level / 350;
	
	local eva = grow * agi + 1.25 * level * grow + batMob:GetEVA_native() * level / 1000 ;

	local maxHP = batMob:GetHP_native() * level / 750 + grow * sta * 7;
	
	local maxSP = batMob:GetSP_native() * level / 500 + grow * spr * 3;
			
	local atklevelmodify = 1;
	local deflevelmodify = 1;
	local powerlevelmodify = 1;
	local hitlevelmodify = 1;
	local evalevelmodify = 1;
	local spdlevelmodify = 1;
	local maxHPlevelmodify = 1;
	local maxSPlevelmodify = 1;
	if level < 10 then
	    atklevelmodify = 0.6;
		deflevelmodify = 0.3;		
		hitlevelmodify = 1;
		evalevelmodify = 0.2;
		powerlevelmodify = 0.4;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.28;
		maxSPlevelmodify = 0.28;
	elseif level < 20 then
	    atklevelmodify = 0.7;
		deflevelmodify = 0.3;		
		hitlevelmodify = 1;
		evalevelmodify = 0.6;
		powerlevelmodify = 0.4;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.35;
		maxSPlevelmodify = 0.35;
	elseif level < 30 then
	    atklevelmodify = 0.8;
		deflevelmodify = 0.3;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.7;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.4;
		maxSPlevelmodify = 0.4;
	elseif level < 40 then
	    atklevelmodify = 0.95;
		deflevelmodify = 0.35;		
		hitlevelmodify = 1;
		evalevelmodify = 0.75;
		powerlevelmodify = 0.8;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.45;
		maxSPlevelmodify = 0.45;
	elseif level < 50 then
	    atklevelmodify = 1.05;
		deflevelmodify = 0.4;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.85;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.5;
		maxSPlevelmodify = 0.5;
	elseif level < 60 then
	    atklevelmodify = 1.07;
		deflevelmodify = 0.4;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.85;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.525;
		maxSPlevelmodify = 0.525;
	elseif level < 70 then
	    atklevelmodify = 1.1;
		deflevelmodify = 0.45;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.85;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.55;
		maxSPlevelmodify = 0.55;
	elseif level < 121 then
	    atklevelmodify = 1.1;
		deflevelmodify = 0.5;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.9;
		spdlevelmodify = 0.2;
		maxHPlevelmodify = 0.7;
		maxSPlevelmodify = 0.7;
	elseif level > 120 then
	    atklevelmodify = 1.1;
		deflevelmodify = 0.7;		
		hitlevelmodify = 1;
		evalevelmodify = 0.8;
		powerlevelmodify = 0.9;
		spdlevelmodify = 0.3;
		maxHPlevelmodify = 1;
		maxSPlevelmodify = 1;
	end
	
	if needDecrease then
	    atk = atk * atklevelmodify;
	    def = def * deflevelmodify;
	    spd = spd * spdlevelmodify;
	    power = power * powerlevelmodify;
	    hit = hit * hitlevelmodify;
	    eva = eva * evalevelmodify;
	end
	
	batActor:SetAttrib2(atk, def, hit, eva, power, spd);
	batActor:SetMaxHP(maxHP * maxHPlevelmodify);
	batActor:SetMaxSP(maxSP * maxSPlevelmodify);

end

function CalCharAttr(pChar, pCharData, sta, spr, str, con, agi )--玩家属性
--[[
	the sta, spr... agi is modified by the item before passing in here.
	Therefore, the value of pChar:GetSTA(), pChar:GetSPR()... is not the same
	as sta, spr.
]]  
 local eq_MaxHP = 0;
   local eq = pChar:GetBag():GetItem(120)  ;
   
	if eq then
	eq_MaxHP = (eq_MaxHP + eq:GetHIT())	/3;
	end
	
	local tk_MaxHP = 0;
   local tk = pChar:GetBag():GetItem(121)  ;
   
	if tk then
	tk_MaxHP = (tk_MaxHP + tk:GetHIT())	/3;
	end
	


    local atk = (str * pCharData:GetAtk_STR() + 30)/3 + 30+eq_MaxHP+tk_MaxHP;
    local hit = str * pCharData:GetAtk_STR() + 30;
	local def = con * pCharData:GetDef_CON();
	local eva = agi * pCharData:GetEva_AGI()+10;
	local power = spr * pCharData:GetPwd_SPR() + sta * pCharData:GetPwd_STA() + con * pCharData:GetPwd_CON() + str * pCharData:GetPwd_STR();
	local spd = agi * pCharData:GetSpd_AGI() + str * 0.1 + con * pCharData:GetSpd_CON() + sta * pCharData:GetSpd_STA();

    local maxHP = sta * pCharData:GetMaxHP_STA() + 100;
	local maxSP = spr * pCharData:GetMaxSP_SPR() + 80;
	
	pChar:SetAttrib2(atk, def, hit, eva, power, spd);
	pChar:SetHP(pChar:GetHP(), pChar:GetMHP(), maxHP);
	pChar:SetSP(pChar:GetSP(), pChar:GetMSP(), maxSP);

end

function CalBatCharAttr(pBatActor, pCharData, sta, spr, str, con, agi )--玩家战斗中属性
--[[
	the sta, spr... agi is modified by the item before passing in here.
	Therefore, the value of pChar:GetSTA(), pChar:GetSPR()... is not the same
	as sta, spr.
]]   

    local atk = pBatActor:GetHIT()/3+30;
    local hit = str * pCharData:GetAtk_STR() + 30;
	local def = con * pCharData:GetDef_CON();
	local eva = agi * pCharData:GetEva_AGI()+10;
	local power = spr * pCharData:GetPwd_SPR() + sta * pCharData:GetPwd_STA() + con * pCharData:GetPwd_CON() + str * pCharData:GetPwd_STR();
	local spd = agi * pCharData:GetSpd_AGI() + str * 0.1 + con * pCharData:GetSpd_CON() + sta * pCharData:GetSpd_STA();

    local maxHP = sta * pCharData:GetMaxHP_STA() + 100;
    local maxSP = spr * pCharData:GetMaxSP_SPR() + 80;
	
	pBatActor:SetAttrib2(atk, def, hit, eva, power, spd);
 	pBatActor:SetMaxHP(maxHP);
	pBatActor:SetMaxSP(maxSP);

end

function EndBattle(pBatActor)--玩家战斗后处理（碧血丹、碧灵丹 花旗参 刺五加）
	if pBatActor:GetOwner():GetMap():GetMap_id() == 20323 then
			return
	end
	--花旗参
	if pBatActor:HasBuff(305) then
		local CurHP = pBatActor:GetHP();
		local CurMHP = pBatActor:GetMHP();
		local MaxHP = pBatActor:GetMaxHP();
		local Buff305 = pBatActor:FindBuff(305);
		if CurHP > 0 then
			if Buff305 then
				local value1 = Buff305:GetBuffValue1();
				if MaxHP - CurMHP >= 0 and  MaxHP - CurHP > 0 then
					if value1 <= MaxHP - CurMHP then
						pBatActor:ChangeMHp(value1);
						pBatActor:ChangeHp(value1);
						pBatActor:RemoveBuff(305);
					elseif value1 <= MaxHP - CurHP then
						pBatActor:ChangeMHp(MaxHP - CurMHP);
						pBatActor:ChangeHp(value1);
						pBatActor:RemoveBuff(305);
					else
						pBatActor:ChangeMHp(MaxHP - CurMHP);
						pBatActor:ChangeHp(MaxHP - CurHP);
						value1 = value1 - (MaxHP - CurHP);
						Buff305:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end
	--刺五加
	if pBatActor:HasBuff(306) then
		local CurSP = pBatActor:GetSP();
		local MaxSP = pBatActor:GetMaxSP();
		local Buff306 = pBatActor:FindBuff(306);
		if CurSP >= 0 then
			if Buff306 then
				local value1 = Buff306:GetBuffValue1();
				if MaxSP - CurSP > 0 then
					if value1 <= MaxSP - CurSP then
						pBatActor:ChangeSp(value1);
						pBatActor:RemoveBuff(306);
					else
						pBatActor:ChangeSp(MaxSP - CurSP);
						value1 = value1 - (MaxSP - CurSP);
						Buff306:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end	
	--碧血丹
	if pBatActor:HasBuff(249) then
		local CurHP = pBatActor:GetHP();
		local CurMHP = pBatActor:GetMHP();
		local MaxHP = pBatActor:GetMaxHP();
		local Buff249 = pBatActor:FindBuff(249);
		if CurHP > 0 then
			if Buff249 then
				local value1 = Buff249:GetBuffValue1();
				if MaxHP - CurMHP >= 0 and  MaxHP - CurHP > 0 then
					if value1 <= MaxHP - CurMHP then
						pBatActor:ChangeMHp(value1);
						pBatActor:ChangeHp(value1);
						pBatActor:RemoveBuff(249);
					elseif value1 <= MaxHP - CurHP then
						pBatActor:ChangeMHp(MaxHP - CurMHP);
						pBatActor:ChangeHp(value1);
						pBatActor:RemoveBuff(249);
					else
						pBatActor:ChangeMHp(MaxHP - CurMHP);
						pBatActor:ChangeHp(MaxHP - CurHP);
						value1 = value1 - (MaxHP - CurHP);
						Buff249:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end
	--碧灵丹
	if pBatActor:HasBuff(250) then
		local CurSP = pBatActor:GetSP();
		local MaxSP = pBatActor:GetMaxSP();
		local Buff250 = pBatActor:FindBuff(250);
		if CurSP >= 0 then
			if Buff250 then
				local value1 = Buff250:GetBuffValue1();
				if MaxSP - CurSP > 0 then
					if value1 <= MaxSP - CurSP then
						pBatActor:ChangeSp(value1);
						pBatActor:RemoveBuff(250);
					else
						pBatActor:ChangeSp(MaxSP - CurSP);
						value1 = value1 - (MaxSP - CurSP);
						Buff250:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end	
end

function partnerEndBattle(pPlayer, pPartner)--同伴战斗后处理（碧血丹、碧灵丹、碧心丹 花旗参 刺五加）
	--花旗参
	if pPlayer:HasBuff(305) then
		local pCurHP = pPartner:GetHP();
		local pMaxHP = pPartner:GetMaxHP();
		local Buff305 = pPlayer:FindBuff(305);
		if pCurHP > 0 then
			if Buff305 then
				local value1 = Buff305:GetBuffValue1();
				if pMaxHP - pCurHP > 0 then
					if value1 <= pMaxHP - pCurHP then
						pPartner:ChangeHp(value1);
						pPlayer:RemoveBuff(305);
					else
						pPartner:ChangeHp(pMaxHP - pCurHP);
						value1 = value1 - (pMaxHP - pCurHP);
						Buff305:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end	
	--刺五加
	if pPlayer:HasBuff(306) then
		local pCurSP = pPartner:GetSP();
		local pMaxSP = pPartner:GetMaxSP();
		local Buff306 = pPlayer:FindBuff(306);
		if pCurSP >= 0 then
			if Buff306 then
				local value1 = Buff306:GetBuffValue1();
				if pMaxSP - pCurSP > 0 then
					if value1 <= pMaxSP - pCurSP then
						pPartner:ChangeSp(value1);
						pPlayer:RemoveBuff(306);
					else
						pPartner:ChangeSp(pMaxSP - pCurSP);
						value1 = value1 - (pMaxSP - pCurSP);
						Buff306:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end
	if pPlayer:HasBuff(249) then
		local pCurHP = pPartner:GetHP();
		local pMaxHP = pPartner:GetMaxHP();
		local Buff249 = pPlayer:FindBuff(249);
		if pCurHP > 0 then
			if Buff249 then
				local value1 = Buff249:GetBuffValue1();
				if pMaxHP - pCurHP > 0 then
					if value1 <= pMaxHP - pCurHP then
						pPartner:ChangeHp(value1);
						pPlayer:RemoveBuff(249);
					else
						pPartner:ChangeHp(pMaxHP - pCurHP);
						value1 = value1 - (pMaxHP - pCurHP);
						Buff249:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end	
	if pPlayer:HasBuff(250) then
		local pCurSP = pPartner:GetSP();
		local pMaxSP = pPartner:GetMaxSP();
		local Buff250 = pPlayer:FindBuff(250);
		if pCurSP >= 0 then
			if Buff250 then
				local value1 = Buff250:GetBuffValue1();
				if pMaxSP - pCurSP > 0 then
					if value1 <= pMaxSP - pCurSP then
						pPartner:ChangeSp(value1);
						pPlayer:RemoveBuff(250);
					else
						pPartner:ChangeSp(pMaxSP - pCurSP);
						value1 = value1 - (pMaxSP - pCurSP);
						Buff250:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end
	if pPlayer:HasBuff(262) then
		local pCurFavor = pPartner:GetFavor();
		local pMaxFavor = 100;
		local Buff262 = pPlayer:FindBuff(262);
		if pCurFavor >= 0 then
			if Buff262 then
				local value1 = Buff262:GetBuffValue1();
				DeltaFavor = math.floor(pMaxFavor - pCurFavor)
				if DeltaFavor >= 1 then
					if value1 <= DeltaFavor then
						pPartner:ChangeFavor(value1);
						pPlayer:RemoveBuff(262);
					else
						pPartner:ChangeFavor(DeltaFavor);
						value1 = value1 - DeltaFavor;
						Buff262:SetBuffValue1(value1);
					end
				end	
			end
		end	
	end
end

function CalMobCount(leader, minLackey, maxLackey, partyCount)--战斗中呼出喽罗个数设定
	
	local min = minLackey;
	if minLackey == 255 then
		min  = partyCount;
	end	
	local max = maxLackey;
	if maxLackey == 255 then
		max  = partyCount * 2;
	end	
	local nMob = math.random(min, max);
	if  minLackey == 255 and maxLackey == 255 and (leader:HasBuff(264) or
	leader:HasBuff(265) or leader:HasBuff(266) or leader:HasBuff(267) or 
	leader:HasBuff(268) or leader:HasBuff(269) or leader:HasBuff(270) or 
	leader:HasBuff(271) or leader:HasBuff(272) or leader:HasBuff(273) or leader:HasBuff(274))then
		nMob = math.random(5, 10);
	end	
	if  minLackey == 255 and maxLackey == 255 and leader:HasBuff(251) then
		nMob = partyCount * 2 ;
	end	
	LuaI.SetTempResult(nMob);
end

function DeadPenaltyCheck(pBatActor)--战斗死亡后身上有替身娃娃的处理

end


function CalPlayerMaxVP(Char)
	LuaI.SetTempResult(40 + Char:GetLevel() * 10);
end

function CalPlayerMaxER(Char)
	LuaI.SetTempResult(40 + Char:GetLevel() * 10);
end

function CalSkillNextLvExp(Lv, shopID)
	local result = 0 ;
	if shopID >= 1 and shopID <= 12 then
		LuaUI.SetTempResult(result);
	elseif shopID >=45 and shopID <= 47 then
	    LuaUI.SetTempResult(result);
	elseif shopID >= 18 and shopID <= 29 then
		LuaUI.SetTempResult(result);
	elseif shopID >= 30 and shopID <= 41 then
		LuaUI.SetTempResult(result);	
	end
end

function CalSkillNextLvMoney(Lv, shopID)
	local result = 0 ;
	if shopID >= 1 and shopID <= 12 then       
	    LuaUI.SetTempResult(result);
	elseif shopID >=45 and shopID <= 47 then
	    LuaUI.SetTempResult(result);
	elseif shopID >= 13 and shopID <= 17 then       
	    LuaUI.SetTempResult(2 * result);
	elseif  shopID >= 18 and shopID <= 29 then
	    LuaUI.SetTempResult(result);
	elseif  shopID >= 30 and shopID <= 41 then
	    LuaUI.SetTempResult(result);	
	end	
end


function CalSkillNextLvYuanBao(Lv, shopID)
	local result = CalPlayerNextLvExp(Lv) / 12 ;	
	LuaI.SetTempResult(result);
end

function CalSkillNextLvHonor(Lv, shopID)
	local result = 1000000 ;
    if shopID >= 13 and shopID <= 14 then 
	    result = 10 * Lv ^ 2;
		LuaI.SetTempResult(result);
	elseif shopID >= 15 and shopID <= 17 then
	    result = 2 * Lv ^ 2 * (1 + 0.01 * Lv);
		LuaI.SetTempResult(result);
	elseif shopID == 42 then
		local mjzz = 500
		LuaI.SetTempResult(mjzz);	
	elseif shopID == 43 then
	    if Lv >= 2 then
			local yrw = Lv * 100 * (Lv - 1)
		else
			local yrw = 100
		end
		LuaI.SetTempResult(yrw);
	elseif shopID == 44 then
	    local sww = 250 * Lv 
		LuaI.SetTempResult(sww);
	end
end

function CalSkillNextLvDonateFaction(Lv, shopID)
	local result = CalPlayerNextLvExp(Lv) / 12 ;	
	LuaI.SetTempResult(result);
end

function CalSkillNextLvDonateManor(Lv, shopID)
	local result = CalPlayerNextLvExp(Lv) / 12 ;	
	LuaI.SetTempResult(result);
end

function CalPetNextLvExp(Lv)--宠物所需升级经验
	--local result = 5 * Lv * (Lv  + 1) + 90;
	local result = 40 * Lv + 80;
	LuaI.SetTempResult(result);
end

function DeadPenaltyCheck(pBatActor)--战斗死亡处理
  
	local item = pBatActor:FindItemByid(66028);
	local item1 = pBatActor:FindItemByid(61010)
	local lv = pBatActor:GetLevel();
	local battle = pBatActor:GetBattle():GetBattleType()
	local name = pBatActor:GetOwner():GetName()
	local guild = pBatActor:GetOwner():GetGuild()
	if lv < 10 then
		pBatActor:SetPunish(true);
		pBatActor:SetJumpBack(true);
	
	elseif item ~= nil then
		pBatActor:GetOwner():GetItems():RemoveItem(66028,1);
		pBatActor:SetPunish(false);
		pBatActor:SetJumpBack(false);
	elseif item1 ~= nil then
		pBatActor:GetOwner():GetItems():RemoveItem(61010,1);
		pBatActor:SetPunish(false);
		pBatActor:SetJumpBack(false);
	end	
	
	if guild and pBatActor:GetBattle():GetPunish() ~= false then
		local guildPos = pBatActor:GetOwner():GetGuildPos()
		local jobname = ""
		if guildPos == 1 then
			jobname = "帮主"
		elseif guildPos == 2 then
			jobname = "副帮主"
		elseif guildPos == 3 then
			jobname = "左护法"
		elseif guildPos == 4 then
			jobname = "右护法"
		elseif guildPos == 5 then
			jobname = "长老"
		elseif guildPos == 6 then
			jobname = "堂主"
		elseif guildPos == 7 then
			jobname = "精英"
		elseif guildPos == 8 then
			jobname = "香主"
		elseif guildPos == 9 then
			jobname = "商人"
		elseif guildPos == 10 then
			jobname = "帮众"
		end
		if battle == 0 then
			pBatActor:GetOwner():ShowGuildMsg(string.format("人在江湖飘，哪能不挨刀。本帮%s\#W%s\#G与敌交手时不幸的为我们验证了这句话，含恨而死，临死时说了句\#P你妹啊！NB的人伤不起呀~\#G #002",jobname,name), guild:GetGuild_uid())
		elseif battle == 1 then
			pBatActor:GetOwner():ShowGuildMsg(string.format("仇人相见，分外眼红。本帮%s\#W%s\#G在与仇家拼死互斗若干回合后，不慎被仇家一击致命，临死时说了句\#P你妹啊！NB的人伤不起呀~\#G #002",jobname,name), guild:GetGuild_uid())
		elseif battle == 2 then
			pBatActor:GetOwner():ShowGuildMsg(string.format("本帮%s\#W%s\#G不幸卷入江湖仇杀，遇刺身亡，临死时说了句\#P你妹啊！NB的人伤不起呀~\#G #002。请帮派全体成员集体默哀一分钟，以祭亡魂。",jobname,name), guild:GetGuild_uid())
		elseif battle == 8 then
			pBatActor:GetOwner():ShowGuildMsg(string.format("“弱肉强食”果然不假。本帮%s\#W%s\#G在强食幻境苦等火麒麟之时遭到强人偷袭，不敌而亡，临死时说了句\#P你妹啊！NB的人伤不起呀~\#G #002",jobname,name), guild:GetGuild_uid())
		end
	end
end

function itemMul(user, target)
	if Def:GetFaction() == 6 then
		LuaI.SetTempResult(1);
	else
		LuaI.SetTempResult(1);
	end
end

function CalWCNextLvExp(Lv)
	local result = 9 + (Lv + 1) * Lv / 2;
	LuaI.SetTempResult(result);
end
   
function GetPartyDifferentClass(pActor)
	
	local battle = pActor:GetBattle();
	local teamNo = pActor:GetTeam();
	local listCount = 0;
	local list = {};
	local i = 0;
	while(true)   do
		local actor = battle:GetActor(i);
		if actor == nil then
			break;
		end
		
		if actor:IsPlayer() and actor:GetTeam() == teamNo and actor:GetHP() > 0 and not actor:IsEscaped() then
			local found = false;
			for x = 0, listCount - 1 do
				if  list[x] == actor:GetCclass() then
					found = true;
					break;
				end
			end
			if not found then
				 list[listCount] = actor:GetCclass();
				 listCount = listCount + 1;
			end
		end		
		i = i + 1;
	end
	
	return listCount;
end

--准备答题,允许进入
function QuestionPrepare()
	LuaI.QuestionPrepare();
end
--开始答题活动
function QuestionStart()
	LuaI.QuestionStart();
end
--答题活动奖励
function CalQuestionRewards(pCharacter,point,rank)
	local PointExp = (4 * pCharacter:GetLevel()+10) * 6.6/3 * 1.5 * point * 10;--答题奖励经验10倍
	local ItemList = {};
	local ItemId = 0;
	pCharacter:ChangeExpForScript(PointExp);
	pCharacter:GetScript():ShowError(string.format("\#W答题积分%d，获得经验值%d",point,PointExp));
	if rank >= 1 and rank <= 10 then
		local PR = math.random(1, 10);
		if PR ~= 1 then
			ItemList = {53038,41403,70021};
			ItemId = RandTable(ItemList);
		else
			ItemList = {53000,41403};
			ItemId = RandTable(ItemList);
		end
		pCharacter:GetScript():Rumor(string.format("\#W%s\#O在“梦幻小百科”活动中展示出过人的智慧，奖励物品\#P%s\#O，以此鼓励。", pCharacter:GetName(), GetItemName(ItemId)), false);
		if pCharacter:GetItems():GetFreeSlot(0) > 0 then
			pCharacter:GetItems():AddItemForScript(ItemId);
			pCharacter:GetScript():ShowError(string.format("\#W获得%s",GetItemName(ItemId)));
		else
			pCharacter:GetScript():ShowError(string.format("\#W当前包裹已满，无法获得%s",GetItemName(ItemId)));
		end
		
		if rank >=1 and rank <= 3 then
			local f = assert(io.open("output.txt", "a"));
			if f ~= nil then
				f:write(string.format("Question rewards rank: %d character_id :%d character_name = %s\n", rank, pCharacter:GetChar_id(), pCharacter:GetName()));
				f:close();
			end
		end
	end
end

function IsInWarCWBattleMap(map_id)

	local bInMap = 0;
	
	if	map_id == 56500 or map_id == 56503 or map_id == 56506 or map_id == 56509 
	or map_id == 56512 or map_id == 56515 or map_id == 56518 or map_id == 56521 then
		bInMap = 1;	
	end		
		
	LuaI.SetTempResult(bInMap);
end

function GuildCWKick(GuildPvPGroup ,map_id, x, y)
	local pMap = 0;
	if GuildPvPGroup == 1 then
		pMap = GetMap(56500);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56501);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
		pMap = GetMap(56502);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 2 then
		pMap = GetMap(56503);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56504);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
		pMap = GetMap(56505);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 3 then
		pMap = GetMap(56506);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56507);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		pMap = GetMap(56508);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 4 then
		pMap = GetMap(56509);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56510);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		pMap = GetMap(56511);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 5 then
		pMap = GetMap(56512);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56513);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		pMap = GetMap(56514);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 6 then
		pMap = GetMap(56515);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
	
		pMap = GetMap(56516);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		pMap = GetMap(56517);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 7 then
		pMap = GetMap(56518);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56519);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
		pMap = GetMap(56520);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		
	elseif GuildPvPGroup == 8 then
		pMap = GetMap(56521);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);

		pMap = GetMap(56522);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);
		pMap = GetMap(56523);
		if pMap == nil then return end
		pMap:ForceLeaveGuildWarCW(map_id, x, y);		
	end
end

function CalGuildWarReward(pChar, result)
	local Exp = 0;
	local GuildPoint = 0;
	if result == 0 then --win
		Exp =  4 * (pChar:GetLevel() + 19) * 6.6 * 140 * 10;--世博活动经验10倍
		GuildPoint = 2 * pChar:GetLevel() * 10;--世博帮贡经验10倍
		pChar:GetScript():ShowError(string.format("\#W帮派比武获胜，获得经验值%d，获得帮贡%d",Exp,GuildPoint));
		--世博会
		if LuaI.GetRealYear(LuaI.GetServiceTime()) == 2010 and LuaI.GetRealMonth(LuaI.GetServiceTime()) > 4 and LuaI.GetRealMonth(LuaI.GetServiceTime()) < 11 then
			if pChar:GetItems():GetFreeSlot(0) > 0 then 
				if math.random(0,1) == 1 then
					pChar:GetItems():AddItemForScript(79050,1)
					pChar:GetScript():ShowError("\#W帮派比武获胜，获得“成”字字牌");
				else
					pChar:GetItems():AddItemForScript(79051,1)
					pChar:GetScript():ShowError("\#W帮派比武获胜，获得“功”字字牌");
				end
			else
				pChar:GetScript():ShowError("\#W包裹已满，无法获得字牌");
			end
		end
	elseif result == 1 then --lose
		Exp =  4 * (pChar:GetLevel() + 19) * 6.6 * 70 * 10;--帮派比武经验10倍
		GuildPoint = 1 * pChar:GetLevel() * 10;--帮派帮贡经验10倍
		pChar:GetScript():ShowError(string.format("\#W积极参与帮派比武有功，获得经验值%d，获得帮贡%d",Exp,GuildPoint));
	elseif result == 2 then
		Exp =  4 * (pChar:GetLevel() + 19) * 6.6 * 105 * 10;--帮派比武经验10倍
		GuildPoint = 1.5 * pChar:GetLevel() * 10;--帮派帮贡经验10倍
		pChar:GetScript():ShowError(string.format("\#W帮派比武平局，获得经验值%d，获得帮贡%d",Exp,GuildPoint));
	else 	--leave the battle
		Exp =  4 * (pChar:GetLevel() + 19) * 6.6 * 70 * 10;--帮派比武经验10倍
		GuildPoint = 1 * pChar:GetLevel() * 10;--帮派帮贡经验10倍
		pChar:GetScript():ShowError(string.format("\#W积极参与帮派比武有功，获得经验值%d，获得帮贡%d",Exp,GuildPoint));
	end
	pChar:ChangeExpForScript(Exp);
	pChar:ChangeGDonateForScript(GuildPoint);
end

--cw
function GuildWarCWBattleFail(pChar, result)
	if	pChar:GetMap_id() == 56500 and pChar:GetPvPCWSide() == 1 then
		pChar:JumpMap(56501, 35, 89);
	elseif pChar:GetMap_id() == 56500 and pChar:GetPvPCWSide() == 2 then
		pChar:JumpMap(56502, 35, 89);

	elseif	pChar:GetMap_id() == 56503 and pChar:GetPvPCWSide() == 1 then
		pChar:JumpMap(56504, 35, 89);
	elseif pChar:GetMap_id() == 56503 and pChar:GetPvPCWSide() == 2 then
		pChar:JumpMap(56505, 35, 89);

	elseif	pChar:GetMap_id() == 56506 and pChar:GetPvPCWSide() == 1 then
		pChar:JumpMap(56507, 35, 89);
	elseif pChar:GetMap_id() == 56506 and pChar:GetPvPCWSide() == 2 then
		pChar:JumpMap(56508, 35, 89);

	elseif	pChar:GetMap_id() == 56509 and pChar:GetPvPCWSide() == 1 then
		pChar:JumpMap(56510, 35, 89);
	elseif pChar:GetMap_id() == 56509 and pChar:GetPvPCWSide() == 2 then
		pChar:JumpMap(56511, 35, 89);

	elseif	pChar:GetMap_id() == 56512 and pChar:GetPvPCWSide() == 1 then
		pChar:JumpMap(56513, 35, 89);
	elseif pChar:GetMap_id() == 56512 and pChar:GetPvPCWSide() == 2 then
		pChar:JumpMap(56514, 35, 89);

	elseif	pChar:GetMap_id() == 56515 then
		if pChar:GetPvPCWSide() == 1 then
			pChar:JumpMap(56516, 35, 89);
		elseif pChar:GetPvPCWSide() == 2 then
			pChar:JumpMap(56517, 35, 89);
		end
		
	elseif	pChar:GetMap_id() == 56518 then
		if pChar:GetPvPCWSide() == 1 then
			pChar:JumpMap(56519, 35, 89);
		elseif pChar:GetPvPCWSide() == 2 then
			pChar:JumpMap(56520, 35, 89);
		end
		
	elseif	pChar:GetMap_id() == 56521 then
		if pChar:GetPvPCWSide() == 1 then
			pChar:JumpMap(56522, 35, 89);
		elseif pChar:GetPvPCWSide() == 2 then
			pChar:JumpMap(56523, 35, 89);
		end
	end
end

function CalGuildWarCWReward(pChar, result)
	CalGuildWarReward(pChar, result);
end

function GuildWarCWPrepare()
	LuaI.GuildWarCWPrepare();
end

function GuildWarCWStart()
	LuaI.GuildWarCWStart();
end

function GuildWarCWEndContinue()
	LuaI.GuildWarCWEndContinue();
end

function GuildWarCWEndAll()
	LuaI.GuildWarCWEndAll();
end

function GuildWarCWGenGroup()
	LuaI.GuildWarCWGenGroup();
end

function GuildWarCWSendGroupRumor()
	LuaI.GuildWarCWSendGroupRumor();
end

function GuildWarPrepare()
	LuaI.GuildWarPrepare();
end

function GuildWarStart()
	LuaI.GuildWarStart();
end

function GuildWarEndContinue()
	LuaI.GuildWarEndContinue();
end

function GuildWarEndAll()
	LuaI.GuildWarEndAll();
end

function GuildWarGenGroup()
	LuaI.GuildWarGenGroup();
end

function GuildWarSendGroupRumor()
	LuaI.GuildWarSendGroupRumor();
end
   
function GetUnSoulBoundStoneID(rare)
	local result
	if rare == 0 or rare == 1 or rare == 2 then
		result = 80019
	elseif rare == 3 then
		result = 80019
	elseif rare == 4 or rare == 5 then
		result = 80019
	else
		result = 0
	end
	LuaI.SetTempResult(result);
end

function GetUnSoulBoundStoneNum(lv)
	local result = 1
	LuaI.SetTempResult(1);
end
--银行存款上限设定
function GetDepositMoneyMax(pChar)
	local BankMoneyMax = pChar:GetQuests():GetFlag(10)
	if BankMoneyMax >= 1 and BankMoneyMax < 20 then
		LuaI.SetTempResult(10000000*(BankMoneyMax+1));
	elseif BankMoneyMax >=20 then
	    LuaI.SetTempResult(2000000000);
	else 
		LuaI.SetTempResult(100000000);
	end	
end
--wangzlStart
function IncognitoPKEnd()
	LuaI.IncognitoPKEnd()
end

function IncognitoPKStart()
	LuaI.IncognitoPKStart()
end
--玩家进入时的脚本处理
function OnCharacterEnter(pChar)
	pChar:AddBuff(40003, 0, 0, 0, 90000000, 1)
	pChar:AddBuff(40004, 0, 0, 0, 90000000, 100)
  if pChar:GetLevel() >= 30 then
    pChar:AddSkill(371)
  end
  local lv = pChar:GetLevel();
  if lv >= 10 then
	pChar:SetReborn(98,12,33)
  else
    pChar:SetReborn(98,12,33)
  end
	----由于有些情况下换线时 读取下列变身无效果，所以在OnCharacterLeave(pChar)增加另一个，修改时注意修改2处
	local ctm = 0
	for bf = 50001 , 50055 do
		if pChar:HasBuff(bf) then
			if bf == 50000 then ctm = 740;
			elseif bf == 50001 then ctm = 741;
			elseif bf == 50002 then ctm = 742;
			elseif bf == 50003 then ctm = 743;
			elseif bf == 50004 then ctm = 744;
			elseif bf == 50005 then ctm = 756;
			elseif bf == 50006 then ctm = 761;
			elseif bf == 50007 then ctm = 762;
			elseif bf == 50008 then ctm = 763;
			elseif bf == 50009 then ctm = 750;
			elseif bf == 50010 then ctm = 746;
			elseif bf == 50011 then ctm = 755;
			elseif bf == 50012 then ctm = 751;
			elseif bf == 50013 then ctm = 767;
			elseif bf == 50014 then ctm = 748;
			elseif bf == 50015 then ctm = 754;
			elseif bf == 50016 then ctm = 772;
			elseif bf == 50017 then ctm = 753;
			elseif bf == 50018 then ctm = 766;
			elseif bf == 50019 then ctm = 757;
			elseif bf == 50020 then ctm = 768;
			elseif bf == 50021 then ctm = 769;
			elseif bf == 50022 then ctm = 771;
			elseif bf == 50023 then ctm = 789;
			elseif bf == 50024 then ctm = 788;
			elseif bf == 50025 then ctm = 770;
			elseif bf == 50026 then ctm = 764;
			elseif bf == 50027 then ctm = 765;
			elseif bf == 50028 then ctm = 760;
			elseif bf == 50029 then ctm = 752;
			elseif bf == 50030 then ctm = 747;
			elseif bf == 50031 then ctm = 759;
			elseif bf == 50032 then ctm = 777;
			elseif bf == 50033 then ctm = 780;
			elseif bf == 50034 then ctm = 758;
			elseif bf == 50035 then ctm = 773;
			elseif bf == 50036 then ctm = 775;
			elseif bf == 50037 then ctm = 779;
			elseif bf == 50038 then ctm = 774;
			elseif bf == 50039 then ctm = 787;
			elseif bf == 50040 then ctm = 749;
			elseif bf == 50041 then ctm = 776;
			elseif bf == 50042 then ctm = 781;
			elseif bf == 50043 then ctm = 785;
			elseif bf == 50044 then ctm = 784;
			elseif bf == 50045 then ctm = 786;
			elseif bf == 50046 then ctm = 782;
			elseif bf == 50047 then ctm = 783;
			elseif bf == 50048 then ctm = 778;
			elseif bf == 50049 then ctm = 790;
			elseif bf == 50050 then ctm = 791;
			elseif bf == 50051 then ctm = 792;
			elseif bf == 50052 then ctm = 793;
			elseif bf == 50053 then ctm = 794;	
			elseif bf == 50054 then ctm = 795;	
			elseif bf == 50055 then ctm = 796;			
			end
			pChar:ChangeToMob(ctm,1)
			break
		end
	end

		--wangzl 解决玩家身上多个主线任务Bug
		flag = 0 
		MinQuest_id = 10800
		number = pChar:GetQuests():GetQuestCount()
		for i=0,number-1 do
			 questLog = pChar:GetQuests():GetEachQuest(i)
			 if not questLog then  return end
			 TypeID = questLog:GetType_id()
			 if TypeID == 1 then
				flag = flag + 1
				Quest_id = questLog:GetQuest_id()
				if Quest_id < MinQuest_id then
					MinQuest_id = Quest_id
				end
			 end
		end
		if flag > 1 then
			number = pChar:GetQuests():GetQuestCount()
			for i=0,number-1 do
				 questLog = pChar:GetQuests():GetEachQuest(i)
				 if not questLog then  return end
				 TypeID = questLog:GetType_id()
				 if TypeID == 1 then
					Quest_id = questLog:GetQuest_id()
					if Quest_id ~= MinQuest_id then
						pChar:GetQuests():RemoveQuest(Quest_id)
					end
				end
			end
		end
	--wangzl　解决玩家无法进入"晓生居密室"Bug
	flag10412 = pChar:GetQuests():GetFlag(10412)
	if flag10412== -2147483647 then
		pChar:GetQuests():SetFlag(10412,1)
	end

	
	
	if pChar:GetQuests():GetTimeMark(40000) ~= 0 then
		--[[if pChar:GetLevel() >= 30 then
			if pChar:GetQuests():TimeMarkOver(40000, 43200) == true then
			--离线30天以上的情况		
				if pChar:HasBuff(285) then
					pChar:RemoveBuff(285)		
				end	
				pChar:AddBuff(285, 1, 2, 0, 60, 100)		
			elseif pChar:GetQuests():TimeMarkOver(40000, 20160) == true then
			--离线14-30天的情况
				if pChar:HasBuff(285) then
					pChar:RemoveBuff(285)		
				end
				pChar:AddBuff(285, 1, 1, 0, 60, 100)	
			end				
		end	
		pChar:GetQuests():RemoveTimeMark(40000)	]]
	end	
	local OnMap = pChar:GetMap_id()
	if OnMap == 40404 or OnMap == 40405 or OnMap == 40406 or OnMap == 40407 or OnMap == 40408 or OnMap == 40409 then
		pChar:JumpMap(20600,64,102);
	end
	if OnMap == 252 and pChar:GetPK_Value() == 0 then
		pChar:JumpMap(252,30,50,0,0,0,false);
	end	
	if(OnMap == 53800 or OnMap == 53900 or OnMap == 54000 or OnMap == 54100 or OnMap == 54200 or
	   OnMap == 54300 or OnMap == 54400 or OnMap == 54500 or OnMap == 54600 or OnMap == 54700 or
	   OnMap == 54800 or OnMap == 54900 or OnMap == 55000 or OnMap == 55100 or OnMap == 55200 or 
	   OnMap == 55300 or OnMap == 55400 or OnMap == 55500 or OnMap == 55600 or OnMap == 55700 or 
	   OnMap == 55800)and pChar:GetQuests():TimeMarkOver(50000, 180)then
		pChar:JumpMap(20400,27,196);
	end
	if OnMap == 58100 then
		pChar:JumpMap(34,228,407);
	end
	if OnMap == 20321 then
		pChar:JumpMap(34,228,407);
	end
	--镇帮神器
	if OnMap == 56530 or OnMap == 56531 or OnMap == 56532 or OnMap == 56533 or OnMap == 56534 or OnMap == 56540 or OnMap == 56541 or OnMap == 56542 or
		 OnMap == 56543 or OnMap == 56544 or OnMap == 56545 or OnMap == 56546 or OnMap == 56547 or OnMap == 56548 or OnMap == 56549 then
		pChar:JumpMap(20300,199,169);
	end
	--wangzl
	if OnMap == 20323 and pChar:GetQuests():TimeMarkOver(55502, 120) then
		pChar:JumpMap(34,228,407);
	end 
	if pChar:GetQuests():GetTimeMark(50001) ~= 0 then
		if pChar:GetQuests():TimeMarkOver(50001,30) == false and OnMap == 55800 then
			pChar:JumpMap(53800,25,77)				
		end
		pChar:GetQuests():RemoveTimeMark(50001)	
	end		
	local QuestLog55102 = pChar:GetQuests():GetQuest(55102)
	if QuestLog55102 ~= nil then
		if QuestLog55102:GetTargetNpcNum() == 1 then
			QuestLog55102:SetFail(false)
			QuestLog55102:SetComplete(true)
		end
	end
	-- fix quest lost bug
	if pChar:GetQuests() then
		local nFlag = pChar:GetQuests():GetFlag(301);
		if nFlag == 0 then
			local bHaveZhuXianOld = false;
			local nPrei = 10000;
			local Myi = 10000;
			for i = 10000, 10699 do
				Myi = Myi + 1;
				
				if Myi > 10699 then
					break;
				end
				
				local nFlag1 =  pChar:GetQuests():GetFlag(Myi);
				if pChar:GetQuests():HasFlag(Myi) == false then
					local nn = Myi - Myi % 100;
					nn = nn + 100;
					if pChar:GetQuests():HasFlag(nn) == true then
						Myi = nn;
						if Myi > 10699 then
							break;
						end
						nFlag1 =  pChar:GetQuests():GetFlag(Myi);
					end
				end
				
				if pChar:GetQuests():HasFlag(Myi) and nFlag1 > 2147483 then
					nPrei = Myi;
					bHaveZhuXianOld = true;
				end
				
				if bHaveZhuXianOld == true then
					local nNextID = nPrei + 1;
					if nFlag1 < 2147483 and pChar:GetQuests():HasQuest(nNextID) == false then
							if nNextID ==10000  then AddQuest1(Quest10000,pChar);break;
						elseif nNextID ==10001  then AddQuest1(Quest10001,pChar);break;
						elseif nNextID ==10002  then AddQuest1(Quest10002,pChar);break;
						elseif nNextID ==10003  then AddQuest1(Quest10003,pChar);break;
						elseif nNextID ==10004  then AddQuest1(Quest10004,pChar);break;
						elseif nNextID ==10005  then AddQuest1(Quest10005,pChar);break;
						elseif nNextID ==10006  then AddQuest1(Quest10006,pChar);break;
						elseif nNextID ==10007  then AddQuest1(Quest10007,pChar);break;
						elseif nNextID ==10008  then AddQuest1(Quest10008,pChar);break;
						elseif nNextID ==10009  then AddQuest1(Quest10009,pChar);break;
						elseif nNextID ==10010  then AddQuest1(Quest10010,pChar);break;
						elseif nNextID ==10011  then AddQuest1(Quest10011,pChar);break;
						elseif nNextID ==10012  then AddQuest1(Quest10012,pChar);break;
						elseif nNextID ==10013  then AddQuest1(Quest10013,pChar);break;
						elseif nNextID ==10014  then AddQuest1(Quest10014,pChar);break;
						elseif nNextID ==10015  then AddQuest1(Quest10015,pChar);break;
						elseif nNextID ==10016  then AddQuest1(Quest10016,pChar);break;
						elseif nNextID ==10017  then AddQuest1(Quest10017,pChar);break;
						elseif nNextID ==10018  then AddQuest1(Quest10018,pChar);break;
						elseif nNextID ==10019  then AddQuest1(Quest10019,pChar);break;
						elseif nNextID ==10020  then AddQuest1(Quest10020,pChar);break;
						elseif nNextID ==10021  then AddQuest1(Quest10021,pChar);break;
						elseif nNextID ==10022  then AddQuest1(Quest10022,pChar);break;
						elseif nNextID ==10023  then AddQuest1(Quest10023,pChar);break;
						elseif nNextID ==10024  then AddQuest1(Quest10024,pChar);break;
						elseif nNextID ==10025  then AddQuest1(Quest10025,pChar);break;
						elseif nNextID ==10026  then AddQuest1(Quest10026,pChar);break;
						elseif nNextID ==10027  then AddQuest1(Quest10027,pChar);break;
						elseif nNextID ==10028  then AddQuest1(Quest10028,pChar);break;
						elseif nNextID ==10029  then AddQuest1(Quest10029,pChar);break;
						elseif nNextID ==10030  then AddQuest1(Quest10030,pChar);break;
						elseif nNextID ==10031  then AddQuest1(Quest10031,pChar);break;
						elseif nNextID ==10032  then AddQuest1(Quest10032,pChar);break;
						elseif nNextID ==10033  then AddQuest1(Quest10033,pChar);break;
						elseif nNextID ==10034  then AddQuest1(Quest10034,pChar);break;
						elseif nNextID ==10035  then AddQuest1(Quest10035,pChar);break;
						elseif nNextID ==10036  then AddQuest1(Quest10036,pChar);break;
						elseif nNextID ==10037  then AddQuest1(Quest10037,pChar);break;
						elseif nNextID ==10038  then AddQuest1(Quest10038,pChar);break;
						elseif nNextID ==10039  then AddQuest1(Quest10039,pChar);break;
						elseif nNextID ==10040  then AddQuest1(Quest10040,pChar);break;
						elseif nNextID ==10041  then AddQuest1(Quest10041,pChar);break;
						elseif nNextID ==10042  then AddQuest1(Quest10042,pChar);break;
						elseif nNextID ==10043  then AddQuest1(Quest10043,pChar);break;
						elseif nNextID ==10044  then AddQuest1(Quest10044,pChar);break;
						elseif nNextID ==10045  then AddQuest1(Quest10045,pChar);break;
						elseif nNextID ==10046  then AddQuest1(Quest10046,pChar);break;
						elseif nNextID ==10047  then AddQuest1(Quest10047,pChar);break;
						elseif nNextID ==10048  then AddQuest1(Quest10048,pChar);break;
						elseif nNextID ==10049  then AddQuest1(Quest10049,pChar);break;
						elseif nNextID ==10050  then AddQuest1(Quest10050,pChar);break;
						elseif nNextID ==10051  then AddQuest1(Quest10051,pChar);break;
						elseif nNextID ==10052  then AddQuest1(Quest10052,pChar);break;
						elseif nNextID ==10053  then AddQuest1(Quest10053,pChar);break;
						elseif nNextID ==10054  then AddQuest1(Quest10054,pChar);break;
						elseif nNextID ==10055  then AddQuest1(Quest10055,pChar);break;
						elseif nNextID ==10056  then AddQuest1(Quest10056,pChar);break;
						elseif nNextID ==10057  then AddQuest1(Quest10057,pChar);break;
						elseif nNextID ==10058  then AddQuest1(Quest10058,pChar);break;
						elseif nNextID ==10059  then AddQuest1(Quest10059,pChar);break;
						elseif nNextID ==10060  then AddQuest1(Quest10060,pChar);break;
						elseif nNextID ==10061  then AddQuest1(Quest10061,pChar);break;
						elseif nNextID ==10062  then AddQuest1(Quest10062,pChar);break;
						elseif nNextID ==10063  then AddQuest1(Quest10063,pChar);break;
						elseif nNextID ==10064  then AddQuest1(Quest10064,pChar);break;
						elseif nNextID ==10065  then AddQuest1(Quest10065,pChar);break;
						elseif nNextID ==10066  then AddQuest1(Quest10066,pChar);break;
						elseif nNextID ==10067  then AddQuest1(Quest10067,pChar);break;
						elseif nNextID ==10068  then AddQuest1(Quest10068,pChar);break;
						elseif nNextID ==10069  then AddQuest1(Quest10069,pChar);break;
						elseif nNextID ==10070  then AddQuest1(Quest10070,pChar);break;
						elseif nNextID ==10071  then AddQuest1(Quest10071,pChar);break;
						elseif nNextID ==10072  then AddQuest1(Quest10072,pChar);break;
						elseif nNextID ==10073  then AddQuest1(Quest10073,pChar);break;
						elseif nNextID ==10074  then AddQuest1(Quest10074,pChar);break;
						elseif nNextID ==10075  then AddQuest1(Quest10075,pChar);break;
						elseif nNextID ==10076  then AddQuest1(Quest10076,pChar);break;
						elseif nNextID ==10077  then AddQuest1(Quest10077,pChar);break;
						elseif nNextID ==10078  then AddQuest1(Quest10078,pChar);break;
						elseif nNextID ==10079  then AddQuest1(Quest10079,pChar);break;
						elseif nNextID ==10080  then AddQuest1(Quest10080,pChar);break;
						elseif nNextID ==10081  then AddQuest1(Quest10081,pChar);break;
						elseif nNextID ==10082  then AddQuest1(Quest10082,pChar);break;
						elseif nNextID ==10083  then AddQuest1(Quest10083,pChar);break;
						elseif nNextID ==10084  then AddQuest1(Quest10084,pChar);break;
						elseif nNextID ==10085  then AddQuest1(Quest10085,pChar);break;
						elseif nNextID ==10086  then AddQuest1(Quest10086,pChar);break;
						elseif nNextID ==10087  then AddQuest1(Quest10087,pChar);break;
						elseif nNextID ==10088  then AddQuest1(Quest10088,pChar);break;
						elseif nNextID ==10089  then AddQuest1(Quest10089,pChar);break;
						elseif nNextID ==10090  then AddQuest1(Quest10090,pChar);break;
						elseif nNextID ==10091  then AddQuest1(Quest10091,pChar);break;
						elseif nNextID ==10092  then AddQuest1(Quest10092,pChar);break;
						elseif nNextID ==10093  then AddQuest1(Quest10093,pChar);break;
						elseif nNextID ==10094  then AddQuest1(Quest10094,pChar);break;
						elseif nNextID ==10095  then AddQuest1(Quest10095,pChar);break;
						elseif nNextID ==10096  then AddQuest1(Quest10096,pChar);break;
						elseif nNextID ==10097  then AddQuest1(Quest10097,pChar);break;
						elseif nNextID ==10098  then AddQuest1(Quest10098,pChar);break;
						elseif nNextID ==10099  then AddQuest1(Quest10099,pChar);break;
						elseif nNextID ==10100  then AddQuest1(Quest10100,pChar);break;
						elseif nNextID ==10101  then AddQuest1(Quest10101,pChar);break;
						elseif nNextID ==10102  then AddQuest1(Quest10102,pChar);break;
						elseif nNextID ==10103  then AddQuest1(Quest10103,pChar);break;
						elseif nNextID ==10104  then AddQuest1(Quest10104,pChar);break;
						elseif nNextID ==10105  then AddQuest1(Quest10105,pChar);break;
						elseif nNextID ==10106  then AddQuest1(Quest10106,pChar);break;
						elseif nNextID ==10107  then AddQuest1(Quest10107,pChar);break;
						elseif nNextID ==10108  then AddQuest1(Quest10108,pChar);break;
						elseif nNextID ==10109  then AddQuest1(Quest10109,pChar);break;
						elseif nNextID ==10110  then AddQuest1(Quest10110,pChar);break;
						elseif nNextID ==10111  then AddQuest1(Quest10111,pChar);break;
						elseif nNextID ==10112  then AddQuest1(Quest10112,pChar);break;
						elseif nNextID ==10113  then AddQuest1(Quest10113,pChar);break;
						elseif nNextID ==10114  then AddQuest1(Quest10114,pChar);break;
						elseif nNextID ==10115  then AddQuest1(Quest10115,pChar);break;
						elseif nNextID ==10116  then AddQuest1(Quest10116,pChar);break;
						elseif nNextID ==10117  then AddQuest1(Quest10117,pChar);break;
						elseif nNextID ==10118  then AddQuest1(Quest10118,pChar);break;
						elseif nNextID ==10119  then AddQuest1(Quest10119,pChar);break;
						elseif nNextID ==10120  then AddQuest1(Quest10120,pChar);break;
						elseif nNextID ==10121  then AddQuest1(Quest10121,pChar);break;
						elseif nNextID ==10122  then AddQuest1(Quest10122,pChar);break;
						elseif nNextID ==10123  then AddQuest1(Quest10123,pChar);break;
						elseif nNextID ==10124  then AddQuest1(Quest10124,pChar);break;
						elseif nNextID ==10125  then AddQuest1(Quest10125,pChar);break;
						elseif nNextID ==10126  then AddQuest1(Quest10126,pChar);break;
						elseif nNextID ==10127  then AddQuest1(Quest10127,pChar);break;
						elseif nNextID ==10128  then AddQuest1(Quest10128,pChar);break;
						elseif nNextID ==10129  then AddQuest1(Quest10129,pChar);break;
						elseif nNextID ==10130  then AddQuest1(Quest10130,pChar);break;
						elseif nNextID ==10131  then AddQuest1(Quest10131,pChar);break;
						elseif nNextID ==10132  then AddQuest1(Quest10132,pChar);break;
						elseif nNextID ==10133  then AddQuest1(Quest10133,pChar);break;
						elseif nNextID ==10134  then AddQuest1(Quest10134,pChar);break;
						elseif nNextID ==10135  then AddQuest1(Quest10135,pChar);break;
						elseif nNextID ==10136  then AddQuest1(Quest10136,pChar);break;
						elseif nNextID ==10137  then AddQuest1(Quest10137,pChar);break;
						elseif nNextID ==10138  then AddQuest1(Quest10138,pChar);break;
						elseif nNextID ==10139  then AddQuest1(Quest10139,pChar);break;
						elseif nNextID ==10140  then AddQuest1(Quest10140,pChar);break;
						elseif nNextID ==10141  then AddQuest1(Quest10141,pChar);break;
						elseif nNextID ==10142  then AddQuest1(Quest10142,pChar);break;
						elseif nNextID ==10143  then AddQuest1(Quest10143,pChar);break;
						elseif nNextID ==10144  then AddQuest1(Quest10144,pChar);break;
						elseif nNextID ==10145  then AddQuest1(Quest10145,pChar);break;
						elseif nNextID ==10146  then AddQuest1(Quest10146,pChar);break;
						elseif nNextID ==10147  then AddQuest1(Quest10147,pChar);break;
						elseif nNextID ==10148  then AddQuest1(Quest10148,pChar);break;
						elseif nNextID ==10149  then AddQuest1(Quest10149,pChar);break;
						elseif nNextID ==10150  then AddQuest1(Quest10150,pChar);break;
						elseif nNextID ==10151  then AddQuest1(Quest10151,pChar);break;
						elseif nNextID ==10152  then AddQuest1(Quest10152,pChar);break;
						elseif nNextID ==10153  then AddQuest1(Quest10153,pChar);break;
						elseif nNextID ==10154  then AddQuest1(Quest10154,pChar);break;
						elseif nNextID ==10155  then AddQuest1(Quest10155,pChar);break;
						elseif nNextID ==10156  then AddQuest1(Quest10156,pChar);break;
						elseif nNextID ==10157  then AddQuest1(Quest10157,pChar);break;
						elseif nNextID ==10158  then AddQuest1(Quest10158,pChar);break;
						elseif nNextID ==10159  then AddQuest1(Quest10159,pChar);break;
						elseif nNextID ==10160  then AddQuest1(Quest10160,pChar);break;
						elseif nNextID ==10161  then AddQuest1(Quest10161,pChar);break;
						elseif nNextID ==10162  then AddQuest1(Quest10162,pChar);break;
						elseif nNextID ==10163  then AddQuest1(Quest10163,pChar);break;
						elseif nNextID ==10164  then AddQuest1(Quest10164,pChar);break;
						elseif nNextID ==10165  then AddQuest1(Quest10165,pChar);break;
						elseif nNextID ==10166  then AddQuest1(Quest10166,pChar);break;
						elseif nNextID ==10167  then AddQuest1(Quest10167,pChar);break;
						elseif nNextID ==10168  then AddQuest1(Quest10168,pChar);break;
						elseif nNextID ==10169  then AddQuest1(Quest10169,pChar);break;
						elseif nNextID ==10170  then AddQuest1(Quest10170,pChar);break;
						elseif nNextID ==10171  then AddQuest1(Quest10171,pChar);break;
						elseif nNextID ==10172  then AddQuest1(Quest10172,pChar);break;
						elseif nNextID ==10173  then AddQuest1(Quest10173,pChar);break;
						elseif nNextID ==10174  then AddQuest1(Quest10174,pChar);break;
						elseif nNextID ==10175  then AddQuest1(Quest10175,pChar);break;
						elseif nNextID ==10176  then AddQuest1(Quest10176,pChar);break;
						elseif nNextID ==10177  then AddQuest1(Quest10177,pChar);break;
						elseif nNextID ==10178  then AddQuest1(Quest10178,pChar);break;
						elseif nNextID ==10179  then AddQuest1(Quest10179,pChar);break;
						elseif nNextID ==10180  then AddQuest1(Quest10180,pChar);break;
						elseif nNextID ==10181  then AddQuest1(Quest10181,pChar);break;
						elseif nNextID ==10182  then AddQuest1(Quest10182,pChar);break;
						elseif nNextID ==10183  then AddQuest1(Quest10183,pChar);break;
						elseif nNextID ==10184  then AddQuest1(Quest10184,pChar);break;
						elseif nNextID ==10185  then AddQuest1(Quest10185,pChar);break;
						elseif nNextID ==10186  then AddQuest1(Quest10186,pChar);break;
						elseif nNextID ==10187  then AddQuest1(Quest10187,pChar);break;
						elseif nNextID ==10188  then AddQuest1(Quest10188,pChar);break;
						elseif nNextID ==10189  then AddQuest1(Quest10189,pChar);break;
						elseif nNextID ==10190  then AddQuest1(Quest10190,pChar);break;
						elseif nNextID ==10191  then AddQuest1(Quest10191,pChar);break;
						elseif nNextID ==10192  then AddQuest1(Quest10192,pChar);break;
						elseif nNextID ==10193  then AddQuest1(Quest10193,pChar);break;
						elseif nNextID ==10194  then AddQuest1(Quest10194,pChar);break;
						elseif nNextID ==10195  then AddQuest1(Quest10195,pChar);break;
						elseif nNextID ==10196  then AddQuest1(Quest10196,pChar);break;
						elseif nNextID ==10197  then AddQuest1(Quest10197,pChar);break;
						elseif nNextID ==10198  then AddQuest1(Quest10198,pChar);break;
						elseif nNextID ==10199  then AddQuest1(Quest10199,pChar);break;
						elseif nNextID ==10200  then AddQuest1(Quest10200,pChar);break;
						elseif nNextID ==10201  then AddQuest1(Quest10201,pChar);break;
						elseif nNextID ==10202  then AddQuest1(Quest10202,pChar);break;
						elseif nNextID ==10203  then AddQuest1(Quest10203,pChar);break;
						elseif nNextID ==10204  then AddQuest1(Quest10204,pChar);break;
						elseif nNextID ==10205  then AddQuest1(Quest10205,pChar);break;
						elseif nNextID ==10206  then AddQuest1(Quest10206,pChar);break;
						elseif nNextID ==10207  then AddQuest1(Quest10207,pChar);break;
						elseif nNextID ==10208  then AddQuest1(Quest10208,pChar);break;
						elseif nNextID ==10209  then AddQuest1(Quest10209,pChar);break;
						elseif nNextID ==10210  then AddQuest1(Quest10210,pChar);break;
						elseif nNextID ==10211  then AddQuest1(Quest10211,pChar);break;
						elseif nNextID ==10212  then AddQuest1(Quest10212,pChar);break;
						elseif nNextID ==10213  then AddQuest1(Quest10213,pChar);break;
						elseif nNextID ==10214  then AddQuest1(Quest10214,pChar);break;
						elseif nNextID ==10215  then AddQuest1(Quest10215,pChar);break;
						elseif nNextID ==10216  then AddQuest1(Quest10216,pChar);break;
						elseif nNextID ==10217  then AddQuest1(Quest10217,pChar);break;
						elseif nNextID ==10218  then AddQuest1(Quest10218,pChar);break;
						elseif nNextID ==10219  then AddQuest1(Quest10219,pChar);break;
						elseif nNextID ==10220  then AddQuest1(Quest10220,pChar);break;
						elseif nNextID ==10221  then AddQuest1(Quest10221,pChar);break;
						elseif nNextID ==10222  then AddQuest1(Quest10222,pChar);break;
						elseif nNextID ==10223  then AddQuest1(Quest10223,pChar);break;
						elseif nNextID ==10224  then AddQuest1(Quest10224,pChar);break;
						elseif nNextID ==10225  then AddQuest1(Quest10225,pChar);break;
						elseif nNextID ==10226  then AddQuest1(Quest10226,pChar);break;
						elseif nNextID ==10227  then AddQuest1(Quest10227,pChar);break;
						elseif nNextID ==10228  then AddQuest1(Quest10228,pChar);break;
						elseif nNextID ==10229  then AddQuest1(Quest10229,pChar);break;
						elseif nNextID ==10230  then AddQuest1(Quest10230,pChar);break;
						elseif nNextID ==10231  then AddQuest1(Quest10231,pChar);break;
						elseif nNextID ==10232  then AddQuest1(Quest10232,pChar);break;
						elseif nNextID ==10233  then AddQuest1(Quest10233,pChar);break;
						elseif nNextID ==10234  then AddQuest1(Quest10234,pChar);break;
						elseif nNextID ==10235  then AddQuest1(Quest10235,pChar);break;
						elseif nNextID ==10236  then AddQuest1(Quest10236,pChar);break;
						elseif nNextID ==10237  then AddQuest1(Quest10237,pChar);break;
						elseif nNextID ==10238  then AddQuest1(Quest10238,pChar);break;
						elseif nNextID ==10239  then AddQuest1(Quest10239,pChar);break;
						elseif nNextID ==10240  then AddQuest1(Quest10240,pChar);break;
						elseif nNextID ==10241  then AddQuest1(Quest10241,pChar);break;
						elseif nNextID ==10242  then AddQuest1(Quest10242,pChar);break;
						elseif nNextID ==10243  then AddQuest1(Quest10243,pChar);break;
						elseif nNextID ==10244  then AddQuest1(Quest10244,pChar);break;
						elseif nNextID ==10245  then AddQuest1(Quest10245,pChar);break;
						elseif nNextID ==10246  then AddQuest1(Quest10246,pChar);break;
						elseif nNextID ==10247  then AddQuest1(Quest10247,pChar);break;
						elseif nNextID ==10248  then AddQuest1(Quest10248,pChar);break;
						elseif nNextID ==10249  then AddQuest1(Quest10249,pChar);break;
						elseif nNextID ==10250  then AddQuest1(Quest10250,pChar);break;
						elseif nNextID ==10251  then AddQuest1(Quest10251,pChar);break;
						elseif nNextID ==10252  then AddQuest1(Quest10252,pChar);break;
						elseif nNextID ==10253  then AddQuest1(Quest10253,pChar);break;
						elseif nNextID ==10254  then AddQuest1(Quest10254,pChar);break;
						elseif nNextID ==10255  then AddQuest1(Quest10255,pChar);break;
						elseif nNextID ==10256  then AddQuest1(Quest10256,pChar);break;
						elseif nNextID ==10257  then AddQuest1(Quest10257,pChar);break;
						elseif nNextID ==10258  then AddQuest1(Quest10258,pChar);break;
						elseif nNextID ==10259  then AddQuest1(Quest10259,pChar);break;
						elseif nNextID ==10260  then AddQuest1(Quest10260,pChar);break;
						elseif nNextID ==10261  then AddQuest1(Quest10261,pChar);break;
						elseif nNextID ==10262  then AddQuest1(Quest10262,pChar);break;
						elseif nNextID ==10263  then AddQuest1(Quest10263,pChar);break;
						elseif nNextID ==10264  then AddQuest1(Quest10264,pChar);break;
						elseif nNextID ==10265  then AddQuest1(Quest10265,pChar);break;
						elseif nNextID ==10266  then AddQuest1(Quest10266,pChar);break;
						elseif nNextID ==10267  then AddQuest1(Quest10267,pChar);break;
						elseif nNextID ==10268  then AddQuest1(Quest10268,pChar);break;
						elseif nNextID ==10269  then AddQuest1(Quest10269,pChar);break;
						elseif nNextID ==10270  then AddQuest1(Quest10270,pChar);break;
						elseif nNextID ==10271  then AddQuest1(Quest10271,pChar);break;
						elseif nNextID ==10272  then AddQuest1(Quest10272,pChar);break;
						elseif nNextID ==10273  then AddQuest1(Quest10273,pChar);break;
						elseif nNextID ==10274  then AddQuest1(Quest10274,pChar);break;
						elseif nNextID ==10275  then AddQuest1(Quest10275,pChar);break;
						elseif nNextID ==10276  then AddQuest1(Quest10276,pChar);break;
						elseif nNextID ==10277  then AddQuest1(Quest10277,pChar);break;
						elseif nNextID ==10278  then AddQuest1(Quest10278,pChar);break;
						elseif nNextID ==10279  then AddQuest1(Quest10279,pChar);break;
						elseif nNextID ==10280  then AddQuest1(Quest10280,pChar);break;
						elseif nNextID ==10281  then AddQuest1(Quest10281,pChar);break;
						elseif nNextID ==10282  then AddQuest1(Quest10282,pChar);break;
						elseif nNextID ==10283  then AddQuest1(Quest10283,pChar);break;
						elseif nNextID ==10284  then AddQuest1(Quest10284,pChar);break;
						elseif nNextID ==10285  then AddQuest1(Quest10285,pChar);break;
						elseif nNextID ==10286  then AddQuest1(Quest10286,pChar);break;
						elseif nNextID ==10287  then AddQuest1(Quest10287,pChar);break;
						elseif nNextID ==10288  then AddQuest1(Quest10288,pChar);break;
						elseif nNextID ==10289  then AddQuest1(Quest10289,pChar);break;
						elseif nNextID ==10290  then AddQuest1(Quest10290,pChar);break;
						elseif nNextID ==10291  then AddQuest1(Quest10291,pChar);break;
						elseif nNextID ==10292  then AddQuest1(Quest10292,pChar);break;
						elseif nNextID ==10293  then AddQuest1(Quest10293,pChar);break;
						elseif nNextID ==10294  then AddQuest1(Quest10294,pChar);break;
						elseif nNextID ==10295  then AddQuest1(Quest10295,pChar);break;
						elseif nNextID ==10296  then AddQuest1(Quest10296,pChar);break;
						elseif nNextID ==10297  then AddQuest1(Quest10297,pChar);break;
						elseif nNextID ==10298  then AddQuest1(Quest10298,pChar);break;
						elseif nNextID ==10299  then AddQuest1(Quest10299,pChar);break;
						elseif nNextID ==10300  then AddQuest1(Quest10300,pChar);break;
						elseif nNextID ==10301  then AddQuest1(Quest10301,pChar);break;
						elseif nNextID ==10302  then AddQuest1(Quest10302,pChar);break;
						elseif nNextID ==10303  then AddQuest1(Quest10303,pChar);break;
						elseif nNextID ==10304  then AddQuest1(Quest10304,pChar);break;
						elseif nNextID ==10305  then AddQuest1(Quest10305,pChar);break;
						elseif nNextID ==10306  then AddQuest1(Quest10306,pChar);break;
						elseif nNextID ==10307  then AddQuest1(Quest10307,pChar);break;
						elseif nNextID ==10308  then AddQuest1(Quest10308,pChar);break;
						elseif nNextID ==10309  then AddQuest1(Quest10309,pChar);break;
						elseif nNextID ==10310  then AddQuest1(Quest10310,pChar);break;
						elseif nNextID ==10311  then AddQuest1(Quest10311,pChar);break;
						elseif nNextID ==10312  then AddQuest1(Quest10312,pChar);break;
						elseif nNextID ==10313  then AddQuest1(Quest10313,pChar);break;
						elseif nNextID ==10314  then AddQuest1(Quest10314,pChar);break;
						elseif nNextID ==10315  then AddQuest1(Quest10315,pChar);break;
						elseif nNextID ==10316  then AddQuest1(Quest10316,pChar);break;
						elseif nNextID ==10317  then AddQuest1(Quest10317,pChar);break;
						elseif nNextID ==10318  then AddQuest1(Quest10318,pChar);break;
						elseif nNextID ==10319  then AddQuest1(Quest10319,pChar);break;
						elseif nNextID ==10320  then AddQuest1(Quest10320,pChar);break;
						elseif nNextID ==10321  then AddQuest1(Quest10321,pChar);break;
						elseif nNextID ==10322  then AddQuest1(Quest10322,pChar);break;
						elseif nNextID ==10323  then AddQuest1(Quest10323,pChar);break;
						elseif nNextID ==10324  then AddQuest1(Quest10324,pChar);break;
						elseif nNextID ==10325  then AddQuest1(Quest10325,pChar);break;
						elseif nNextID ==10326  then AddQuest1(Quest10326,pChar);break;
						elseif nNextID ==10327  then AddQuest1(Quest10327,pChar);break;
						elseif nNextID ==10328  then AddQuest1(Quest10328,pChar);break;
						elseif nNextID ==10329  then AddQuest1(Quest10329,pChar);break;
						elseif nNextID ==10330  then AddQuest1(Quest10330,pChar);break;
						elseif nNextID ==10331  then AddQuest1(Quest10331,pChar);break;
						elseif nNextID ==10332  then AddQuest1(Quest10332,pChar);break;
						elseif nNextID ==10333  then AddQuest1(Quest10333,pChar);break;
						elseif nNextID ==10334  then AddQuest1(Quest10334,pChar);break;
						elseif nNextID ==10335  then AddQuest1(Quest10335,pChar);break;
						elseif nNextID ==10336  then AddQuest1(Quest10336,pChar);break;
						elseif nNextID ==10337  then AddQuest1(Quest10337,pChar);break;
						elseif nNextID ==10338  then AddQuest1(Quest10338,pChar);break;
						elseif nNextID ==10339  then AddQuest1(Quest10339,pChar);break;
						elseif nNextID ==10340  then AddQuest1(Quest10340,pChar);break;
						elseif nNextID ==10341  then AddQuest1(Quest10341,pChar);break;
						elseif nNextID ==10342  then AddQuest1(Quest10342,pChar);break;
						elseif nNextID ==10343  then AddQuest1(Quest10343,pChar);break;
						elseif nNextID ==10344  then AddQuest1(Quest10344,pChar);break;
						elseif nNextID ==10345  then AddQuest1(Quest10345,pChar);break;
						elseif nNextID ==10346  then AddQuest1(Quest10346,pChar);break;
						elseif nNextID ==10347  then AddQuest1(Quest10347,pChar);break;
						elseif nNextID ==10348  then AddQuest1(Quest10348,pChar);break;
						elseif nNextID ==10349  then AddQuest1(Quest10349,pChar);break;
						elseif nNextID ==10350  then AddQuest1(Quest10350,pChar);break;
						elseif nNextID ==10351  then AddQuest1(Quest10351,pChar);break;
						elseif nNextID ==10352  then AddQuest1(Quest10352,pChar);break;
						elseif nNextID ==10353  then AddQuest1(Quest10353,pChar);break;
						elseif nNextID ==10354  then AddQuest1(Quest10354,pChar);break;
						elseif nNextID ==10355  then AddQuest1(Quest10355,pChar);break;
						elseif nNextID ==10356  then AddQuest1(Quest10356,pChar);break;
						elseif nNextID ==10357  then AddQuest1(Quest10357,pChar);break;
						elseif nNextID ==10358  then AddQuest1(Quest10358,pChar);break;
						elseif nNextID ==10359  then AddQuest1(Quest10359,pChar);break;
						elseif nNextID ==10360  then AddQuest1(Quest10360,pChar);break;
						elseif nNextID ==10361  then AddQuest1(Quest10361,pChar);break;
						elseif nNextID ==10362  then AddQuest1(Quest10362,pChar);break;
						elseif nNextID ==10363  then AddQuest1(Quest10363,pChar);break;
						elseif nNextID ==10364  then AddQuest1(Quest10364,pChar);break;
						elseif nNextID ==10365  then AddQuest1(Quest10365,pChar);break;
						elseif nNextID ==10366  then AddQuest1(Quest10366,pChar);break;
						elseif nNextID ==10367  then AddQuest1(Quest10367,pChar);break;
						elseif nNextID ==10368  then AddQuest1(Quest10368,pChar);break;
						elseif nNextID ==10369  then AddQuest1(Quest10369,pChar);break;
						elseif nNextID ==10370  then AddQuest1(Quest10370,pChar);break;
						elseif nNextID ==10371  then AddQuest1(Quest10371,pChar);break;
						elseif nNextID ==10372  then AddQuest1(Quest10372,pChar);break;
						elseif nNextID ==10373  then AddQuest1(Quest10373,pChar);break;
						elseif nNextID ==10374  then AddQuest1(Quest10374,pChar);break;
						elseif nNextID ==10375  then AddQuest1(Quest10375,pChar);break;
						elseif nNextID ==10376  then AddQuest1(Quest10376,pChar);break;
						elseif nNextID ==10377  then AddQuest1(Quest10377,pChar);break;
						elseif nNextID ==10378  then AddQuest1(Quest10378,pChar);break;
						elseif nNextID ==10379  then AddQuest1(Quest10379,pChar);break;
						elseif nNextID ==10380  then AddQuest1(Quest10380,pChar);break;
						elseif nNextID ==10381  then AddQuest1(Quest10381,pChar);break;
						elseif nNextID ==10382  then AddQuest1(Quest10382,pChar);break;
						elseif nNextID ==10383  then AddQuest1(Quest10383,pChar);break;
						elseif nNextID ==10384  then AddQuest1(Quest10384,pChar);break;
						elseif nNextID ==10385  then AddQuest1(Quest10385,pChar);break;
						elseif nNextID ==10386  then AddQuest1(Quest10386,pChar);break;
						elseif nNextID ==10387  then AddQuest1(Quest10387,pChar);break;
						elseif nNextID ==10388  then AddQuest1(Quest10388,pChar);break;
						elseif nNextID ==10389  then AddQuest1(Quest10389,pChar);break;
						elseif nNextID ==10390  then AddQuest1(Quest10390,pChar);break;
						elseif nNextID ==10391  then AddQuest1(Quest10391,pChar);break;
						elseif nNextID ==10392  then AddQuest1(Quest10392,pChar);break;
						elseif nNextID ==10393  then AddQuest1(Quest10393,pChar);break;
						elseif nNextID ==10394  then AddQuest1(Quest10394,pChar);break;
						elseif nNextID ==10395  then AddQuest1(Quest10395,pChar);break;
						elseif nNextID ==10396  then AddQuest1(Quest10396,pChar);break;
						elseif nNextID ==10397  then AddQuest1(Quest10397,pChar);break;
						elseif nNextID ==10398  then AddQuest1(Quest10398,pChar);break;
						elseif nNextID ==10399  then AddQuest1(Quest10399,pChar);break;
						elseif nNextID ==10400  then AddQuest1(Quest10400,pChar);break;
						elseif nNextID ==10401  then AddQuest1(Quest10401,pChar);break;
						elseif nNextID ==10402  then AddQuest1(Quest10402,pChar);break;
						elseif nNextID ==10403  then AddQuest1(Quest10403,pChar);break;
						elseif nNextID ==10404  then AddQuest1(Quest10404,pChar);break;
						elseif nNextID ==10405  then AddQuest1(Quest10405,pChar);break;
						elseif nNextID ==10406  then AddQuest1(Quest10406,pChar);break;
						elseif nNextID ==10407  then AddQuest1(Quest10407,pChar);break;
						elseif nNextID ==10408  then AddQuest1(Quest10408,pChar);break;
						elseif nNextID ==10409  then AddQuest1(Quest10409,pChar);break;
						elseif nNextID ==10410  then AddQuest1(Quest10410,pChar);break;
						elseif nNextID ==10411  then AddQuest1(Quest10411,pChar);break;
						elseif nNextID ==10412  then AddQuest1(Quest10412,pChar);break;
						elseif nNextID ==10413  then AddQuest1(Quest10413,pChar);break;
						elseif nNextID ==10414  then AddQuest1(Quest10414,pChar);break;
						elseif nNextID ==10415  then AddQuest1(Quest10415,pChar);break;
						elseif nNextID ==10416  then AddQuest1(Quest10416,pChar);break;
						elseif nNextID ==10417  then AddQuest1(Quest10417,pChar);break;
						elseif nNextID ==10418  then AddQuest1(Quest10418,pChar);break;
						elseif nNextID ==10419  then AddQuest1(Quest10419,pChar);break;
						elseif nNextID ==10420  then AddQuest1(Quest10420,pChar);break;
						elseif nNextID ==10421  then AddQuest1(Quest10421,pChar);break;
						elseif nNextID ==10422  then AddQuest1(Quest10422,pChar);break;
						elseif nNextID ==10423  then AddQuest1(Quest10423,pChar);break;
						elseif nNextID ==10424  then AddQuest1(Quest10424,pChar);break;
						elseif nNextID ==10425  then AddQuest1(Quest10425,pChar);break;
						elseif nNextID ==10426  then AddQuest1(Quest10426,pChar);break;
						elseif nNextID ==10427  then AddQuest1(Quest10427,pChar);break;
						elseif nNextID ==10428  then AddQuest1(Quest10428,pChar);break;
						elseif nNextID ==10429  then AddQuest1(Quest10429,pChar);break;
						elseif nNextID ==10430  then AddQuest1(Quest10430,pChar);break;
						elseif nNextID ==10431  then AddQuest1(Quest10431,pChar);break;
						elseif nNextID ==10432  then AddQuest1(Quest10432,pChar);break;
						elseif nNextID ==10433  then AddQuest1(Quest10433,pChar);break;
						elseif nNextID ==10434  then AddQuest1(Quest10434,pChar);break;
						elseif nNextID ==10435  then AddQuest1(Quest10435,pChar);break;
						elseif nNextID ==10436  then AddQuest1(Quest10436,pChar);break;
						elseif nNextID ==10437  then AddQuest1(Quest10437,pChar);break;
						elseif nNextID ==10438  then AddQuest1(Quest10438,pChar);break;
						elseif nNextID ==10439  then AddQuest1(Quest10439,pChar);break;
						elseif nNextID ==10440  then AddQuest1(Quest10440,pChar);break;
						elseif nNextID ==10441  then AddQuest1(Quest10441,pChar);break;
						elseif nNextID ==10442  then AddQuest1(Quest10442,pChar);break;
						elseif nNextID ==10443  then AddQuest1(Quest10443,pChar);break;
						elseif nNextID ==10444  then AddQuest1(Quest10444,pChar);break;
						elseif nNextID ==10445  then AddQuest1(Quest10445,pChar);break;
						elseif nNextID ==10446  then AddQuest1(Quest10446,pChar);break;
						elseif nNextID ==10447  then AddQuest1(Quest10447,pChar);break;
						elseif nNextID ==10448  then AddQuest1(Quest10448,pChar);break;
						elseif nNextID ==10449  then AddQuest1(Quest10449,pChar);break;
						elseif nNextID ==10450  then AddQuest1(Quest10450,pChar);break;
						elseif nNextID ==10451  then AddQuest1(Quest10451,pChar);break;
						elseif nNextID ==10452  then AddQuest1(Quest10452,pChar);break;
						elseif nNextID ==10453  then AddQuest1(Quest10453,pChar);break;
						elseif nNextID ==10454  then AddQuest1(Quest10454,pChar);break;
						elseif nNextID ==10455  then AddQuest1(Quest10455,pChar);break;
						elseif nNextID ==10456  then AddQuest1(Quest10456,pChar);break;
						elseif nNextID ==10457  then AddQuest1(Quest10457,pChar);break;
						elseif nNextID ==10458  then AddQuest1(Quest10458,pChar);break;
						elseif nNextID ==10459  then AddQuest1(Quest10459,pChar);break;
						elseif nNextID ==10460  then AddQuest1(Quest10460,pChar);break;
						elseif nNextID ==10461  then AddQuest1(Quest10461,pChar);break;
						elseif nNextID ==10462  then AddQuest1(Quest10462,pChar);break;
						elseif nNextID ==10463  then AddQuest1(Quest10463,pChar);break;
						elseif nNextID ==10464  then AddQuest1(Quest10464,pChar);break;
						elseif nNextID ==10465  then AddQuest1(Quest10465,pChar);break;
						elseif nNextID ==10466  then AddQuest1(Quest10466,pChar);break;
						elseif nNextID ==10467  then AddQuest1(Quest10467,pChar);break;
						elseif nNextID ==10468  then AddQuest1(Quest10468,pChar);break;
						elseif nNextID ==10469  then AddQuest1(Quest10469,pChar);break;
						elseif nNextID ==10470  then AddQuest1(Quest10470,pChar);break;
						elseif nNextID ==10471  then AddQuest1(Quest10471,pChar);break;
						elseif nNextID ==10472  then AddQuest1(Quest10472,pChar);break;
						elseif nNextID ==10473  then AddQuest1(Quest10473,pChar);break;
						elseif nNextID ==10474  then AddQuest1(Quest10474,pChar);break;
						elseif nNextID ==10475  then AddQuest1(Quest10475,pChar);break;
						elseif nNextID ==10476  then AddQuest1(Quest10476,pChar);break;
						elseif nNextID ==10477  then AddQuest1(Quest10477,pChar);break;
						elseif nNextID ==10478  then AddQuest1(Quest10478,pChar);break;
						elseif nNextID ==10479  then AddQuest1(Quest10479,pChar);break;
						elseif nNextID ==10480  then AddQuest1(Quest10480,pChar);break;
						elseif nNextID ==10481  then AddQuest1(Quest10481,pChar);break;
						elseif nNextID ==10482  then AddQuest1(Quest10482,pChar);break;
						elseif nNextID ==10483  then AddQuest1(Quest10483,pChar);break;
						elseif nNextID ==10484  then AddQuest1(Quest10484,pChar);break;
						elseif nNextID ==10485  then AddQuest1(Quest10485,pChar);break;
						elseif nNextID ==10486  then AddQuest1(Quest10486,pChar);break;
						elseif nNextID ==10487  then AddQuest1(Quest10487,pChar);break;
						elseif nNextID ==10488  then AddQuest1(Quest10488,pChar);break;
						elseif nNextID ==10489  then AddQuest1(Quest10489,pChar);break;
						elseif nNextID ==10490  then AddQuest1(Quest10490,pChar);break;
						elseif nNextID ==10491  then AddQuest1(Quest10491,pChar);break;
						elseif nNextID ==10492  then AddQuest1(Quest10492,pChar);break;
						elseif nNextID ==10493  then AddQuest1(Quest10493,pChar);break;
						elseif nNextID ==10494  then AddQuest1(Quest10494,pChar);break;
						elseif nNextID ==10495  then AddQuest1(Quest10495,pChar);break;
						elseif nNextID ==10496  then AddQuest1(Quest10496,pChar);break;
						elseif nNextID ==10497  then AddQuest1(Quest10497,pChar);break;
						elseif nNextID ==10498  then AddQuest1(Quest10498,pChar);break;
						elseif nNextID ==10499  then AddQuest1(Quest10499,pChar);break;
						elseif nNextID ==10500  then AddQuest1(Quest10500,pChar);break;
						elseif nNextID ==10501  then AddQuest1(Quest10501,pChar);break;
						elseif nNextID ==10502  then AddQuest1(Quest10502,pChar);break;
						elseif nNextID ==10503  then AddQuest1(Quest10503,pChar);break;
						elseif nNextID ==10504  then AddQuest1(Quest10504,pChar);break;
						elseif nNextID ==10505  then AddQuest1(Quest10505,pChar);break;
						elseif nNextID ==10506  then AddQuest1(Quest10506,pChar);break;
						elseif nNextID ==10507  then AddQuest1(Quest10507,pChar);break;
						elseif nNextID ==10508  then AddQuest1(Quest10508,pChar);break;
						elseif nNextID ==10509  then AddQuest1(Quest10509,pChar);break;
						elseif nNextID ==10510  then AddQuest1(Quest10510,pChar);break;
						elseif nNextID ==10511  then AddQuest1(Quest10511,pChar);break;
						elseif nNextID ==10512  then AddQuest1(Quest10512,pChar);break;
						elseif nNextID ==10513  then AddQuest1(Quest10513,pChar);break;
						elseif nNextID ==10514  then AddQuest1(Quest10514,pChar);break;
						elseif nNextID ==10515  then AddQuest1(Quest10515,pChar);break;
						elseif nNextID ==10516  then AddQuest1(Quest10516,pChar);break;
						elseif nNextID ==10517  then AddQuest1(Quest10517,pChar);break;
						elseif nNextID ==10518  then AddQuest1(Quest10518,pChar);break;
						elseif nNextID ==10519  then AddQuest1(Quest10519,pChar);break;
						elseif nNextID ==10520  then AddQuest1(Quest10520,pChar);break;
						elseif nNextID ==10521  then AddQuest1(Quest10521,pChar);break;
						elseif nNextID ==10522  then AddQuest1(Quest10522,pChar);break;
						elseif nNextID ==10523  then AddQuest1(Quest10523,pChar);break;
						elseif nNextID ==10524  then AddQuest1(Quest10524,pChar);break;
						elseif nNextID ==10525  then AddQuest1(Quest10525,pChar);break;
						elseif nNextID ==10526  then AddQuest1(Quest10526,pChar);break;
						elseif nNextID ==10527  then AddQuest1(Quest10527,pChar);break;
						elseif nNextID ==10528  then AddQuest1(Quest10528,pChar);break;
						elseif nNextID ==10529  then AddQuest1(Quest10529,pChar);break;
						elseif nNextID ==10530  then AddQuest1(Quest10530,pChar);break;
						elseif nNextID ==10531  then AddQuest1(Quest10531,pChar);break;
						elseif nNextID ==10532  then AddQuest1(Quest10532,pChar);break;
						elseif nNextID ==10533  then AddQuest1(Quest10533,pChar);break;
						elseif nNextID ==10534  then AddQuest1(Quest10534,pChar);break;
						elseif nNextID ==10535  then AddQuest1(Quest10535,pChar);break;
						elseif nNextID ==10536  then AddQuest1(Quest10536,pChar);break;
						elseif nNextID ==10537  then AddQuest1(Quest10537,pChar);break;
						elseif nNextID ==10538  then AddQuest1(Quest10538,pChar);break;
						elseif nNextID ==10539  then AddQuest1(Quest10539,pChar);break;
						elseif nNextID ==10540  then AddQuest1(Quest10540,pChar);break;
						elseif nNextID ==10541  then AddQuest1(Quest10541,pChar);break;
						elseif nNextID ==10542  then AddQuest1(Quest10542,pChar);break;
						elseif nNextID ==10543  then AddQuest1(Quest10543,pChar);break;
						elseif nNextID ==10544  then AddQuest1(Quest10544,pChar);break;
						elseif nNextID ==10545  then AddQuest1(Quest10545,pChar);break;
						elseif nNextID ==10546  then AddQuest1(Quest10546,pChar);break;
						elseif nNextID ==10547  then AddQuest1(Quest10547,pChar);break;
						elseif nNextID ==10548  then AddQuest1(Quest10548,pChar);break;
						elseif nNextID ==10549  then AddQuest1(Quest10549,pChar);break;
						elseif nNextID ==10550  then AddQuest1(Quest10550,pChar);break;
						elseif nNextID ==10551  then AddQuest1(Quest10551,pChar);break;
						elseif nNextID ==10552  then AddQuest1(Quest10552,pChar);break;
						elseif nNextID ==10553  then AddQuest1(Quest10553,pChar);break;
						elseif nNextID ==10554  then AddQuest1(Quest10554,pChar);break;
						elseif nNextID ==10555  then AddQuest1(Quest10555,pChar);break;
						elseif nNextID ==10556  then AddQuest1(Quest10556,pChar);break;
						elseif nNextID ==10557  then AddQuest1(Quest10557,pChar);break;
						elseif nNextID ==10558  then AddQuest1(Quest10558,pChar);break;
						elseif nNextID ==10559  then AddQuest1(Quest10559,pChar);break;
						elseif nNextID ==10560  then AddQuest1(Quest10560,pChar);break;
						elseif nNextID ==10561  then AddQuest1(Quest10561,pChar);break;
						elseif nNextID ==10562  then AddQuest1(Quest10562,pChar);break;
						elseif nNextID ==10563  then AddQuest1(Quest10563,pChar);break;
						elseif nNextID ==10564  then AddQuest1(Quest10564,pChar);break;
						elseif nNextID ==10565  then AddQuest1(Quest10565,pChar);break;
						elseif nNextID ==10566  then AddQuest1(Quest10566,pChar);break;
						elseif nNextID ==10567  then AddQuest1(Quest10567,pChar);break;
						elseif nNextID ==10568  then AddQuest1(Quest10568,pChar);break;
						elseif nNextID ==10569  then AddQuest1(Quest10569,pChar);break;
						elseif nNextID ==10570  then AddQuest1(Quest10570,pChar);break;
						elseif nNextID ==10571  then AddQuest1(Quest10571,pChar);break;
						elseif nNextID ==10572  then AddQuest1(Quest10572,pChar);break;
						elseif nNextID ==10573  then AddQuest1(Quest10573,pChar);break;
						elseif nNextID ==10574  then AddQuest1(Quest10574,pChar);break;
						elseif nNextID ==10575  then AddQuest1(Quest10575,pChar);break;
						elseif nNextID ==10576  then AddQuest1(Quest10576,pChar);break;
						elseif nNextID ==10577  then AddQuest1(Quest10577,pChar);break;
						elseif nNextID ==10578  then AddQuest1(Quest10578,pChar);break;
						elseif nNextID ==10579  then AddQuest1(Quest10579,pChar);break;
						elseif nNextID ==10580  then AddQuest1(Quest10580,pChar);break;
						elseif nNextID ==10581  then AddQuest1(Quest10581,pChar);break;
						elseif nNextID ==10582  then AddQuest1(Quest10582,pChar);break;
						elseif nNextID ==10583  then AddQuest1(Quest10583,pChar);break;
						elseif nNextID ==10584  then AddQuest1(Quest10584,pChar);break;
						elseif nNextID ==10585  then AddQuest1(Quest10585,pChar);break;
						elseif nNextID ==10586  then AddQuest1(Quest10586,pChar);break;
						elseif nNextID ==10587  then AddQuest1(Quest10587,pChar);break;
						elseif nNextID ==10588  then AddQuest1(Quest10588,pChar);break;
						elseif nNextID ==10589  then AddQuest1(Quest10589,pChar);break;
						elseif nNextID ==10590  then AddQuest1(Quest10590,pChar);break;
						elseif nNextID ==10591  then AddQuest1(Quest10591,pChar);break;
						elseif nNextID ==10592  then AddQuest1(Quest10592,pChar);break;
						elseif nNextID ==10593  then AddQuest1(Quest10593,pChar);break;
						elseif nNextID ==10594  then AddQuest1(Quest10594,pChar);break;
						elseif nNextID ==10595  then AddQuest1(Quest10595,pChar);break;
						elseif nNextID ==10596  then AddQuest1(Quest10596,pChar);break;
						elseif nNextID ==10597  then AddQuest1(Quest10597,pChar);break;
						elseif nNextID ==10598  then AddQuest1(Quest10598,pChar);break;
						elseif nNextID ==10599  then AddQuest1(Quest10599,pChar);break;
						elseif nNextID ==10600  then AddQuest1(Quest10600,pChar);break;
						elseif nNextID ==10601  then AddQuest1(Quest10601,pChar);break;
						elseif nNextID ==10602  then AddQuest1(Quest10602,pChar);break;
						elseif nNextID ==10603  then AddQuest1(Quest10603,pChar);break;
						elseif nNextID ==10604  then AddQuest1(Quest10604,pChar);break;
						elseif nNextID ==10605  then AddQuest1(Quest10605,pChar);break;
						elseif nNextID ==10606  then AddQuest1(Quest10606,pChar);break;
						elseif nNextID ==10607  then AddQuest1(Quest10607,pChar);break;
						elseif nNextID ==10608  then AddQuest1(Quest10608,pChar);break;
						elseif nNextID ==10609  then AddQuest1(Quest10609,pChar);break;
						elseif nNextID ==10610  then AddQuest1(Quest10610,pChar);break;
						elseif nNextID ==10611  then AddQuest1(Quest10611,pChar);break;
						elseif nNextID ==10612  then AddQuest1(Quest10612,pChar);break;
						elseif nNextID ==10613  then AddQuest1(Quest10613,pChar);break;
						elseif nNextID ==10614  then AddQuest1(Quest10614,pChar);break;
						elseif nNextID ==10615  then AddQuest1(Quest10615,pChar);break;
						elseif nNextID ==10616  then AddQuest1(Quest10616,pChar);break;
						elseif nNextID ==10617  then AddQuest1(Quest10617,pChar);break;
						elseif nNextID ==10618  then AddQuest1(Quest10618,pChar);break;
						elseif nNextID ==10619  then AddQuest1(Quest10619,pChar);break;
						elseif nNextID ==10620  then AddQuest1(Quest10620,pChar);break;
						elseif nNextID ==10621  then AddQuest1(Quest10621,pChar);break;
						elseif nNextID ==10622  then AddQuest1(Quest10622,pChar);break;
						elseif nNextID ==10623  then AddQuest1(Quest10623,pChar);break;
						elseif nNextID ==10624  then AddQuest1(Quest10624,pChar);break;
						elseif nNextID ==10625  then AddQuest1(Quest10625,pChar);break;
						elseif nNextID ==10626  then AddQuest1(Quest10626,pChar);break;
						elseif nNextID ==10627  then AddQuest1(Quest10627,pChar);break;
						elseif nNextID ==10628  then AddQuest1(Quest10628,pChar);break;
						elseif nNextID ==10629  then AddQuest1(Quest10629,pChar);break;
						elseif nNextID ==10630  then AddQuest1(Quest10630,pChar);break;
						elseif nNextID ==10631  then AddQuest1(Quest10631,pChar);break;
						elseif nNextID ==10632  then AddQuest1(Quest10632,pChar);break;
						elseif nNextID ==10633  then AddQuest1(Quest10633,pChar);break;
						elseif nNextID ==10634  then AddQuest1(Quest10634,pChar);break;
						elseif nNextID ==10635  then AddQuest1(Quest10635,pChar);break;
						elseif nNextID ==10636  then AddQuest1(Quest10636,pChar);break;
						elseif nNextID ==10637  then AddQuest1(Quest10637,pChar);break;
						elseif nNextID ==10638  then AddQuest1(Quest10638,pChar);break;
						elseif nNextID ==10639  then AddQuest1(Quest10639,pChar);break;
						elseif nNextID ==10640  then AddQuest1(Quest10640,pChar);break;
						elseif nNextID ==10641  then AddQuest1(Quest10641,pChar);break;
						elseif nNextID ==10642  then AddQuest1(Quest10642,pChar);break;
						elseif nNextID ==10643  then AddQuest1(Quest10643,pChar);break;
						elseif nNextID ==10644  then AddQuest1(Quest10644,pChar);break;
						elseif nNextID ==10645  then AddQuest1(Quest10645,pChar);break;
						elseif nNextID ==10646  then AddQuest1(Quest10646,pChar);break;
						elseif nNextID ==10647  then AddQuest1(Quest10647,pChar);break;
						elseif nNextID ==10648  then AddQuest1(Quest10648,pChar);break;
						elseif nNextID ==10649  then AddQuest1(Quest10649,pChar);break;
						elseif nNextID ==10650  then AddQuest1(Quest10650,pChar);break;
						elseif nNextID ==10651  then AddQuest1(Quest10651,pChar);break;
						elseif nNextID ==10652  then AddQuest1(Quest10652,pChar);break;
						elseif nNextID ==10653  then AddQuest1(Quest10653,pChar);break;
						elseif nNextID ==10654  then AddQuest1(Quest10654,pChar);break;
						elseif nNextID ==10655  then AddQuest1(Quest10655,pChar);break;
						elseif nNextID ==10656  then AddQuest1(Quest10656,pChar);break;
						elseif nNextID ==10657  then AddQuest1(Quest10657,pChar);break;
						elseif nNextID ==10658  then AddQuest1(Quest10658,pChar);break;
						elseif nNextID ==10659  then AddQuest1(Quest10659,pChar);break;
						elseif nNextID ==10660  then AddQuest1(Quest10660,pChar);break;
						elseif nNextID ==10661  then AddQuest1(Quest10661,pChar);break;
						elseif nNextID ==10662  then AddQuest1(Quest10662,pChar);break;
						elseif nNextID ==10663  then AddQuest1(Quest10663,pChar);break;
						elseif nNextID ==10664  then AddQuest1(Quest10664,pChar);break;
						elseif nNextID ==10665  then AddQuest1(Quest10665,pChar);break;
						elseif nNextID ==10666  then AddQuest1(Quest10666,pChar);break;
						elseif nNextID ==10667  then AddQuest1(Quest10667,pChar);break;
						elseif nNextID ==10668  then AddQuest1(Quest10668,pChar);break;
						elseif nNextID ==10669  then AddQuest1(Quest10669,pChar);break;
						elseif nNextID ==10670  then AddQuest1(Quest10670,pChar);break;
						elseif nNextID ==10671  then AddQuest1(Quest10671,pChar);break;
						elseif nNextID ==10672  then AddQuest1(Quest10672,pChar);break;
						elseif nNextID ==10673  then AddQuest1(Quest10673,pChar);break;
						elseif nNextID ==10674  then AddQuest1(Quest10674,pChar);break;
						elseif nNextID ==10675  then AddQuest1(Quest10675,pChar);break;
						elseif nNextID ==10676  then AddQuest1(Quest10676,pChar);break;
						elseif nNextID ==10677  then AddQuest1(Quest10677,pChar);break;
						elseif nNextID ==10678  then AddQuest1(Quest10678,pChar);break;
						elseif nNextID ==10679  then AddQuest1(Quest10679,pChar);break;
						elseif nNextID ==10680  then AddQuest1(Quest10680,pChar);break;
						elseif nNextID ==10681  then AddQuest1(Quest10681,pChar);break;
						elseif nNextID ==10682  then AddQuest1(Quest10682,pChar);break;
						elseif nNextID ==10683  then AddQuest1(Quest10683,pChar);break;
						elseif nNextID ==10684  then AddQuest1(Quest10684,pChar);break;
						elseif nNextID ==10685  then AddQuest1(Quest10685,pChar);break;
						elseif nNextID ==10686  then AddQuest1(Quest10686,pChar);break;
						elseif nNextID ==10687  then AddQuest1(Quest10687,pChar);break;
						elseif nNextID ==10688  then AddQuest1(Quest10688,pChar);break;
						elseif nNextID ==10689  then AddQuest1(Quest10689,pChar);break;
						elseif nNextID ==10690  then AddQuest1(Quest10690,pChar);break;
						elseif nNextID ==10691  then AddQuest1(Quest10691,pChar);break;
						elseif nNextID ==10692  then AddQuest1(Quest10692,pChar);break;
						elseif nNextID ==10693  then AddQuest1(Quest10693,pChar);break;
						elseif nNextID ==10694  then AddQuest1(Quest10694,pChar);break;
						elseif nNextID ==10695  then AddQuest1(Quest10695,pChar);break;
						elseif nNextID ==10696  then AddQuest1(Quest10696,pChar);break;
						elseif nNextID ==10697  then AddQuest1(Quest10697,pChar);break;
						elseif nNextID ==10698  then AddQuest1(Quest10698,pChar);break;
						elseif nNextID ==10699  then AddQuest1(Quest10699,pChar);break;
						end
					end
				end
			end
			
			pChar:GetQuests():SetFlag(301,1);
		end
	end
--[[	if pChar:GetQuests():GetFlag(40001) == 0 then
		pChar:ResetSystemLetterData()--不能去掉
		pChar:SetSystemLetterItemID(62013,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(1,0,0,0,0,0)		
		pChar:SetSystemLetterTimeLimit(48)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("畅游梦古")--不能为空
		pChar:SetSystemLetterMessage("    本次梦古新增加道具：超级导标旗。\\r    该导标旗可以由玩家自由定制自己需要传送的坐标，并可重复使用，而且其使用次数更是达到了惊人的100次！\\r    在此，特送上30次的“试用导标旗”以供各位玩家体验。需要购买“超级导标旗”的玩家可通过打开商城道具“八锦旗盒”获得，打开时还可以选择自己喜欢的颜色噢~。（PS：杂货铺中也可以买到1次性的高级导标旗。）")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40001,1)
	end]]
	
	--新人奖励邮件
	local Year = LuaI.GetRealYear(LuaI.GetServiceTime())
	local Mon = LuaI.GetRealMonth(LuaI.GetServiceTime())
	local Day = LuaI.GetRealDay(LuaI.GetServiceTime())
	local Hour = LuaI.GetRealHour(LuaI.GetServiceTime())
	if pChar:GetLevel() == 0 then
			if pChar:GetQuests():GetFlag(40003) == 0 then
				--pChar:ResetSystemLetterData()--不能去掉
				pChar:SendSystemLetter(11, 0, 0)
				--pChar:SendSystemLetterData()--不能去掉
				pChar:GetQuests():SetFlag(40003,1)
			end
	end
	--新版本介绍
--[[	local mianjuID = math.random(400223,400225)
	if pChar:GetQuests():GetFlag(40004) == 0 and pChar:GetLevel() >= 15 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(mianjuID,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(1,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(48)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("梦古新玩法")--不能为空
		pChar:SetSystemLetterMessage("    全新篇章的梦古，迎来了很多新的东西！在京城屠娇娇（66,563）处有特殊的易容绝技，在杜桐轩（55,650）处也有便利的商会功能，每周还有学会了四相绝技而四处作恶的十大恶人闹江湖！不仅如此，在此次的新版本中，我们还增加了新的城镇任务：双骄之战（通过春华楼的崔玉真触发）和四相终极BOSS（PS：可通过NPC天纲道长（153,284）前去挑战）！为了让玩家们能更好的体验新版本，还有新的十恶同伴供各位抓取噢！在此特送上一个易容面具供各位体验易容的乐趣！")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40004,1)
	end
	--新年活动邮件提示
	if Year == 2011 and Mon == 2 and Day == 2 then
		if pChar:GetQuests():GetFlag(40005) == 0 and pChar:GetLevel() >= 30 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(0,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(0,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(24)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("新年邮件提示")--不能为空
		pChar:SetSystemLetterMessage("    新年新气象，梦幻古龙也为玩家准备了好玩的新年活动。大年三十晚上（2月2日晚）在城隍庙地图会发放新年红包给广大玩家，希望能送去新年的祝福。同时还能活动许多丰厚的奖励；当晚（大年三十）20:00点至第二天（大年初一）01:00点在城隍庙地图上点燃新年烟花，会有意想不到的收获。（注意：只能在这段时间内在城隍庙地图上燃放烟花，才会有奖励。）")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40005,1)
		end
	end--]]
	--[[if Year == 2011 and Mon == 2 and Day == 3 then
		if pChar:GetQuests():GetFlag(40006) == 0 and pChar:GetLevel() >= 30 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(0,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(0,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(24)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("新年邮件提示")--不能为空
		pChar:SetSystemLetterMessage("    新年新气象，梦幻古龙也为玩家准备了好玩的新年活动。大年初一，也给去玩家游戏中的亲朋好友送去新年的祝福吧。梦幻古龙为各位玩家精心包装了新年贺礼，快快购买送给你们的朋友吧。")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40006,1)
		end
	end
	if Year == 2011 and Mon == 2 and Day == 5 then
		if pChar:GetQuests():GetFlag(40007) == 0 and pChar:GetLevel() >= 30 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(0,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(0,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(24)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("新年邮件提示")--不能为空
		pChar:SetSystemLetterMessage("    新年新气象，梦幻古龙也为玩家准备了好玩的新年活动。江湖中成名大侠自然不是浪得虚名，大年初三就出来在城镇周边视察巡逻，防止歹人进入城镇为非作歹，破坏新年气氛。少侠也去野外看看吧，说不定还能遇见大侠，得到他的送出的祝福呢！")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40007,1)
		end
	end--]]
	--[[if Year == 2011 and Mon == 2 and Day == 6 then
		if pChar:GetQuests():GetFlag(40008) == 0 and pChar:GetLevel() >= 30 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(0,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(0,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(24)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("新年邮件提示")--不能为空
		pChar:SetSystemLetterMessage("    新年新气象，梦幻古龙也为玩家准备了好玩的新年活动。大年初四，一些长久避世的大侠也重现江湖，感受下民间的春节喜庆气氛，他们行踪不定，还得看各位侠士们与这些大侠的缘分了。")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40008,1)
		end
	end--]]
--[[	if Year == 2011 and Mon == 2 and Day == 7 then
		if pChar:GetQuests():GetFlag(40009) == 0 and pChar:GetLevel() >= 30 then
		pChar:ResetSystemLetterData()--不能去掉	
		pChar:SetSystemLetterItemID(0,0,0,0,0,0)
		pChar:SetSystemLetterItemCount(0,0,0,0,0,0)
		pChar:SetSystemLetterTimeLimit(24)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("新年邮件提示")--不能为空
		pChar:SetSystemLetterMessage("    新年新气象，梦幻古龙也为玩家准备了好玩的新年活动。大年初五，梦幻古龙在各大城镇留下宝箱，期待有缘人拾取，祝福广大玩家在新的一年更加开心。")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(40009,1)
		end
	end--]]
	--四相附魔符
	--[[if pChar:GetQuests():GetFlag(1007) == 0 and pChar:GetLevel() >= 30  then
		pChar:ResetSystemLetterData()--不能去掉
		pChar:SetSystemLetterItemID(61900,61901,61902,61903,0,0)
		pChar:SetSystemLetterItemCount(5,5,5,5,0,0)		
		pChar:SetSystemLetterTimeLimit(48)
		pChar:SetSystemLetterSender("紫界")--不能为空
		pChar:SetSystemLetterTitle("畅游梦古")--不能为空
		pChar:SetSystemLetterMessage("   在新资料片《十大恶人》中，不少江湖侠客包括十大恶人、十二星象、江别鹤等均已习得四相绝学，大侠们若想畅游梦古，则四相附魔符不可不备。\\r    在此，先送上这些“四相附魔符”以供各位玩家体验。“四相附魔符”可以通过帮派里的四相任务以及新活动“十恶闹江湖”中获得。")--不能为空
		pChar:SendSystemLetterData()--不能去掉
		pChar:GetQuests():SetFlag(1007,1)
	end--]]
	--角色双倍经验日卡（温玉）
	if pChar:HasBuff(22003) then
		if pChar:GetQuests():TimeMarkOver(30000, 1440) == true  then 
			--离线1天
			if pChar:HasBuff(22003) then
				ShowError("温玉效果已消失")
				pChar:RemoveBuff(22003)	
				pChar:GetQuests():RemoveTimeMark(30000)					
			end	
		end		
	end	
	--角色三倍经验日卡（血玉）
	if pChar:HasBuff(22004) then
		if pChar:GetQuests():TimeMarkOver(30001, 1440) == true  then
			--离线1天
			if pChar:HasBuff(22004) then
				ShowError("血玉效果已消失")
				pChar:RemoveBuff(22004)	
				pChar:GetQuests():RemoveTimeMark(30001)			
			end	
		end	
	end	
	--同伴双倍日卡（火玉）
	if pChar:HasBuff(22005) then
		if pChar:GetQuests():TimeMarkOver(30002, 1440) == true  then
			--离线1天
			if pChar:HasBuff(22005) then
				ShowError("火玉效果已消失")
				pChar:RemoveBuff(22005)	
				pChar:GetQuests():RemoveTimeMark(30002)			
			end	
		end	
	end	
	--角色双倍周卡（千年温玉）
	if pChar:HasBuff(22006) then
		if pChar:GetQuests():TimeMarkOver(30003, 10080) == true  then
			--离线7天
			if pChar:HasBuff(22006) then
				ShowError("千年温玉效果已消失")
				pChar:RemoveBuff(22006)	
				pChar:GetQuests():RemoveTimeMark(30003)			
			end	
		end	
	end
	--角色三倍周卡（千年血玉）
	if pChar:HasBuff(22007) then
		if pChar:GetQuests():TimeMarkOver(30004, 10080) == true  then
			--离线7天
			if pChar:HasBuff(22007) then
				ShowError("千年血玉效果已消失")
				pChar:RemoveBuff(22007)	
				pChar:GetQuests():RemoveTimeMark(30004)			
			end	
		end	
	end	
	--同伴双倍周卡（千年火玉）
	if pChar:HasBuff(22008) then
		if pChar:GetQuests():TimeMarkOver(30005, 10080) == true  then
			--离线7天
			if pChar:HasBuff(22008) then
				ShowError("千年火玉效果已消失")
				pChar:RemoveBuff(22008)	
				pChar:GetQuests():RemoveTimeMark(30005)			
			end	
		end	
	end	
end

function OnCharacterLeave(pChar) -------角色离线处理
	--pChar:GetQuests():SetTimeMark(40000)
	local ctm = 0
	if pChar:GetMobID() == 0 then
	  for bf = 50001 , 50055 do
		 if pChar:HasBuff(bf) then
			if bf == 50000 then ctm = 740;
			elseif bf == 50001 then ctm = 741;
			elseif bf == 50002 then ctm = 742;
			elseif bf == 50003 then ctm = 743;
			elseif bf == 50004 then ctm = 744;
			elseif bf == 50005 then ctm = 756;
			elseif bf == 50006 then ctm = 761;
			elseif bf == 50007 then ctm = 762;
			elseif bf == 50008 then ctm = 763;
			elseif bf == 50009 then ctm = 750;
			elseif bf == 50010 then ctm = 746;
			elseif bf == 50011 then ctm = 755;
			elseif bf == 50012 then ctm = 751;
			elseif bf == 50013 then ctm = 767;
			elseif bf == 50014 then ctm = 748;
			elseif bf == 50015 then ctm = 754;
			elseif bf == 50016 then ctm = 772;
			elseif bf == 50017 then ctm = 753;
			elseif bf == 50018 then ctm = 766;
			elseif bf == 50019 then ctm = 757;
			elseif bf == 50020 then ctm = 768;
			elseif bf == 50021 then ctm = 769;
			elseif bf == 50022 then ctm = 771;
			elseif bf == 50023 then ctm = 789;
			elseif bf == 50024 then ctm = 788;
			elseif bf == 50025 then ctm = 770;
			elseif bf == 50026 then ctm = 764;
			elseif bf == 50027 then ctm = 765;
			elseif bf == 50028 then ctm = 760;
			elseif bf == 50029 then ctm = 752;
			elseif bf == 50030 then ctm = 747;
			elseif bf == 50031 then ctm = 759;
			elseif bf == 50032 then ctm = 777;
			elseif bf == 50033 then ctm = 780;
			elseif bf == 50034 then ctm = 758;
			elseif bf == 50035 then ctm = 773;
			elseif bf == 50036 then ctm = 775;
			elseif bf == 50037 then ctm = 779;
			elseif bf == 50038 then ctm = 774;
			elseif bf == 50039 then ctm = 787;
			elseif bf == 50040 then ctm = 749;
			elseif bf == 50041 then ctm = 776;
			elseif bf == 50042 then ctm = 781;
			elseif bf == 50043 then ctm = 785;
			elseif bf == 50044 then ctm = 784;
			elseif bf == 50045 then ctm = 786;
			elseif bf == 50046 then ctm = 782;
			elseif bf == 50047 then ctm = 783;
			elseif bf == 50048 then ctm = 778;
			elseif bf == 50049 then ctm = 790;
			elseif bf == 50050 then ctm = 791;
			elseif bf == 50051 then ctm = 792;
			elseif bf == 50052 then ctm = 793;
			elseif bf == 50053 then ctm = 794;	
			elseif bf == 50054 then ctm = 795;	
			elseif bf == 50055 then ctm = 796;			
			end
			pChar:ChangeToMob(ctm,1)
			break
		 end
	  end
	end
	
	if pChar:GetMap_id() == 60310 then
		local OwnerID = pChar:GetMap():GetOwner_id()
		local Num = pChar:GetQuests():GetNpcFlag(300482,0,OwnerID)
		pChar:GetQuests():SetNpcFlag(300482,0,OwnerID,Num-1)
		if Num == 1 then--蹴鞠场人数为0，将该蹴鞠场设定为结束状态
			pChar:GetQuests():SetNpcFlag(300482,OwnerID,3,0)
		end
		if pChar:HasBuff(20000) then--清除属性buff
			if pChar:GetQuests():GetFlag(7000) == 1 then
				pChar:GetQuests():SetNpcFlag(300472,OwnerID,0,0)
			elseif pChar:GetQuests():GetFlag(7000) == 2 then
				pChar:GetQuests():SetNpcFlag(300477,OwnerID,0,0)
			end
		elseif pChar:HasBuff(20001) then
			if pChar:GetQuests():GetFlag(7000) == 1 then
				pChar:GetQuests():SetNpcFlag(300473,OwnerID,0,0)
			elseif pChar:GetQuests():GetFlag(7000) == 2 then
				pChar:GetQuests():SetNpcFlag(300478,OwnerID,0,0)
			end
		elseif pChar:HasBuff(20002) then
			if pChar:GetQuests():GetFlag(7000) == 1 then
				pChar:GetQuests():SetNpcFlag(300474,OwnerID,0,0)
			elseif pChar:GetQuests():GetFlag(7000) == 2 then
				pChar:GetQuests():SetNpcFlag(300479,OwnerID,0,0)
			end
		elseif pChar:HasBuff(20003) then
			if pChar:GetQuests():GetFlag(7000) == 1 then
				pChar:GetQuests():SetNpcFlag(300475,OwnerID,0,0)
			elseif pChar:GetQuests():GetFlag(7000) == 2 then
				pChar:GetQuests():SetNpcFlag(300480,OwnerID,0,0)
			end
		elseif pChar:HasBuff(20004) then
			if pChar:GetQuests():GetFlag(7000) == 1 then
				pChar:GetQuests():SetNpcFlag(300476,OwnerID,0,0)
			elseif pChar:GetQuests():GetFlag(7000) == 2 then
				pChar:GetQuests():SetNpcFlag(300481,OwnerID,0,0)
			end
		end
		if pChar:GetQuests():GetFlag(7000) == 1 then
			pChar:GetQuests():SetNpcFlag(300482,OwnerID,1,0)
		elseif pChar:GetQuests():GetFlag(7000) == 2 then
			pChar:GetQuests():SetNpcFlag(300482,OwnerID,2,0)
		end
		pChar:GetQuests():SetFlag(7000,0)
	end
	
	
	
end

--玩家升级时的脚本处理
function CanLevelUp(pChar)
	local result = 1
	local OnMap = pChar:GetMap_id()
	if OnMap == 40404 or OnMap == 40405 or OnMap == 40406 or OnMap == 40407 then
		pChar:GetScript():ShowHint("角色在此场景无法升级");
		result = 0;
	end
	
	LuaI.SetTempResult(result);
	if result == 1 then
		-------升级寄信 说明
		local letID = pChar:GetLevel() + 11
		--pChar:ResetSystemLetterData()--不能去掉
		--[[if pChar:GetLevel() == 0 and pChar:GetQuests():GetFlag(40005) == 0 then
			pChar:SendSystemLetter(letID, 0, 0)
			pChar:GetQuests():SetFlag(40005,1)
		end]]
		if letID >11 and letID <= 27 then    --玩家等级1-9级时，每次经验增加，程序都会重复执行此段函数，所以会造成重复寄信。
			if pChar:GetLevel() > pChar:GetQuests():GetFlag(40004) then	
				pChar:SendSystemLetter(letID, 0, 0)
				pChar:GetQuests():SetFlag(40004,pChar:GetLevel())
			end
		elseif letID >28 and letID < 40 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID == 41 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID == 43 then 
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID > 44 and letID < 48 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID > 48 and letID < 51 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID == 52 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID > 53 and letID < 69 then
			pChar:SendSystemLetter(letID, 0, 0)
		elseif letID == 70 or letID == 80 or letID == 90 then
			pChar:SendSystemLetter(letID, 0, 0)
		end
		--pChar:SendSystemLetterData()--不能去掉
	end
	
end


--[[
gem id:

	id				level		type		bound	name
	60011 ~ 60020	1 ~ 10		atk			N		玛瑙石
	60401 ~ 60410	1 ~ 10		atk			Y
	60711 ~ 60720	1 ~ 10		atk			N		无暇玛瑙石
	60801 ~ 60810	1 ~ 10		atk			Y

	60021 ~ 60030	1 ~ 10		def			N		紫水晶
	60411 ~ 60420	1 ~ 10		def			Y
	60721 ~ 60730	1 ~ 10		def			N		无暇紫水晶
	60811 ~ 60820	1 ~ 10		def			Y

	60031 ~ 60040	1 ~ 10		hit			N		黄晶玉
	60421 ~ 60430	1 ~ 10		hit			Y
	60731 ~ 60740	1 ~ 10		hit			N		无暇黄晶玉
	60821 ~ 60830	1 ~ 10		hit			Y

	60041 ~ 60050	1 ~ 10		eva			N		天青石
	60431 ~ 60440	1 ~ 10		eva			Y
	60741 ~ 60750	1 ~ 10		eva			N		无暇天青石
	60831 ~ 60840	1 ~ 10		eva			Y

	60051 ~ 60060	1 ~ 10		pow			N		蓝宝石
	60441 ~ 60450	1 ~ 10		pow			Y
	60751 ~ 60760	1 ~ 10		pow			N		无暇蓝宝石
	60841 ~ 60850	1 ~ 10		pow			Y

	60061 ~ 60070	1 ~ 10		spd			N		绿翡翠
	60451 ~ 60460	1 ~ 10		spd			Y
	60761 ~ 60770	1 ~ 10		spd			N		无暇绿翡翠
	60851 ~ 60860	1 ~ 10		spd			Y

	60071 ~ 60080	1 ~ 10		maxHp		N		红宝石
	60461 ~ 60470	1 ~ 10		maxHp		Y
	60771 ~ 60780	1 ~ 10		maxHp		N		无暇红宝石
	60861 ~ 60870	1 ~ 10		maxHp		Y

	60081 ~ 60090	1 ~ 10		maxSp		N		夜明珠
	60471 ~ 60480	1 ~ 10		maxSp		Y
	60781 ~ 60790	1 ~ 10		maxHp		N		无暇夜明珠
	60871 ~ 60880	1 ~ 10		maxHp		Y
	
	------------------------------------------
	60301 ~ 60310	1 ~ 10		镶嵌符
	------------------------------------------
	60311 ~ 60320	1 ~ 10		摘除符
	------------------------------------------
	60601 - 60610	1 ~ 10		抛光石
	60611 ~ 60620	1 ~ 10
	------------------------------------------
]]--

function GetGemItemLevel(GemItemId)
	local GemItemLevel = math.fmod(GemItemId, 10);
	if GemItemLevel == 0 then
		GemItemLevel = 10;
	end
	if GemItemLevel < 1 or GemItemLevel > 10 then
		GemItemLevel = 1;
	end
	LuaI.SetTempResult(GemItemLevel);
	return GemItemLevel;
end

function GetSoulBoundGemItemId(GemItemId)
	if GemItemId >= 60011 and GemItemId <= 60090 then
		GemItemId = GemItemId ;
	end
	
	if GemItemId >= 60711 and GemItemId <= 60790 then
		GemItemId = GemItemId ;
	end
	
	if GemItemId >= 82001 and GemItemId <= 82160 then
		GemItemId = GemItemId ;
	end
	
	LuaI.SetTempResult(GemItemId);
	return GemItemId;
end

function GetGemMixConsumeMoney(GemItemId)
	local GemItemLevel = GetGemItemLevel(GemItemId);
	local ConsumeMoney = 20000 * GemItemLevel;
	LuaI.SetTempResult(ConsumeMoney);
	return ConsumeMoney;
end

function GetGemInlayConsumeMoney(EqItemLv)
	local ConsumeMoney = 200 * EqItemLv;
	LuaI.SetTempResult(ConsumeMoney);
	return ConsumeMoney;
end

function GetGemRemoveConsumeMoney(EqItemLv)
	local ConsumeMoney = 200 * EqItemLv;
	LuaI.SetTempResult(ConsumeMoney);
	return ConsumeMoney;
end

function CheckGemMixItemId(FirstItemId, NewItemId, ItemLock)

	if ItemLock == true then
		LuaI.SetTempResult(1); -- 已上锁的宝石不可以进行合成
		return ;
	end
	
	-- max level gem can not mix
	local GemItemLevel = GetGemItemLevel(NewItemId);
	if GemItemLevel >= 5 then
		LuaI.SetTempResult(2); -- 宝石已经是最大等级
		return ;
	end

	if FirstItemId == 0 or FirstItemId == NewItemId then
		LuaI.SetTempResult(0); -- ok
		return ;
	end
	
	-- 60011 (unbound id) == 60401 (bound id), 60012 == 60402 ...
	if FirstItemId > NewItemId then
		if FirstItemId >= 60401 and FirstItemId <= 60480 and FirstItemId - 390 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		elseif FirstItemId >= 60801 and FirstItemId <= 60880 and FirstItemId - 90 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		elseif FirstItemId >= 82201 and FirstItemId <= 82360 and FirstItemId - 200 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		else
			LuaI.SetTempResult(3); -- 必须为同等级同类型的宝石才可以进行合成
			return ;
		end
	elseif FirstItemId < NewItemId then 
		if FirstItemId >= 60011 and FirstItemId <= 60090 and FirstItemId + 390 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		elseif FirstItemId >= 60711 and FirstItemId <= 60790 and FirstItemId + 90 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		elseif FirstItemId >= 82001 and FirstItemId <= 82160 and FirstItemId + 200 == NewItemId then
			LuaI.SetTempResult(0); -- ok
			return ;
		else
			LuaI.SetTempResult(3); -- 必须为同等级同类型的宝石才可以进行合成
			return ;
		end
	else
		LuaI.SetTempResult(3); -- 必须为同等级同类型的宝石才可以进行合成
		return ;
	end
	
	LuaI.SetTempResult(5); -- 未知错误
end

function CheckGemMeltingGemItem(GemItemId, ItemLock)
	local Re = 0;
	
	if ItemLock == true then
		Re = 1; -- 已锁定的宝石不能熔炼
	else
		if GemItemId == 60011 or GemItemId == 60012
		or GemItemId == 60401 or GemItemId == 60402
		or GemItemId == 60021 or GemItemId == 60022
		or GemItemId == 60411 or GemItemId == 60412
		or GemItemId == 60031 or GemItemId == 60032
		or GemItemId == 60421 or GemItemId == 60422
		or GemItemId == 60041 or GemItemId == 60042
		or GemItemId == 60431 or GemItemId == 60432
		or GemItemId == 60051 or GemItemId == 60052
		or GemItemId == 60441 or GemItemId == 60442
		or GemItemId == 60061 or GemItemId == 60062
		or GemItemId == 60451 or GemItemId == 60452
		or GemItemId == 60071 or GemItemId == 60072
		or GemItemId == 60461 or GemItemId == 60462
		or GemItemId == 60081 or GemItemId == 60082
		or GemItemId == 60471 or GemItemId == 60472
		or GemItemId == 82001 or GemItemId == 82002
		or GemItemId == 82201 or GemItemId == 82202
		or GemItemId == 82011 or GemItemId == 82012
		or GemItemId == 82211 or GemItemId == 82212
		or GemItemId == 82021 or GemItemId == 82022
		or GemItemId == 82221 or GemItemId == 82222
		or GemItemId == 82031 or GemItemId == 82032
		or GemItemId == 82231 or GemItemId == 82232
		or GemItemId == 82041 or GemItemId == 82042
		or GemItemId == 82241 or GemItemId == 82242
		or GemItemId == 82051 or GemItemId == 82052
		or GemItemId == 82251 or GemItemId == 82252
		or GemItemId == 82061 or GemItemId == 82062
		or GemItemId == 82261 or GemItemId == 82262
		or GemItemId == 82071 or GemItemId == 82072
		or GemItemId == 82271 or GemItemId == 82272
		or GemItemId == 82081 or GemItemId == 82082
		or GemItemId == 82281 or GemItemId == 82282
		or GemItemId == 82091 or GemItemId == 82092
		or GemItemId == 82291 or GemItemId == 82292
		or GemItemId == 82101 or GemItemId == 82102
		or GemItemId == 82301 or GemItemId == 82302
		or GemItemId == 82111 or GemItemId == 82112
		or GemItemId == 82311 or GemItemId == 82312
		or GemItemId == 82121 or GemItemId == 82122
		or GemItemId == 82321 or GemItemId == 82322
		or GemItemId == 82131 or GemItemId == 82132
		or GemItemId == 82331 or GemItemId == 82332
		or GemItemId == 82141 or GemItemId == 82142
		or GemItemId == 82341 or GemItemId == 82342
		or GemItemId == 82151 or GemItemId == 82152
		or GemItemId == 82351 or GemItemId == 82352 then
			Re = 0; -- ok
		else
			Re = 2; -- 此宝石不能熔炼
		end
	end
	
	LuaI.SetTempResult(Re);
end

function GetGemMeltingConsumeMoney(GemItemId)
	local GemItemLevel = GetGemItemLevel(GemItemId);
	local ConsumeMoney = GemItemLevel * 1000;
	LuaI.SetTempResult(ConsumeMoney);
	return ConsumeMoney;
end

function CheckGemPolishingGemItem(GemItemId, ItemLock)
	local Re = 0;
	
	if ItemLock == true then
		Re = 1; -- 已锁定的宝石不能抛光
	else
		if (GemItemId >= 60011 and GemItemId <= 60020) or (GemItemId >= 60401 and GemItemId <= 60410) then
			Re = 0;
		elseif (GemItemId >= 60021 and GemItemId <= 60030) or (GemItemId >= 60411 and GemItemId <= 60420) then
			Re = 0;
		elseif (GemItemId >= 60031 and GemItemId <= 60040) or (GemItemId >= 60421 and GemItemId <= 60430) then
			Re = 0;
		elseif (GemItemId >= 60041 and GemItemId <= 60050) or (GemItemId >= 60431 and GemItemId <= 60440) then
			Re = 0;
		elseif (GemItemId >= 60051 and GemItemId <= 60060) or (GemItemId >= 60441 and GemItemId <= 60450) then
			Re = 0;
		elseif (GemItemId >= 60061 and GemItemId <= 60070) or (GemItemId >= 60451 and GemItemId <= 60460) then
			Re = 0;
		elseif (GemItemId >= 60071 and GemItemId <= 60080) or (GemItemId >= 60461 and GemItemId <= 60470) then
			Re = 0;
		elseif (GemItemId >= 60081 and GemItemId <= 60090) or (GemItemId >= 60471 and GemItemId <= 60480) then
			Re = 0;
		else
			Re = 2; -- 此宝石不能抛光
		end
	end
	
	LuaI.SetTempResult(Re);
end

function IsGemPolishingConsumeItem(ConsumeItemId)
	if ConsumeItemId >= 60601 and ConsumeItemId <= 60610 then
		return true;
	elseif ConsumeItemId >= 60611 and ConsumeItemId <= 60620 then
		return true;
	else
		return false;
	end
end

function CheckGemPolishingConsumeItem(GemItemId, ConsumeItemId)
	local Re = 0;
	
	if GemItemId == 0 then
		Re = 1; -- 请先放入宝石
	else
		if IsGemPolishingConsumeItem(ConsumeItemId) then
			local ConsumeItemLevel = GetGemItemLevel(ConsumeItemId);
			local GemItemLevel = GetGemItemLevel(GemItemId);
			
			if ConsumeItemLevel >= GemItemLevel then
				Re = 0;
			else
				Re = 3; -- 放入的抛光石等级需大于等于宝石的等级
			end
		else
			Re = 2; -- 请放入抛光石
		end
	end
	
	LuaI.SetTempResult(Re);
end

function GetGemPolishingConsumeMoney(GemItemId)
	local GemItemLevel = GetGemItemLevel(GemItemId);
	local ConsumeMoney = GemItemLevel * 1000;
	LuaI.SetTempResult(ConsumeMoney);
	return ConsumeMoney;
end

function GetGemPolishingResultGemItemId(GemItemId, Bound)
	local ResultGemItemId = 0;
	
	if GemItemId >= 60011 and GemItemId <= 60090 then -- unbound
		ResultGemItemId = GemItemId + 700;
		if Bound then
			ResultGemItemId = ResultGemItemId + 90;
		end
	elseif GemItemId >= 60401 and GemItemId <= 60480 then -- bound
		ResultGemItemId = GemItemId + 400;
	end
	
	LuaI.SetTempResult(ResultGemItemId);
end

--玩家结拜后的脚本处理
function OnCreateSiblingResult(pChar,result)
	local party = pChar:GetParty()
	if result then
		for i = 0, party:GetCount() - 1 do
			local member = party:GetMember(i)
			if member then
				for j = 0, party:GetCount() - 1 do
					local member1 = party:GetMember(j)
					if member1 and member1:GetQuests():GetFlag(4) == 1 then						
						if  member1:GetItems():GetItemCount(51092) < 1 then		
							for k = 0, party:GetCount() - 1 do
								local member3 = party:GetMember(k)
								local relationSystem = member3:GetRelationSystem();
								relationSystem:RemoveSibling(member3:GetChar_id());
								member3:GetScript():ShowHint("队伍中有成员友好度未达1000，或未持有投名状，结义失败。")
							end
							return
						end
					end
				end
			end
					
			if member and member:GetChar_id() == pChar:GetChar_id() then
				member:ChangeMoneyForScript(-1000000,14000)
			end
			
			if member and member:GetQuests():GetFlag(4) == 1 then
				member:GetItems():RemoveItem(51092,1)
				member:GetQuests():RemoveFlag(4)
			end
			member:GetScript():ShowHint("恭喜各位义结金兰，愿你们永远同心同德，祸福同享，患难与共!")
		end
		--pChar:ChangeMoney(-200000)
		--pChar:GetScript():ShowError("\#W结拜成功..")
		
		--[[pChar:GetScript():Rumor("恭喜义结金兰，愿他们永远同心同德，祸福同享，患难与共。", false)
		local membername = ""; --获取队伍中所有成员的名字
		for i = 0, party:GetCount() - 1 do
		script:SetSaying(true)
			--pChar:GetScript():ShowError("\#Wjijiji!");
			local member = party:GetMember(i)
			if member then
				--pChar:GetScript():ShowError("\#W...!");
				membername = string.format("%s %s", membername, member:GetName()); --在队伍中循环，每多一个人，则多循环一次，名字+1
				NpcSayParty("恭喜各位义结金兰？")
			end
		end
		pChar:GetScript():Rumor(string.format("恭喜\#W%s\#O义结金兰，愿他们永远同心同德，祸福同享，患难与共。", membername), false)]]--
	else
		pChar:GetScript():ShowError("\#W很抱歉，结拜失败！")
	end
end
--玩家修改结拜称号后的脚本处理
function OnSetSiblingTitleSuffixResult(pChar,result)
	if result then
		pChar:ChangeMoneyForScript(-100000,14001);
		pChar:GetScript():ShowError("\#W修改结拜称号成功!");
	else
		pChar:GetScript():ShowError("\#W修改结拜称号失败!");
	end
end
--玩家坐牢
function OnCharacterImprison(pChar)
	local pkValue = pChar:GetPK_Value();
	local SJ = pkValue*500+pChar:GetWantedReward();
	if pkValue >= 1 then
		pChar:AddBuff(275, 0, 0, 0, pkValue*30, 100);
		pChar:GetQuests():SetFlag(406,1)
		pChar:GetQuests():SetFlag(48484,1)
		pChar:JumpMap(252,30,50);
		if pkValue >= 6 then
			pChar:GetQuests():SetFlag(405,SJ);
			LuaI.SetTempResult(1);--传闻
			return;
		end 
	end	
	LuaI.SetTempResult(0);
end
--玩家普通PK死亡后的处理
--team==1 主动方;0 被动方
function OnCharacterPKDeadPenalty(pChar,team)
	-- pChar:GetScript():ShowError(string.format("\#W普通PK死亡后的处理!!team == %d",team));
end
--玩家强制PK死亡后的处理
--team==1 主动方;0 被动方
function OnCharacterForcePKDeadPenalty(pChar,team)	
	--[[if team == 0 then--被动方死亡加保护时间
		if pChar:GetEnablePK() == false then
			pChar:GetScript():ShowError("\#W进入PK受保护时间，6小时内不会再被强P");
			pChar:GetQuests():SetTimeMark(401)
		end
	end	--]]
end

--玩家普通PK胜利后的处理
--team==1 主动方;0 被动方
--killCount 杀人个数
function OnCharacterPKWinReward(pChar,team,killCount)
	--pChar:GetScript():ShowError(string.format("\#W普通PK胜利后的处理!!team == %d",team));
end
--玩家强制PK胜利后的处理
--team==1 主动方;0 被动方
--killCount 杀人个数
function OnCharacterForcePKWinReward(pChar,team,killCount)
--[[	if team == 1 then
		if pChar:GetEnablePK() == true then
			if pChar:GetPK_Value() > 15 then
				if pChar:HasTitle(650) == false then
					pChar:RemoveTitle(651)	
					pChar:RemoveTitle(652)	
					pChar:AddTitle(650)				
				end	
			elseif pChar:GetPK_Value() > 10 then
				if pChar:HasTitle(651) == false then
					pChar:RemoveTitle(652)
					pChar:AddTitle(651)	
				end	
			elseif pChar:GetPK_Value() > 5 then
				if pChar:HasTitle(652) == false then
					pChar:AddTitle(652)		
				end			
			end	
		end		
	end--]]
	--pChar:GetScript():ShowError(string.format("\#W强制PK胜利后的处理!!pChar:GetPK_Value() == %d",pChar:GetPK_Value()));
end

--朝廷缉拿战斗ID
function GetWantedBattleNpcId(pChar)
	local pkValue = pChar:GetPK_Value();
	local R = math.random(1, 100);
	if pkValue > 15 then
		LuaI.SetTempResult(804);	
		return
	elseif pkValue > 10 then
		if  R > 70 then
			LuaI.SetTempResult(804);
			return
		end
	elseif pkValue > 5 then
		if  R > 90 then
			LuaI.SetTempResult(804);
			return
		end
	end	
	LuaI.SetTempResult(0);
end
--劫狱
function OnCharacterJailDelivery(pChar,pTarget)
	if pChar and pTarget then
		if pTarget:GetMap_id() == 252 and pTarget:GetQuests():GetFlag(406) == 1 then 
			if pTarget:CanJumpMap()  == false then 
				pChar:GetScript():ShowError("劫狱目标繁忙中，无法劫狱");
				LuaI.SetTempResult(0);
				return
			end
			pTarget:GetQuests():RemoveFlag(406)
			pTarget:RemoveBuff(275)
			pTarget:JumpMap(34,228,406,0,0,0,false);
			pChar:GetQuests():RemoveFlag(404) 
			pChar:GetQuests():RemoveTimeMark(404)	
			LuaI.SetTempResult(1);
			pChar:GetScript():ShowError("劫狱成功");
			return;
		else
			pChar:GetScript():ShowError("本线天牢囚犯中查无此人");
		end
	else
		pChar:GetScript():ShowError("本线天牢囚犯中查无此人");
	end
	LuaI.SetTempResult(0);
end
--保释
function OnCharacterWantedBail(pChar,pTarget)
	if pChar and pTarget then
		local pkValue = pTarget:GetPK_Value()
		local Money = pChar:GetMoney()
		if pTarget:GetMap_id() == 252 and pTarget:GetQuests():GetFlag(406) == 1 then 
			if pTarget:CanJumpMap() == false then 
				pChar:GetScript():ShowError("保释目标繁忙中，无法保释");
				LuaI.SetTempResult(0);
				return
			end
			if pkValue <= 5 then
				if	Money >= pkValue * 200000 then		
					pChar:ChangeMoneyForScript(-pkValue * 200000,14002)
					pTarget:GetQuests():RemoveFlag(406)
					pTarget:RemoveBuff(275)
					pTarget:JumpMap(34,228,406,0,0,0,false);
					pChar:GetScript():ShowError(string.format("你使用了%d银两保释了你的朋友，够义气啊！",pkValue * 200000));
					LuaI.SetTempResult(1);
					return;
				else
					pChar:GetScript():ShowError(string.format("保释此犯人需要银两%d，你的银两不足无法保释。",pkValue * 200000));
				end
	        elseif pkValue <= 20 then
				local SJ = pTarget:GetQuests():GetFlag(405);
				if	Money >= pkValue * 200000 then
					pTarget:GetQuests():RemoveFlag(406)
					pTarget:RemoveBuff(275)
					pTarget:JumpMap(34,228,406,0,0,0,false);
					pChar:ChangeMoneyForScript(-(SJ + pkValue * 200000),14002)		
					pChar:GetScript():ShowError(string.format("你使用了%d银两保释了你的朋友，够义气啊！", SJ + pkValue * 200000));
					LuaI.SetTempResult(1);
					return;
				else
					pChar:GetScript():ShowError(string.format("保释此犯人需要银两%d，你的银两不足无法保释。", SJ + pkValue * 200000));
				end
			end
		else
			pChar:GetScript():ShowError("本线天牢囚犯中查无此人");
		end
	else
		pChar:GetScript():ShowError("本线天牢囚犯中查无此人");
	end
	LuaI.SetTempResult(0);
end
--目标是否可以被PK
function TargetIsEnablePK(pChar)
	if  not pChar:GetQuests():TimeMarkOver(401,720) then
		LuaI.SetTempResult(0);
		return;
	end
	LuaI.SetTempResult(1);
end
--目标是否可以组队
function CheckJoinParty(pChar)
	local mapId = pChar:GetMap_id();
	if mapId == 252 then
		LuaI.SetTempResult(0);
		return;
	end
	--正在举行婚礼,不允许组队
	if pChar:IsExcuteMarriage() then
		LuaI.SetTempResult(0);
		return;
	end
	LuaI.SetTempResult(1);
end

--目标是否可以跳转地图
function CheckJumpMap(pChar)		
	if mapId == 60310 then
		if pChar:GetQuests():GetFlag(88) == 0 then
			pChar:GetScript():ShowError("请通过NPC出入蹴鞠场");
			LuaI.SetTempResult(0);
			return;
		end
	end
	--镇帮神器休息地图禁止跳转
	if mapId == 56534 and pChar:GetQuests():TimeMarkOver(801, 2) == false then
		pChar:GetScript():ShowError("你重伤未愈，多休息下吧");
		LuaI.SetTempResult(0);
		return;
	end
	--正在举行婚礼,不允许跳转地图
	if pChar:IsExcuteMarriage() then
		pChar:GetScript():ShowError("正在举行婚礼,禁止跳转");
		LuaI.SetTempResult(0);
		return;
	end	
	LuaI.SetTempResult(1);
end

--保护卡ID

function GetSafeguardCardId(pChar)
	--LuaI.SetTempResult(61010);--物品ID
end

--输入跟踪人物ID后的处理,主要是删除物品

function OnCharacterWantedTrace(pChar)
	--LuaI.SetTempResult(0);--物品删除失败
	if pChar:GetItems():RemoveItem(53027) then
		LuaI.SetTempResult(1);--物品删除成功
	else
		LuaI.SetTempResult(0);--物品删除失败
	end
end

function GetPartnerCultivationUpConsumeMoney(Type, cultivation)
	if Type == 0 then
		money = (cultivation + 1) * 1000 + 6000;
	else
		money = 100;
	end
	LuaI.SetTempResult(money);
	return money;
end

function GetPartnerCultivationUpRate(cultivation)   --BB提修

	local UpRate = 0;
	if cultivation == 0 then
		UpRate = 100;
	elseif cultivation == 1 then
		UpRate = 85;
	elseif cultivation == 2 then
		UpRate = 75;
	elseif cultivation == 3 then
		UpRate = 60;
	elseif cultivation == 4 then
		UpRate = 15;   --提修本来20
	elseif cultivation == 5 then
		UpRate = 30;
	elseif cultivation == 6 then
		UpRate = 25;   --提修本来30
	elseif cultivation == 7 then
		UpRate = 3;
	elseif cultivation == 8 then
		UpRate = 5;    --提修本来7
	elseif cultivation == 9 then
		UpRate = 1;
	elseif cultivation == 10 then
		UpRate = 0;
	end

	LuaI.SetTempResult(UpRate);
	return UpRate;
end

function CheckPartnerCultivationUpItem(item_id, cultivation)

	local Re = 0;
	if item_id == 63036 or item_id == 66025 then
		if cultivation >= 0 and cultivation <= 2 then
			Re = 0;
		else
			Re = 2;
		end
	elseif item_id == 63037 or item_id == 66029 then
		if cultivation >= 3 and cultivation <= 5 then
			Re = 0;
		else
			Re = 2;
		end
	elseif item_id == 63038 or item_id == 66030 then
		if cultivation >= 6 and cultivation <= 9 then
			Re = 0;
		else
			Re = 2;
		end
	else
		Re = 1;
	end
	LuaI.SetTempResult(Re);
	return Re;
end

function GetPartnerGrowLevel(grow, grow_d, grow_u)
	local grow_range = grow_u - grow_d + 1;
	local grow_level_4 = grow_d + math.floor(grow_range * 5 / 100);
    local grow_level_3 = grow_level_4 + math.floor(grow_range * 25 / 100);
    local grow_level_2 = grow_level_3 + math.floor(grow_range * 40 / 100);
    local grow_level_1 = grow_level_2 + math.floor(grow_range * 25 / 100);
	
	if grow_d == grow_u then
		LuaI.SetTempResult(0);
	    return 0;
	else
		if grow <= grow_level_4 then
			LuaI.SetTempResult(4);
	        return 4;
	    elseif grow > grow_level_4 and grow <= grow_level_3 then
			LuaI.SetTempResult(3);
	        return 3;
	    elseif grow > grow_level_3 and grow <= grow_level_2 then
			LuaI.SetTempResult(2);
	        return 2;
	    elseif grow > grow_level_2 and grow < grow_level_1 then
			LuaI.SetTempResult(1);
	        return 1;
	    elseif grow >= grow_level_1 then
			LuaI.SetTempResult(0);
	        return 0;
	    end
	end
	LuaI.SetTempResult(0);
	return 0;
end
--结婚仪式完成以后的处理
function OnMarriageFinish(pHusband,pWife)
end

--订婚结束后的处理
function OnCreateMarriageResult(pChar, result)
	if result then
		local relationSystem = pChar:GetRelationSystem()
		local Flag = pChar:GetQuests():GetFlag(70040)
		local day = LuaI.GetRealDay(relationSystem:GetMarriageTime())
		local party = pChar:GetParty()
		local member = party:GetMember(0)
		local member1 = party:GetMember(1)
		local freeSlot = member:GetItems():GetFreeSlot(0)
		local freeSlot1 = member1:GetItems():GetFreeSlot(0)
		
		if freeSlot < 2 and freeSlot1 < 1 then
			member:GetScript():ShowHint("请先清空包裹再来，至少需要留出2个位置。")
			member1:GetScript():ShowHint("请先清空包裹再来，至少需要留出1个位置。")
			return
		end
		if Flag == 1 then
			if pChar:GetMoney() >= 50000 then
				pChar:GetScript():ShowHint("恭喜，预订婚宴成功。")
				member:GetScript():ShowHint("获得请柬礼盒。")
				member:GetScript():ShowHint("获得婚礼客人名册。")
				member1:GetScript():ShowHint("获得请柬礼盒。")
				pChar:ChangeMoneyForScript(-50000,14003)
				pChar:GetQuests():SetFlag(70006,1)
				pChar:GetQuests():RemoveFlag(70040)
				member:GetItems():AddItem(67021, 1, day)
				member:GetItems():AddItem(67025, 1, day)
				member1:GetItems():AddItem(67021, 1, day)
				return
			else
				pChar:GetScript():ShowHint("金额不足，无法预订婚宴。")
				return
			end
		elseif Flag == 2 then
			if pChar:GetMoney() >= 100000 then
				pChar:GetScript():ShowHint("恭喜，预订婚宴成功。")
				member:GetScript():ShowHint("获得请柬礼盒。")
				member:GetScript():ShowHint("获得婚礼客人名册。")
				member1:GetScript():ShowHint("获得请柬礼盒。")
				pChar:ChangeMoneyForScript(-100000,14003)
				pChar:GetQuests():SetFlag(70007,1)
				pChar:GetQuests():RemoveFlag(70040)
				member:GetItems():AddItem(67022, 1, day)
				member:GetItems():AddItem(67025, 1, day)
				member1:GetItems():AddItem(67022, 1, day)
				return
			else
				pChar:GetScript():ShowHint("金额不足，无法预订婚宴。")
				return
			end
		elseif Flag == 3 then
			if pChar:GetMoney() >= 150000 then
				pChar:GetScript():ShowHint("恭喜，预订婚宴成功。")
				member:GetScript():ShowHint("获得请柬礼盒。")
				member:GetScript():ShowHint("获得婚礼客人名册。")
				member1:GetScript():ShowHint("获得请柬礼盒。")
				pChar:ChangeMoneyForScript(-150000,14003)
				pChar:GetQuests():SetFlag(70008,1)
				pChar:GetQuests():RemoveFlag(70040)
				member:GetItems():AddItem(67023, 1, day)
				member:GetItems():AddItem(67025, 1, day)
				member1:GetItems():AddItem(67023, 1, day)
				return
			else
				pChar:GetScript():ShowHint("金额不足，无法预订婚宴。")
				return
			end
		elseif Flag == 4 then
			if pChar:GetMoney() >= 200000 then
				pChar:GetScript():ShowHint("恭喜，预订婚宴成功。")
				member:GetScript():ShowHint("获得请柬礼盒。")
				member:GetScript():ShowHint("获得婚礼客人名册。")
				member1:GetScript():ShowHint("获得请柬礼盒。")
				pChar:ChangeMoneyForScript(-200000,14003)
				pChar:GetQuests():SetFlag(70009,1)
				pChar:GetQuests():RemoveFlag(70040)
				member:GetItems():AddItem(67024, 1, day)
				member:GetItems():AddItem(67025, 1, day)
				member1:GetItems():AddItem(67024, 1, day)
				return
			else
				pChar:GetScript():ShowHint("金额不足，无法预订婚宴。")
				return
			end
		end
	end
end 
--是否可以送花,这里主要检查每日送花次数
function CanGiveWeaponModelOrFlower(pChar, pTarget, flowerCount)
	local qtype = pChar:GetQuests():GetType(511)
	if qtype == nil then
		pChar:GetQuests():SetRoundInfo(511, 1, 10, 1)
		qtype = pChar:GetQuests():GetType(511)
	end
	local TotalRound = qtype:GetTotalRound()
	local sum = TotalRound + flowerCount
	if sum > 100 then
		LuaI.SetTempResult(0)
		pChar:GetScript():ShowHint("礼尚往来，无须太过频繁，一天送出\#G10\#W件够了")
		pChar:GetScript():ShowError("一天只能赠送100件礼品")
		return
	end
	LuaI.SetTempResult(1)
end

--送花结束,这里主要计算经验奖励
function OnGiveWeaponModelOrFlowerResult(pChar, pTarget, flowerCount)
	local qtype = pChar:GetQuests():GetType(511)
	if qtype == nil then
		pChar:GetQuests():SetRoundInfo(511, 1, 10, 1)
		qtype = pChar:GetQuests():GetType(511)
	end	
	local TotalRound = qtype:GetTotalRound()
	qtype:ChangeTotalRound(flowerCount)
	local lv = pChar:GetLevel()
	local p = math.random(0.95,1.05)
	local Exp = 1.1 * 6.6 * 9 * (4*lv + 10) * p * 10 --送花获得经验10倍
	local SMoney = 4 * (lv + 140) * 15.4 * p * 10 --送花银票经验10倍
	local r = math.random(1,100)
	local d = math.random(1,100)
	if r < 11 then
		Exp = (flowerCount + 9) * Exp 
	else
		Exp = flowerCount * Exp 
	end
	if d < 11 then
		SMoney = (flowerCount + 9) * SMoney
	else
		SMoney = flowerCount * SMoney
	end
	pChar:ChangeExpForScript(Exp,6)
	pChar:ChangeSMoneyForScript(SMoney,6)
	pChar:GetScript():ShowError(string.format("\#W赠送成功，获得经验值%d", Exp))
	pChar:GetScript():ShowError(string.format("\#W获得银票%d", SMoney))
	pChar:GetScript():ShowError(string.format("\#W双方好友度加%d", flowerCount*10))
	pChar:GetScript():ShowHint(string.format("赠送成功，获得经验值\#G%d\#W，银票\#G%d\#W，双方好友度加\#G%d\#W", Exp,SMoney,flowerCount*10))
	pTarget:GetScript():ShowError(string.format("\#W收到礼物，双方好友度加%d",flowerCount*10))
end
--LuaI.SetTempResult(0)不作处理，跟原来一样
--LuaI.SetTempResult(mob_id)得到ID为mob_id的宠物
function CatchMobIdToPetId(pBatChar,mob_id)		--捕捉幼宠
	--LuaI.SetTempResult(1)
end

--帮派维护
function UpateGuildMaintain(pGuild, success)
	if LuaI.GetLineID() ~= 1 then--只有1线才会生效，防止多次执行（假如1线2线是同一进程配置出来的，GetLineID()返回的是1线而不是2线）
		return
	end
	--镇帮神器信息清空
	if pGuild:GetArtifactType() ~= 0 then
		if LuaI.GetRealWDay() == 4 and LuaI.GetRealHour() >=12 and LuaI.GetRealHour() < 19 then
			pGuild:SetArtifactType(0)
		end
	end
	local cost = pGuild:GetMaintainCost()
	if pGuild:GetArtifactType() == 3 then
		cost = cost * 0.8
	end
	if pGuild:GetFund() < cost * 48 then
		local MaintainCost = 10000 * pGuild:GetManorScale()
		pGuild:ChangeFund(-MaintainCost)
		pGuild:SetStudy(0)
		pGuild:SendGuildMessage(string.format("帮派资金不足，扣除基本维护金%d。帮派欠缴维护费用，惹怒了包租婆，估计本帮派一、三、五要停水停气，二、四、六要间断电断网了……",MaintainCost))
		return
	end
	if success == true then
		local MaintainCost = pGuild:GetMaintainCost()
		if pGuild:GetArtifactType() == 3 then
			MaintainCost = MaintainCost * 0.8
		end
		pGuild:ChangeFund(-MaintainCost)
		local AddStudy		= 133 * 10 * (1.2^pGuild:GetCollege())/5  --10倍
		local AddMaterial	= pGuild:GetBoon() * 600 * 2 + 1000   --10倍+100变1000
		local AddMinerals	= pGuild:GetBoon() * 80 * 2 + 130   --10倍+13变130
		local AddSundries	= pGuild:GetBoon() * 80 * 2 + 130   --10倍+13变130
		local AddLeather	= pGuild:GetBoon() * 80 * 2 + 130   --10倍+13变130
		local AddGuard		= 266  * 10 * (1.2^pGuild:GetElement())   --10倍
		if pGuild:GetArtifactType() == 1 then
			AddMaterial = AddMaterial * 1.4
			AddMinerals = AddMinerals * 1.4
			AddSundries = AddSundries * 1.4
			AddLeather = AddLeather * 1.4
		end
		if pGuild:GetArtifactType() == 3 then
			pGuild:SendGuildMessage(string.format("帮派成功维护，受镇帮神器太阿影响，只扣除维护资金%d", MaintainCost))
		else
			pGuild:SendGuildMessage(string.format("帮派成功维护，扣除维护资金%d", pGuild:GetMaintainCost()))
		end
		
		local CollegeStudyCount = 0
		if pGuild:IsCollegeStudySwitch(1) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(2) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(4) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(8) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(16) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(32) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(64) then CollegeStudyCount = CollegeStudyCount + 1 end
		if pGuild:IsCollegeStudySwitch(128) then CollegeStudyCount = CollegeStudyCount + 1 end
		if CollegeStudyCount > 0 then
			local EachStudy = math.floor(AddStudy / CollegeStudyCount)
			local StudyLv = 0
			local StudyProcess = 0
			local StudyMax = 0
			if pGuild:IsCollegeStudySwitch(1) then
				StudyLv			= pGuild:GetHpLv() + 1
				StudyProcess	= pGuild:GetHpProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 49.3 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeManorHP(1)
					pGuild:ChangeManorHPProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("活血房研究经验增加%d，活血房等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeManorHPProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("活血房研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(2) then
				StudyLv			= pGuild:GetSpLv() + 1
				StudyProcess	= pGuild:GetSpProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 49.3 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeManorSP(1)
					pGuild:ChangeManorSPProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("调息房研究经验增加%d，调息房等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeManorSPProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("调息房研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(4) then
				StudyLv			= pGuild:GetCookLv() + 1
				StudyProcess	= pGuild:GetCookProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 24.65 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeCook(1)
					pGuild:ChangeCookProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("食堂研究经验增加%d，食堂等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeCookProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("食堂研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(8) then
				StudyLv			= pGuild:GetDrugLv() + 1
				StudyProcess	= pGuild:GetDrugProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 24.65 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeDrug(1)
					pGuild:ChangeDrugProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("药房研究经验增加%d，药房等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeDrugProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("药房研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(16) then
				StudyLv			= pGuild:GetWineLv() + 1
				StudyProcess	= pGuild:GetWineProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 24.65 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeWine(1)
					pGuild:ChangeWineProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("酒坊研究经验增加%d，酒坊等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeWineProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("酒坊研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(32) then
				StudyLv			= pGuild:GetHuntingLv() + 1
				StudyProcess	= pGuild:GetHuntingProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 14.08 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeHunting(1)
					pGuild:ChangeHuntingProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("狩猎场研究经验增加%d，狩猎场等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeHuntingProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("狩猎场研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(64) then
				StudyLv			= pGuild:GetMineLv() + 1
				StudyProcess	= pGuild:GetMineProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 14.08 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeMine(1)
					pGuild:ChangeMineProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("矿场研究经验增加%d，矿场等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeMineProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("矿场研究经验增加%d", EachStudy))
				end
			end
			if pGuild:IsCollegeStudySwitch(128) then
				StudyLv			= pGuild:GetGatherLv() + 1
				StudyProcess	= pGuild:GetGatherProcess()
				local sum = 0
				for i = 1, StudyLv do
					sum = sum + i
				end
				StudyMax		= 14.08 * sum / 5
				if StudyProcess + EachStudy > StudyMax then
					pGuild:ChangeGather(1)
					pGuild:ChangeGatherProcess(EachStudy - StudyMax)
					pGuild:SendGuildMessage(string.format("采集场研究经验增加%d，采集场等级上限提升至%d级",EachStudy, StudyLv))
				else
					pGuild:ChangeGatherProcess(EachStudy)
					pGuild:SendGuildMessage(string.format("采集场研究经验增加%d", EachStudy))
				end
			end
		end
		pGuild:SetStudy(AddStudy)
		
		pGuild:ChangeMaterial(AddMaterial - pGuild:GetMaterial())
		pGuild:ChangeMinerals(AddMinerals - pGuild:GetMinerals())
		pGuild:ChangeSundries(AddSundries - pGuild:GetSundries())
		pGuild:ChangeLeather(AddLeather - pGuild:GetLeather())
		if pGuild:GetArtifactType() == 1 then
			pGuild:SendGuildMessage("受镇帮神器龙渊影响，帮派资材、矿产、杂材、皮革获得额外40%补充")
		else
			pGuild:SendGuildMessage("帮派资材、矿产、筑材、皮革得到补充")
		end
		local guardLv = pGuild:GetGuard() + 1
		local guardExp = pGuild:GetGuardExp()
		local sum = 0
		for i=1, guardLv do
			sum = sum + i
		end
		local nextLevelExp = 24.65 * 16 * sum				
		if guardExp + AddGuard > nextLevelExp then
			pGuild:ChangeGuard(1, guardExp + AddGuard - nextLevelExp)
			pGuild:SendGuildMessage(string.format("帮派守卫获得经验%d，等级提升至%d级", AddGuard, guardLv))
		else
			pGuild:ChangeGuard(0, AddGuard)
			pGuild:SendGuildMessage(string.format("帮派守卫获得经验%d", AddGuard))
		end
	end
end

--获得维护必要资金
function GetManorMaintainCostNeed(MaintainCost)
	local Result = MaintainCost * 48;
	LuaI.SetTempResult(Result);
end
--获得正常维护费用
function GetManorMaintainCost(ScaleLv, CollegeLv, RoomLv, CoffersLv, ElementLv, BoonLv, TrainLv)
	local Scale		= 0
	local College	= 0
	local Room		= 0
	local Coffers	= 0
	local Element	= 0
	local Boon		= 0
	local Train		= 0
	
	Scale	= 10000 * ScaleLv	
	if CollegeLv < 9 then
		College	= 2633 * CollegeLv
	else
		College	= 21028 + (CollegeLv - 8) * (CollegeLv * 250 + 7250) + CollegeLv * (CollegeLv + 1) * 0.5
	end	
	if RoomLv < 9 then
		Room	= 2633 * RoomLv
	else
		Room	= 21028 + (RoomLv - 8) * (RoomLv * 250 + 7250) + RoomLv * (RoomLv + 1) * 0.5
	end	
	if CoffersLv < 9 then
		Coffers	= 2633 * CoffersLv
	else
		Coffers	= 21028 + (CoffersLv - 8) * (CoffersLv * 250 + 7250) + CoffersLv * (CoffersLv + 1) * 0.5
	end	
	if ElementLv < 9 then
		Element	= 2633 * ElementLv
	else
		Element	= 21028 + (ElementLv - 8) * (ElementLv * 250 + 7250) + ElementLv * (ElementLv + 1) * 0.5
	end	
	if BoonLv < 9 then
		Boon	= 2633 * BoonLv
	else
		Boon	= 21028 + (BoonLv - 8) * (BoonLv * 250 + 7250) + BoonLv * (BoonLv + 1) * 0.5
	end	
	Train	= 8000 * TrainLv
	
	local Result = Scale + College + Room + Coffers + Element + Boon + Train;
	LuaI.SetTempResult(Result);
end

--获得书院建设的消耗帮派资金A
function GetManorBuildCollegeCost(CollegeLv)
	local Result = 1000000 + (CollegeLv + 1) * 40000;
	LuaI.SetTempResult(Result);
end
--获得书院建设的所需建筑进度A
function GetManorBuildCollegeProcess(CollegeLv,pGuild)
	local A = 10
	if CollegeLv >= 8 and CollegeLv < 12 then
		A = 10 + 5 * (CollegeLv - 7)
	elseif CollegeLv >= 12 and CollegeLv < 16 then
		A = 10 + 10 * (CollegeLv - 11)
	elseif CollegeLv >= 16 then
		A = 10 + 20 * (CollegeLv - 15)
	end
	local Result = 10 + A * (CollegeLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得书院建设的所需建筑消耗繁荣度
function GetManorBuildCollegeProsper(CollegeLv,pGuild)
	local Result = 10 + (CollegeLv + 1) * 3;
	LuaI.SetTempResult(Result);
end

--获得厢房建设的消耗帮派资金A
function GetManorBuildRoomCost(RoomLv)
	local Result = 1000000 + (RoomLv + 1) * 20000;
	LuaI.SetTempResult(Result);
end
--获得厢房建设的所需建筑进度A
function GetManorBuildRoomProcess(RoomLv,pGuild)
	local A = 10
	if RoomLv >= 8 and RoomLv < 12 then
		A = 10 + 5 * (RoomLv - 7)
	elseif RoomLv >= 12 and RoomLv < 16 then
		A = 10 + 10 * (RoomLv - 11)
	elseif RoomLv >= 16 then
		A = 10 + 20 * (RoomLv - 15)
	end
	local Result = 10 + A * (RoomLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得厢房建设的所需建筑消耗繁荣度
function GetManorBuildRoomProsper(RoomLv,pGuild)
	local Result = 10 + (RoomLv + 1) * 3;
	LuaI.SetTempResult(Result);
end

--获得金库建设的消耗帮派资金A
function GetManorBuildCoffersCost(CoffersLv)
	local Result = 800000 + (CoffersLv + 1) * 20000;
	LuaI.SetTempResult(Result);
end
--获得金库建设的所需建筑进度A
function GetManorBuildCoffersProcess(CoffersLv,pGuild)
	local A = 10
	if CoffersLv >= 8 and CoffersLv < 12 then
		A = 10 + 5 * (CoffersLv - 7)
	elseif CoffersLv >= 12 and CoffersLv < 16 then
		A = 10 + 10 * (CoffersLv - 11)
	elseif CoffersLv >= 16 then
		A = 10 + 20 * (CoffersLv - 15)
	end
	local Result = 10 + A * (CoffersLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得金库建设的所需建筑消耗繁荣度
function GetManorBuildCoffersProsper(CoffersLv,pGuild)
	local Result = 10 + (CoffersLv + 1) * 3;
	LuaI.SetTempResult(Result);
end

--获得杂物房建设的消耗帮派资金A
function GetManorBuildElementCost(ElementLv)
	local Result = 800000 + (ElementLv + 1) * 20000;
	LuaI.SetTempResult(Result);
end
--获得杂物房建设的所需建筑进度A
function GetManorBuildElementProcess(ElementLv,pGuild)
	local A = 10
	if ElementLv >= 8 and ElementLv < 12 then
		A = 10 + 5 * (ElementLv - 7)
	elseif ElementLv >= 12 and ElementLv < 16 then
		A = 10 + 10 * (ElementLv - 11)
	elseif ElementLv >= 16 then
		A = 10 + 20 * (ElementLv - 15)
	end
	local Result = 10 + A * (ElementLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得杂物房建设的所需建筑消耗繁荣度
function GetManorBuildElementProsper(ElementLv,pGuild)
	local Result = 10 + (ElementLv + 1) * 3;
	LuaI.SetTempResult(Result);
end

--获得福利房建设的消耗帮派资金A
function GetManorBuildBoonCost(BoonLv)
	local Result = 1000000 + (BoonLv + 1) * 10000;
	LuaI.SetTempResult(Result);
end
--获得福利房建设的所需建筑进度A
function GetManorBuildBoonProcess(BoonLv,pGuild)
	local A = 10
	if BoonLv >= 8 and BoonLv < 12 then
		A = 10 + 5 * (BoonLv - 7)
	elseif BoonLv >= 12 and BoonLv < 16 then
		A = 10 + 10 * (BoonLv - 11)
	elseif BoonLv >= 16 then
		A = 10 + 20 * (BoonLv - 15)
	end
	local Result = 10 + A * (BoonLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得福利房建设的所需建筑消耗繁荣度
function GetManorBuildBoonProsper(BoonLv,pGuild)
	local Result = 10 + (BoonLv + 1) * 3;
	LuaI.SetTempResult(Result);
end

--获得修炼房建设的消耗帮派资金A
function GetManorBuildTrainCost(TrainLv)
	local Result = 2000000 + (TrainLv + 1) * 80000;
	LuaI.SetTempResult(Result);
end
--获得修炼房建设的所需建筑进度A
function GetManorBuildTrainProcess(TrainLv,pGuild)
	local A = 10
	if TrainLv >= 2 and TrainLv < 3 then
		A = 10
	elseif TrainLv >= 3 and TrainLv < 4 then
		A = 20
	elseif TrainLv >= 4 then
		A = 30
	end
	local Result = 10 + A * 5 * (4 * TrainLv + 1)/3
	LuaI.SetTempResult(Result);
end
--获得修炼房建设的所需建筑消耗繁荣度
function GetManorBuildTrainProsper(TrainLv,pGuild)
	local Result = 20 + (TrainLv + 1) * 8;
	LuaI.SetTempResult(Result);
end

--获得帮派规模建设的消耗帮派资金A
function GetManorBuildScaleCost(ScaleLv)
	local Result = 10000000 + (ScaleLv + 1) * 40000;
	LuaI.SetTempResult(Result);
end
--获得帮派规模建设的所需建筑进度A
function GetManorBuildScaleProcess(ScaleLv,pGuild)
	local A = 10
	if ScaleLv >= 2 and ScaleLv < 3 then
		A = 10
	elseif ScaleLv >= 3 and ScaleLv < 4 then
		A = 20
	elseif ScaleLv >= 4 then
		A = 30
	end
	local Result = 10 + A * 10 * (4 * ScaleLv + 1)/3
	LuaI.SetTempResult(Result);
end

--获得帮派规模建设的所需建筑消耗繁荣度
function GetManorBuildScaleProsper(ScaleLv,pGuild)
	local Result = 20 + (ScaleLv + 1) * 8;
	LuaI.SetTempResult(Result);
end
--[[
--获得书院研究的活血房研究所需进度
function GetManorCollegeHpProcess(HpLv)
	local level = HpLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 49.3 * sum
	LuaI.SetTempResult(Result);
end
--获得书院研究的活血房研究所需Exp
function GetManorCollegeHpExp(HpLv)
	local Result = 100 + HpLv * 12;
	LuaI.SetTempResult(Result);
end

--获得书院研究的调息房研究所需进度
function GetManorCollegeSpProcess(SpLv)
	local level = SpLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 49.3 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的食堂研究所需进度
function GetManorCollegeCookProcess(CookLv)
	local level = CookLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 24.65 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的药房研究所需进度
function GetManorCollegeDrugProcess(DrugLv)
	local level = DrugLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 24.65 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的酒坊研究所需进度
function GetManorCollegeWineProcess(WineLv)
	local level = WineLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 24.65 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的狩猎场研究所需进度
function GetManorCollegeHuntingProcess(HuntingLv)
	local level = HuntingLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 14.08 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的矿场研究所需进度
function GetManorCollegeMineProcess(MineLv)
	local level = MineLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 14.08 * sum
	LuaI.SetTempResult(Result);
end

--获得书院研究的采集场研究所需进度
function GetManorCollegeGatherProcess(GatherLv)
	local level = GatherLv + 1
	local sum = 0
	for i=1, level do
		sum = sum + i
	end
	local Result = 14.08 * sum
	LuaI.SetTempResult(Result);
end
]]
--获得杂物房风相技能威力建设的所需建筑进度A
function GetManorElementWindPowerProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);	
end
--获得杂物房风相技能消耗建设的所需建筑进度A
function GetManorElementWindCostProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end

--获得杂物房土相技能威力建设的所需建筑进度A
function GetManorElementEarthPowerProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end
--获得杂物房土相技能消耗建设的所需建筑进度
function GetManorElementEarthCostProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end

--获得杂物房水相技能威力建设的所需建筑进度A
function GetManorElementWaterPowerProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end
--获得杂物房水相技能消耗建设的所需建筑进度A
function GetManorElementWaterCostProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end

--获得杂物房火相技能威力建设的所需建筑进度A
function GetManorElementFirePowerProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end
--获得杂物房火相技能消耗建设的所需建筑进度A
function GetManorElementFireCostProcess(Lv)
	local A = 10
	if Lv >= 8 and Lv < 12 then
		A = 10 + 5 * (Lv - 7)
	elseif Lv >= 12 and Lv < 16 then
		A = 10 + 10 * (Lv - 11)
	elseif Lv >= 16 then
		A = 10 + 20 * (Lv - 15)
	end
	local Result = 10 + A * (Lv + 1)
	LuaI.SetTempResult(Result);
end

function GetManorGatheringSkillCostDonate(Lv)
	local Result = (Lv + 1) * 4 / 3;
	LuaI.SetTempResult(Result);
end

--升级普通生活技能时,消耗玩家的帮贡
function GetManorNormalSkillCostDonate(Lv)
	local Result = (Lv + 1) * 3;
	LuaI.SetTempResult(Result);
end
--升级普通生活技能时,所需历史帮贡
function GetManorNormalSkillNeedHistoryDonate(Lv)
	local Result = 32 * Lv + 2;
	LuaI.SetTempResult(Result);
end
--升级普通生活技能时,消耗帮派资材
function GetManorNormalSkillCostMaterial(Lv)
	local Result = Lv + 1;
	LuaI.SetTempResult(Result);
end

--升级战斗生活技能时,消耗玩家的帮贡
function GetManorBattleSkillCostDonate(Lv)
    local Result = (Lv + 1) * 1;
    if Lv > 15 then
	Result = (Lv + 1) * 3;
	end
	LuaI.SetTempResult(Result);
end
--升级战斗生活技能时,所需历史帮贡
function GetManorBattleSkillNeedHistoryDonate(Lv)
	local Result = 43 * Lv + 3;
	LuaI.SetTempResult(Result);
end
--升级战斗生活技能时,消耗帮派资材
function GetManorBattleSkillCostMaterial(Lv)
	local Result = Lv + 1;
	LuaI.SetTempResult(Result);
end

function SingleWarStart()
	LuaI.SingleWarStart();
end

function SingleWarEndContinue()
	LuaI.SingleWarEndContinue();
end

function SingleWarEndAll()
	LuaI.SingleWarEndAll();
end

function ReduceBusinessCash()
	LuaI.ReduceBusinessCash();
end

function SingleWarPrepareTips1()
	LuaI.SingleWarPrepareTips(1);
end

function SingleWarPrepareTips1()
	LuaI.SingleWarPrepareTips(1);
end

function SingleWarPrepareTips2()
	LuaI.SingleWarPrepareTips(2);
end

function SingleWarPrepareTips3()
	LuaI.SingleWarPrepareTips(3);
end

function SingleWarPrepareTips4()
	LuaI.SingleWarPrepareTips(4);
end

function SingleWarPrepareTips5()
	LuaI.SingleWarPrepareTips(5);
end

function SingleWarPrepareTips6()
	LuaI.SingleWarPrepareTips(6);
end

function SingleWarPrepareTips7()
	LuaI.SingleWarPrepareTips(7);
end

function SingleWarPrepareTips8()
	LuaI.SingleWarPrepareTips(8);
end

function SingleWarPrepareTips9()
	LuaI.SingleWarPrepareTips(9);
end

function SingleWarPrepareTips10()
	LuaI.SingleWarPrepareTips(10);
end

function SingleWarPrepareTips11()
	LuaI.SingleWarPrepareTips(11);
end

function SingleWarPrepareTips12()
	LuaI.SingleWarPrepareTips(12);
end

function AddSingleWarTitle(pChar)
	RemoveSingleWarTitle(pChar)
	local group = pChar:GetSingleWarGroup()
	if group == 1 then
		pChar:AddTitle(705)
	elseif group == 2 then
		pChar:AddTitle(706)
	elseif group == 3 then
		pChar:AddTitle(707)
	elseif group == 4 then
		pChar:AddTitle(708)
	end
end

function RemoveSingleWarTitle(pChar)
	pChar:RemoveTitle(705)
	pChar:RemoveTitle(706)
	pChar:RemoveTitle(707)
	pChar:RemoveTitle(708)
end

function CalSingleWarReward(pChar, result, enemyCount, turnCount, pTarget)
	local Exp = 0;
	local SingleWarPoint = 0;
	local PartyLevel = 50;
	if result == 0 then --win
		if pParty ~= nil then
			PartyLevel = pParty:GetAvgLevel();
		else
			PartyLevel = pChar:GetLevel();
		end
		Exp =  (4*PartyLevel+10)*6.6*70*0.50 * 100;--论剑获胜经验100倍
		SingleWarPoint = 30;
		pChar:GetScript():ShowError(string.format("\#W论剑获胜，获得经验值%d，获得论剑积分%d",Exp,SingleWarPoint));
	elseif result == 1 then --lose
	elseif result == 2 then --draw
	elseif result == 4 then --battle win
		--定义本方队伍人数，平均等级，胜利平均数
		local pParty = pChar:GetParty();
		local PartyCount = 1;
		local WinCount = 0;
		local enemynum = 1;
		local num = 1
		if pParty ~= nil then			
			PartyCount = pParty:GetCount();
			PartyLevel = pParty:GetAvgLevel();
			for i = 0, pParty:GetCount() - 1 do
				num = pParty:GetMember(i):GetQuests():GetFlag(615);
				WinCount = num + WinCount;
			end
		else
			PartyCount = 1;
			PartyLevel = pChar:GetLevel();
			WinCount = pChar:GetQuests():GetFlag(615);
		end
		--定义对方队伍平均等级，胜利平均数
		local enemyLevel = 50;
		local enemyWinCount = 0;
		if pTarget ~= nil then
			local enemyParty = pTarget:GetParty();
			if enemyParty ~= nil then
				enemyLevel = enemyParty:GetAvgLevel();
				for i = 0, enemyParty:GetCount() - 1 do
					enemynum = enemyParty:GetMember(i):GetQuests():GetFlag(615);
					enemyWinCount = enemynum + enemyWinCount;
				end
			else
				enemyLevel = pTarget:GetLevel();
				enemyWinCount = pTarget:GetQuests():GetFlag(615);
			end		
		end
		SingleWarPoint =  (turnCount+30)/(turnCount+20) * (enemyCount/PartyCount) * (PartyCount+enemyCount) * (enemyLevel/PartyLevel) * ((enemynum-num)/5+1);
		pChar:GetScript():ShowError(string.format("\#W战斗胜利，获得论剑积分%d",SingleWarPoint));
		pChar:GetQuests():SetFlag(615, pChar:GetQuests():GetFlag(615)+1)--获胜次数+
		if math.random(1,20) == 1 and pChar:GetItems():GetFreeSlot(0) > 0 then
		    local ItemID = RandTable({80091,92001,60233,15006,15007,15008,15009})
			local ItemNum = 1
			pChar:GetScript():Rumor(string.format("真是鸿运当头，\#W%s\#O在华山论剑中，获得\#W%s\#O的额外奖励。",pChar:GetName(),GetItemName(ItemID)));
			if ItemID > 15005 and ItemID < 15010 then
			   ItemNum = math.random(3,5)
			end
			pChar:GetItems():AddItem(ItemID,ItemNum)
		end
	elseif result == 5 then --battle lose
		if pParty ~= nil then			
			PartyLevel = pParty:GetAvgLevel();
		else
			PartyLevel = pChar:GetLevel();
		end
		Exp = (4*PartyLevel+10)*6.6*70*0.2 * 100;--论剑获胜经验10倍
		pChar:GetScript():ShowError(string.format("\#W积极参与论剑，获得经验值%d",Exp));
		-- if math.random(1,20) == 1 and pChar:GetItems():GetFreeSlot(0) > 0 then
		    -- local ItemID = RandTable({80091,92001,60233,15006,15007,15008,15009})
			-- local ItemNum = 1
			-- pChar:GetScript():Rumor(string.format("真是鸿运当头，\#W%s\#O在华山论剑中，获得\#W%s\#O的额外奖励。",pChar:GetName(),GetItemName(ItemID)));
			-- if ItemID > 15005 and ItemID < 15010 then
			   -- ItemNum = math.random(3,5)
			-- end
			-- pChar:GetItems():AddItem(ItemID,ItemNum)
		-- end
	else 	--leave the battle
	end
	pChar:ChangeExpForScript(Exp);
	pChar:ChangeSingleWarScore(SingleWarPoint);
end

function DonateMoney(pChar, money, maxFund)
	if pChar:HasGuild() then
		local reallyMoney = money
		local minMoney = 0
		local charMoney = pChar:GetMoney()
		local TotalRound560 = 0;   --本来是等于0
		local type560 = pChar:GetQuests():GetType(560);	
		if type560 ~= nil then
			if type560:GetLimitType() == 1 then  --本来是==1
				pChar:GetQuests():SetRoundInfo(560, 1, 1, 2)
			end
			TotalRound560 = type560:GetTotalRound();
		end
		if TotalRound560 > 500 then
			pChar:GetScript():ShowError("感谢您为帮派发展积极捐献，但一周内只能捐献五百次，要想继续捐献请下周再来。");
			LuaI.SetTempResult(0);
			return
		end
		local pGuild = pChar:GetGuild()
		if pGuild ~= nil then
			minMoney = 10000 * pGuild:GetManorScale()
			if reallyMoney > charMoney then
				reallyMoney = charMoney
			end
			if reallyMoney > 1000000 then
				reallyMoney = 1000000
			end
			if pGuild:GetFund() >= maxFund * 0.8 then
				pChar:GetScript():ShowError(string.format("当前帮派资金高于%d，无法捐献，过段时间再捐献吧，不用这么给力。",maxFund * 0.8));
				LuaI.SetTempResult(0);
			elseif reallyMoney < minMoney then--低于帮派规模 * 1W
				pChar:GetScript():ShowError(string.format("对不起，%d级帮派捐款不得低于%d，捐款不要这么小气嘛，请慷慨解囊。", pGuild:GetManorScale(), minMoney));
				LuaI.SetTempResult(0);
			elseif reallyMoney < 50000 then--低于5W
				pGuild:SendGuildMessage(string.format("正所谓帮派是我家，帮派建设靠大家，\#W%s\#G为了帮派更快更好的发展而慷慨解囊，捐献了\#P%d\#G两银子，一派大侠的风范！", pChar:GetName(), reallyMoney))
				LuaI.SetTempResult(reallyMoney);
				pChar:GetQuests():SetRoundInfo(560, 1, 1, 2);
				type560 = pChar:GetQuests():GetType(560);
				type560:ChangeTotalRound(1)	
			elseif reallyMoney >= 250000 then--高于25W
				pGuild:SendGuildMessage(string.format("正当大家为帮里资金紧缺而头疼的时候，突觉眼前一闪，一个沉甸甸的包袱落在大家当前，里面竟然有银子\#P%d\#G两，而且附有字条一张，上面写着“帮派兴衰，我\#W%s\#G责无旁贷！”", reallyMoney, pChar:GetName()))
				LuaI.SetTempResult(reallyMoney);
				pChar:GetQuests():SetRoundInfo(560, 1, 1, 2);
				type560 = pChar:GetQuests():GetType(560);
				type560:ChangeTotalRound(1)	
			else--高于5W
				pGuild:SendGuildMessage(string.format("\#W%s\#G忠肝义胆，侠情万丈，一听帮派资金周转有困难，立刻豪爽的拿出\#P%d\#G两银子交给大家，说道：“这点小钱就给各位拿去买酒喝！”", pChar:GetName(), reallyMoney))
				LuaI.SetTempResult(reallyMoney);
				pChar:GetQuests():SetRoundInfo(560, 1, 1, 2);
				type560 = pChar:GetQuests():GetType(560);
				type560:ChangeTotalRound(1)	
			end
		else
			pChar:GetScript():ShowError("您已非本帮成员，无法进行此项操作");
			LuaI.SetTempResult(0);
		end
	else
		pChar:GetScript():ShowError("您已非本帮成员，无法进行此项操作");
		LuaI.SetTempResult(0);
	end
end

function DeleteWeaponsRank()
	LuaI.DeleteWeaponsRank();
end

function GetOldWeaponsRank()
	LuaI.GetOldWeaponsRank();
end

function CheckManorBuildScale(pChar)
	LuaI.SetTempResult(0);
	if pChar ~= nil and pChar:HasGuild() then
		local pGuild = pChar:GetGuild()
		if pGuild ~= nil then
			local ScaleLv		= pGuild:GetManorScale()	--帮派等级
			local CollegeLv		= pGuild:GetCollege()		--书院等级
			local RoomLv		= pGuild:GetRoom()			--厢房等级
			local BoonLv		= pGuild:GetBoon()			--福利房等级
			local CoffersLv		= pGuild:GetCoffers()		--金库等级
			local ElementLv		= pGuild:GetElement()		--杂物房等级
			local Count			= 0
			if ScaleLv >= 5 then
			pChar:GetScript():ShowError("当前帮派规模已达上限，无法继续提升");
				return
			end
			if CollegeLv >= (ScaleLv * 4) then
				Count = Count + 1
			end
			if RoomLv >= (ScaleLv * 3) then
				Count = Count + 1
			end
			if BoonLv >= (ScaleLv * 4) then
				Count = Count + 1
			end
			if CoffersLv >= (ScaleLv * 4) then
				Count = Count + 1
			end
			if ElementLv >= (ScaleLv * 4) then
				Count = Count + 1
			end
			
			if Count < 2 then
				pChar:GetScript():ShowHint(string.format("\#W至少\#G两\#W种建筑数量达到当前上限（书院、福利房、金库、杂物房当前上限\#G%d\#W级，厢房当前上限\#G%d\#W级）才能提升规模", ScaleLv * 4, ScaleLv * 3));
				pChar:GetScript():ShowError(string.format("\#W至少两种建筑数量达到当前上限（书院、福利房、金库、杂物房当前上限%d级，厢房当前上限%d级）才能提升规模", ScaleLv * 4, ScaleLv * 3));
			else
				LuaI.SetTempResult(1);
			end		
		end
	end
end

function startDisputeGuildRelic()
	LuaI.startDisputeGuildRelic()
end

function disputeGuildRelicOver()
	LuaI.disputeGuildRelicOver()
end

function OnCharacterGuildRelicPKDeadPenalty(pChar)
	pChar:GetQuests():SetTimeMark(801)
	pChar:JumpMap(56534, 26, 74)
	local item = {79035,79036,79037,79038,79053,79054}
	for m = 1, 1000 do
		local itemid = RandTable(item)
		if pChar:GetItems():HasItem(itemid) then
			pChar:GetScript():ShowError(string.format("\#W你遗失了%s",GetItemName(itemid)))
			pChar:GetItems():RemoveItem(itemid, 1)
			return
		end
	end
end

function SendSystemLetterFromWeekJournal(pChar)
		pChar:ResetSystemLetterData()--不能去掉
		pChar:SetSystemLetterTimeLimit(1)--单位为小时（默认30天，即30*24小时）
		pChar:SetSystemLetterSender("活动日历系统")--寄信人（不能为空）
		pChar:SetSystemLetterTitle("活动日历提醒")--标题（不能为空）
end

function OnBuyItemInChargeShop(pChar, price)
	LuaI.SetTempResult(0);
	if pChar ~= nil and pChar:GetQuests() ~= nil then
		local oldActive = pChar:GetQuests():GetFlag(821)
		local addActive = math.floor(price/10) + oldActive
		if addActive > 1500 then
			addActive = 1500
		end
		LuaI.SetTempResult(addActive - oldActive);
		pChar:GetQuests():SetFlag(821,addActive)
	end
end


function OnInstanceInit(pInstance)
	local InstId	= pInstance:GetInstId()
	if InstId == 16 then
		local RandTypeA = math.random(1,5)
		local RandTypeB = math.random(1,3)
		local RandTypeC = math.random(1,2)
	
		pInstance:SetInstanceFlag(990,RandTypeC)  -- 获取进入副本时的随机分组数
		pInstance:SetInstanceFlag(991,RandTypeB)  -- 获取分组中的成员随机号
		pInstance:SetInstanceFlag(907,RandTypeA)  -- KeySort钥匙的组合
	elseif InstId == 18 then
		local RandType = math.random(1,4)
		
		pInstance:SetInstanceFlag(13,RandType)
	end
end